<!DOCTYPE html>
<html lang="uk">
<head>
  <meta name="robots" content="noindex, nofollow">
  <meta charset="utf-8" />
  <title>–ö–∞—Ä—Ç–∞ –¢–µ—Ä–∏—Ç–æ—Ä—ñ–π "–Ü–ª–ª—ñ–Ω—Ü—ñ"</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    /* –∫–Ω–æ–ø–∫–∏ */
    .btn { position: absolute; left: 10px; z-index: 1000; padding: 6px 12px; background: white; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    .locate-btn { top: 10px; }
    .layer-toggle { top: 50px; }
    .login-btn, .logout-btn { top: 46px; }
    .territories-btn { top: 200px; }
    /* –ø–∞–Ω–µ–ª—å —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ */
    .controls {
      position: absolute; top: 90px; left: 10px; z-index: 1000;
      background: rgba(255,255,255,0.95); padding: 10px; border: 1px solid #e2e8f0; border-radius: 10px;
      box-shadow: 0 6px 18px rgba(15,23,42,0.06); font-size: 14px; max-width: 320px;
    }
    .controls label { display:flex; align-items:center; gap:8px; margin:4px 0; cursor:pointer; }
    .subgroup { margin-left: 18px; }
    #loader { position: absolute; top: 10px; left: 240px; z-index: 1000; padding: 8px; background: white; border: 1px solid #e2e8f0; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    /* –ø—Ä–æ–≥—Ä–µ—Å */
    #progress-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.45); display:none; z-index:2000; justify-content:center; align-items:center; }
    #progress-container { background: white; padding:18px; border-radius:8px; text-align:center; width: 280px; max-width:90%; }
    #progress-bar { width:100%; height:12px; background:#f1f5f9; border-radius:999px; overflow:hidden; }
    #progress-fill { height:100%; background:#22c55e; width:0; transition: width 0.25s ease; }
    @media (max-width:640px) {
      .controls { left: 10px; top: 76px; width: 90%; }
      #loader { left: 140px; }
    }
  </style>
</head>
<body>
  <div id="progress-overlay" class="flex">
    <div id="progress-container">
      <h2 class="text-lg font-semibold mb-2">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–µ—Ä–∏—Ç–æ—Ä—ñ–π...</h2>
      <div id="progress-bar"><div id="progress-fill"></div></div>
      <p id="progress-text" class="mt-2 text-sm">0%</p>
    </div>
  </div>

  <button onclick="findLocation()" class="locate-btn btn">üìç –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ</button>
  <div id="auth-buttons">
    <a href="enter.html"><button class="login-btn btn" style="display:none">üîê –£–≤—ñ–π—Ç–∏</button></a>
    <button class="logout-btn btn" style="display:none">üö™ –í–∏–π—Ç–∏</button>
    <a href="territories.html"><button class="territories-btn btn" style="display:none">üèû –¢–µ—Ä–∏—Ç–æ—Ä—ñ—ó</button></a>
  </div>

  <div id="loader"></div>

  <div class="controls" id="controls-panel" aria-hidden="false">
    <label><input type="checkbox" id="toggleAll" checked> <span id="toggleAllLabel">–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ</span> <span id="total-count" class="text-xs text-gray-500 ml-2">(0)</span></label>
    <div id="taken-control" style="display:none">
      <label><input type="checkbox" id="showTaken"> –ù–∞ —Ä—É–∫–∞—Ö <span id="taken-count" class="text-xs text-gray-500 ml-2">(0)</span></label>
      <div class="subgroup">
        <label><input type="checkbox" id="showTakenPrivate"> –ü—Ä–∏–≤–∞—Ç–Ω–∞ <span id="taken-private-count" class="text-xs text-gray-500 ml-2">(0)</span></label>
        <label><input type="checkbox" id="showTakenMultistory"> –ü–æ–≤–µ—Ä—Ö—ñ–≤–∫–∏ <span id="taken-multistory-count" class="text-xs text-gray-500 ml-2">(0)</span></label>
        <label><input type="checkbox" id="showTakenBusiness"> –î—ñ–ª–æ–≤–∞ <span id="taken-business-count" class="text-xs text-gray-500 ml-2">(0)</span></label>
      </div>
    </div>
    <div id="free-control" style="display:none; margin-top:6px;">
      <label><input type="checkbox" id="showFree"> –í—ñ–ª—å–Ω–æ <span id="free-count" class="text-xs text-gray-500 ml-2">(0)</span></label>
      <div class="subgroup">
        <label><input type="checkbox" id="showFreePrivate"> –ü—Ä–∏–≤–∞—Ç–Ω–∞ <span id="free-private-count" class="text-xs text-gray-500 ml-2">(0)</span></label>
        <label><input type="checkbox" id="showFreeMultistory"> –ü–æ–≤–µ—Ä—Ö—ñ–≤–∫–∏ <span id="free-multistory-count" class="text-xs text-gray-500 ml-2">(0)</span></label>
        <label><input type="checkbox" id="showFreeBusiness"> –î—ñ–ª–æ–≤–∞ <span id="free-business-count" class="text-xs text-gray-500 ml-2">(0)</span></label>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>

  <script type="module">
    // Firebase imports (–∑–∞–ª–∏—à–∏–≤ —è–∫ –≤ –æ—Ä–∏–≥—ñ–Ω–∞–ª—ñ)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, getDocs, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDracSUSYz_QrmmDj_HcBfQpJlJ3FjPHpU",
      authDomain: "map-illintsi.firebaseapp.com",
      projectId: "map-illintsi",
      storageBucket: "map-illintsi.appspot.com",
      messagingSenderId: "62267872375",
      appId: "1:62267872375:web:10945d2d63b93bccc5e272"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;

    // DOM –∫–µ—à
    const el = id => document.getElementById(id);
    const loginBtn = document.querySelector('.login-btn');
    const logoutBtn = document.querySelector('.logout-btn');
    const territoriesBtn = document.querySelector('.territories-btn');
    const takenControl = el('taken-control');
    const freeControl = el('free-control');
    const loaderEl = el('loader');

    // –ö–∞—Ä—Ç–∞
    const map = L.map('map', { zoomControl: false }).setView([49.1029, 29.2074], 13);
    const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3'], attribution: '¬© Google Maps' }).addTo(map);
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '¬© Esri', maxZoom: 20 });

    // –∫–æ–ª—å–æ—Ä–æ–≤–∞ –ø–∞–ª—ñ—Ç—Ä–∞ (—Ü–∏–∫–ª—ñ—á–Ω–æ)
    const palette = [
      { color: 'blue', fillColor: '#add8e6' },
      { color: 'green', fillColor: '#90ee90' },
      { color: 'Yellow', fillColor: '#ffffe0' },
      { color: 'Orange', fillColor: '#ffdab9' },
      { color: 'Pink', fillColor: '#ffb6c1' },
      { color: 'Brown', fillColor: '#d2b48c' },
      { color: 'Purple', fillColor: '#e6e6fa' },
      { color: 'teal', fillColor: '#008080' },
      { color: 'Cyan', fillColor: '#e0ffff' },
      { color: 'Magenta', fillColor: '#ff80ff' },
      { color: 'red', fillColor: '#b6fcb6' }
    ];

    // –°—Ç—Ä—É–∫—Ç—É—Ä–∏ –¥–∞–Ω–∏—Ö
    let districts = [];                      // –Ω–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è –∑ all_districts.json
    const districtMap = {};                  // id -> district object (—à–≤–∏–¥–∫–∏–π –¥–æ—Å—Ç—É–ø)
    const districtCenters = [];
    const districtGeometries = [];
    const overlayMaps = {};
    const territoryStatuses = {};
    const territoryTypes = {};
    let layersControl = null;
    const loadedLayers = [];

    // URL target –ø–∞—Ä–∞–º–µ—Ç—Ä
    const urlParams = new URLSearchParams(window.location.search);
    let rawTarget = urlParams.get("territory");
    let targetId = null;
    if (rawTarget) targetId = rawTarget.startsWith('district') ? rawTarget : `district${rawTarget}`;

    // –ø—Ä–æ–≥—Ä–µ—Å / –ª–æ–∞–¥–µ—Ä
    function showLoadingText(txt){ loaderEl.innerText = txt || ''; }
    function updateProgress(p){
      const progressOverlay = el('progress-overlay');
      const fill = el('progress-fill');
      const text = el('progress-text');
      if (p < 100) { progressOverlay.style.display = 'flex'; fill.style.width = `${p}%`; text.innerText = `${Math.round(p)}%`; }
      else { progressOverlay.style.display = 'none'; fill.style.width = `100%`; text.innerText = '100%'; }
    }

    // ************ AUTH ************
    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (user) {
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        territoriesBtn.style.display = 'inline-block';
        takenControl.style.display = 'block';
        freeControl.style.display = 'block';
        // –æ–Ω–æ–≤–∏–º–æ –ª–∏—à–µ —è–∫—â–æ –º–∞—î–º–æ –¥–∞–Ω—ñ –ø—Ä–æ —Ä–∞–π–æ–Ω–∏
        if (districts.length) updateTerritoryStatuses();
      } else {
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        territoriesBtn.style.display = 'none';
        takenControl.style.display = 'block';
        freeControl.style.display = 'block';
        // —Å–∫–∏–¥–∞—î–º–æ —Å—Ç–∞—Ç—É—Å–∏ –ª–æ–∫–∞–ª—å–Ω–æ (–±–µ–∑ –≤–∏–∫–ª–∏–∫—ñ–≤ –¥–æ —Å–µ—Ä–≤–µ—Ä–∞)
        Object.keys(territoryStatuses).forEach(id => territoryStatuses[id] = "–≤—ñ–ª—å–Ω–æ");
        updateTerritoriesDisplay();
      }
    });
    logoutBtn?.addEventListener("click", async () => { await signOut(auth); layersControl = null; location.reload(); });

    // ************ –ü–æ–ø–∞–ø —Å—Ç–∞—Ç—É—Å—É (–∑–∞–ª–∏—à–∏–≤ –ª–æ–≥—ñ–∫—É) ************
    async function getTerritoryStatusPopup(number, name){
      try {
        const q = query(collection(db, `territories/${number}/history`), orderBy("timestamp","desc"));
        const snap = await getDocs(q);
        let popup = `<b>${name}</b><br>`;
        if (snap.empty) {
          popup += `<b>–°—Ç–∞—Ç—É—Å:</b> –≤—ñ–ª—å–Ω–æ`;
        } else {
          const latest = snap.docs[0].data();
          const status = latest.status === "–Ω–∞ —Ä—É–∫–∞—Ö" ? "–Ω–∞ —Ä—É–∫–∞—Ö" : "–≤—ñ–ª—å–Ω–æ";
          popup += `<b>–°—Ç–∞—Ç—É—Å:</b> ${status}`;
          if (currentUser && status === "–Ω–∞ —Ä—É–∫–∞—Ö") {
            popup += `<br><b>–ü–Ü–ë:</b> ${latest.pib || "–Ω–µ–≤—ñ–¥–æ–º–æ"}`;
            popup += `<br><b>–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è:</b> ${latest.dateGet ? new Date(latest.dateGet).toLocaleDateString("uk-UA") : "–Ω–µ–≤—ñ–¥–æ–º–æ"}`;
          }
        }
        const territoryDoc = await getDoc(doc(db, `territories/${number}`));
        const territoryType = territoryDoc.exists() ? territoryDoc.data().type || "–Ω–µ–≤—ñ–¥–æ–º–æ" : "–Ω–µ–≤—ñ–¥–æ–º–æ";
        popup += `<br><b>–¢–∏–ø:</b> ${territoryType}`;
        popup += `<br><button onclick="shareTerritory('${number}')" style="background-color: green; color: white;">üîó –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è</button>`;
        if (currentUser) popup += `<br><a href="territory-detail.html?number=${number}"><button style="background-color: orange; color: white;">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button></a>`;
        return popup;
      } catch(err) {
        console.warn('getTerritoryStatusPopup error', err);
        return `<b>${name}</b><br><b>–°—Ç–∞—Ç—É—Å:</b> –Ω–µ–≤—ñ–¥–æ–º–∏–π<br><b>–¢–∏–ø:</b> –Ω–µ–≤—ñ–¥–æ–º–∏–π`;
      }
    }

    // ************ –°–ª—É—Ö–∞—á—ñ onSnapshot –¥–ª—è —Å—Ç–∞—Ç—É—Å—ñ–≤ (–∑–∞–ª–∏—à–∏–≤ –ª–æ–≥—ñ–∫—É, –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ) ************
    async function updateTerritoryStatuses(){
      if (!districts.length) return; // —á–µ–∫–∞—î–º–æ –Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è geojson
      // –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ä–∞–π–æ–Ω—É –ø—ñ–¥–ø–∏—Å—É—î–º–æ—Å—å –Ω–∞ history (—è–∫ –±—É–ª–æ)
      for (const d of districts) {
        try {
          const idNum = d.id.replace('district','');
          const q = query(collection(db, `territories/${idNum}/history`), orderBy("timestamp","desc"));
          // –æ–¥—Ä–∞–∑—É –∑—á–∏—Ç—É—î–º–æ —Ç–∏–ø —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—ó (—è–∫ —Ä–∞–Ω—ñ—à–µ)
          try {
            const territoryDoc = await getDoc(doc(db, `territories/${idNum}`));
            territoryTypes[d.id] = territoryDoc.exists() ? territoryDoc.data().type || "–Ω–µ–≤—ñ–¥–æ–º–æ" : "–Ω–µ–≤—ñ–¥–æ–º–æ";
          } catch(e){ territoryTypes[d.id] = "–Ω–µ–≤—ñ–¥–æ–º–æ"; }
          onSnapshot(q, snap => {
            if (!snap || snap.empty) territoryStatuses[d.id] = "–≤—ñ–ª—å–Ω–æ";
            else {
              const latest = snap.docs[0].data();
              territoryStatuses[d.id] = latest.status === "–Ω–∞ —Ä—É–∫–∞—Ö" ? "–Ω–∞ —Ä—É–∫–∞—Ö" : "–≤—ñ–ª—å–Ω–æ";
            }
            updateTerritoriesDisplay();
          }, err => {
            console.warn(`–ü–æ–º–∏–ª–∫–∞ onSnapshot –¥–ª—è ${d.id}:`, err);
            territoryStatuses[d.id] = "–≤—ñ–ª—å–Ω–æ";
            updateTerritoriesDisplay();
          });
        } catch(e) {
          console.warn('updateTerritoryStatuses catch', e);
          territoryTypes[d.id] = "–Ω–µ–≤—ñ–¥–æ–º–æ";
        }
      }
    }

    // ************ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è all_districts.json —Ç–∞ –ø–æ–±—É–¥–æ–≤–∞ —à–∞—Ä—ñ–≤ (–æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ) ************
    (async () => {
      showLoadingText('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–µ—Ä–∏—Ç–æ—Ä—ñ–π...');
      updateProgress(0);
      try {
        const res = await fetch('all_districts.json');
        if (!res.ok) throw new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ all_districts.json: ${res.status}`);
        const data = await res.json();
        // —Ñ–æ—Ä–º—É—î–º–æ districts –Ω–∞ –æ—Å–Ω–æ–≤—ñ features (–≥–∞—Ä–∞–Ω—Ç—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å feature.id)
        districts = [];
        data.features.forEach((feature, idx) => {
          const id = feature.id;
          const pal = palette[idx % palette.length];
          const name = feature.properties?.name || `–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è ${idx+1}`;
          const d = { id, name, color: pal.color, fillColor: pal.fillColor };
          districts.push(d);
          districtMap[id] = d;
        });

        // —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è, —è–∫ –±—É–ª–æ
        districts.sort((a,b) => {
          const na = parseInt(a.id.replace('district',''),10);
          const nb = parseInt(b.id.replace('district',''),10);
          return (na || 0) - (nb || 0);
        });

        // —Å—Ç–≤–æ—Ä—é—î–º–æ —à–∞—Ä–∏
        let loadedCount = 0;
        const totalDistricts = districts.length;
        for (const feature of data.features) {
          const d = districtMap[feature.id];
          if (!d) { loadedCount++; updateProgress((loadedCount/totalDistricts)*100); continue; }

          const layerGroup = L.layerGroup();
          const geoJsonLayer = L.geoJSON(feature, {
            style: { color: d.color, fillColor: d.fillColor, fillOpacity: 0.4 },
            onEachFeature: (feat, lyr) => {
              // –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —Ü–µ–Ω—Ç—Ä
              try {
                const center = lyr.getBounds().getCenter();
                districtCenters.push({ id: d.id, name: feat.properties?.name || d.name, latlng: center });
              } catch(e){ /* ignore */ }
              // –∫–ª—ñ–∫ - –ø–æ–∫–∞–∑ –ø–æ–ø–∞–ø–∞ (–≤–∏–∫–ª–∏–∫–∞—î getTerritoryStatusPopup)
              lyr.on('click', async () => {
                const idNum = d.id.replace('district','');
                const popupContent = await getTerritoryStatusPopup(idNum, d.name);
                lyr.bindPopup(popupContent + `<br><button style="background-color: blue; color: white;" onclick="routeToDistrict('${d.name}')">üìå –ü—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç —Å—é–¥–∏</button>`).openPopup();
              });
            }
          });

          geoJsonLayer.addTo(layerGroup);
          loadedLayers.push({ id: d.id, name: d.name, layerGroup, geoJsonLayer });
          overlayMaps[d.name] = layerGroup;
          // —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–Ω–∞—á–µ–Ω—å –¥–ª—è —Å—Ç–∞—Ç—É—Å—ñ–≤/—Ç–∏–ø—ñ–≤
          territoryStatuses[d.id] = "–≤—ñ–ª—å–Ω–æ";
          territoryTypes[d.id] = "–Ω–µ–≤—ñ–¥–æ–º–æ";

          // —è–∫—â–æ –≤ URL —î —Ç–∞—Ä–≥–µ—Ç ‚Äî –ø–æ–∫–∞–∑—É—î–º –ª–∏—à–µ –π–æ–≥–æ —ñ —Ü–µ–Ω—Ç—Ä—É—î–º –∫–∞—Ä—Ç—É
          if (!targetId) {
            map.addLayer(layerGroup);
          } else if (d.id === targetId) {
            map.addLayer(layerGroup);
            const bounds = geoJsonLayer.getBounds();
            if (bounds && bounds.isValid && bounds.isValid()) map.fitBounds(bounds.pad(0.15));
            // –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –ø–æ–ø–∞–ø–∏ –Ω–∞ –≤—Å—ñ—Ö –ø—ñ–¥—à–∞—Ä—ñ–≤ –≤ —Ç–∞—Ä–≥–µ—Ç—ñ
            (async () => {
              const idNum = d.id.replace('district','');
              const popupContent = await getTerritoryStatusPopup(idNum, d.name);
              geoJsonLayer.eachLayer(sub => sub.bindPopup(popupContent + `<br><button style="background-color: blue; color: white;" onclick="routeToDistrict('${d.name}')">üìå –ü—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç —Å—é–¥–∏</button>`).openPopup());
            })();
          }

          // –≥–µ–æ–º–µ—Ç—Ä—ñ—è -> –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ (–≤–∏—Ç—è–≥—É—î–º–æ —Ç–æ—á–∫–∏ –¥–ª—è nearest)
          const coordinates = [];
          const geometries = feature.geometry.type === "GeometryCollection" ? feature.geometry.geometries : [feature.geometry];
          geometries.forEach(geom => {
            if (!geom || !geom.coordinates) return;
            const pushCoords = ring => ring.forEach(c => coordinates.push(L.latLng(c[1], c[0])));
            if (geom.type === "Polygon") geom.coordinates.forEach(pushCoords);
            else if (geom.type === "MultiPolygon") geom.coordinates.forEach(polygon => polygon.forEach(pushCoords));
          });
          districtGeometries.push({ id: d.id, name: d.name, coordinates });

          loadedCount++;
          // –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É
          updateProgress((loadedCount / totalDistricts) * 100);
        }

        // –∑–∞–≤–µ—Ä—à–∏–ª–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        showLoadingText('');
        tryAddLayersControl();          // –¥–æ–¥–∞—î–º–æ control (—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è checkbox event handlers –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ)
        updateTerritoriesDisplay();     // –ø–æ—á–∞—Ç–∫–æ–≤–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        // —è–∫—â–æ auth –≤–∂–µ –±—É–≤ ‚Äî –∑–∞–ø—É—Å–∫–∞—î–º–æ –ø—ñ–¥–ø–∏—Å–∫–∏
        if (currentUser) updateTerritoryStatuses();
      } catch(err) {
        console.warn('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ all_districts.json:', err);
        showLoadingText('');
      }
    })();

    // ************ –õ–æ–∫–∞–ª—ñ–∑–∞—Ü—ñ—è —Ç–∞ –º–∞—Ä—à—Ä—É—Ç ************
    let currentMarker = null, currentCircle = null, routeControl = null, currentLocation = null;
    function findLocation() {
      if (!navigator.geolocation) { alert('‚ö† –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é.'); return; }
      showLoadingText('–í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è...');
      navigator.geolocation.getCurrentPosition(position => {
        const latlng = L.latLng(position.coords.latitude, position.coords.longitude);
        currentLocation = latlng;
        showLoadingText('');
        if (currentMarker) map.removeLayer(currentMarker);
        if (currentCircle) map.removeLayer(currentCircle);
        currentCircle = L.circle(latlng, { radius: position.coords.accuracy, color:'blue', fillColor:'#30f', fillOpacity:0.2 }).addTo(map);
        currentMarker = L.marker(latlng).addTo(map).bindPopup(`–í–∞—à–µ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è (—Ç–æ—á–Ω—ñ—Å—Ç—å ${Math.round(position.coords.accuracy)} –º)`).openPopup();
        map.setView(latlng, 16);
      }, error => {
        showLoadingText('');
        console.error("Geolocation error:", error.message);
        alert(`‚ö† –ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è: ${error.message}`);
      }, { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 });
    }

    function routeToDistrict(districtName) {
      if (!currentLocation) { alert("‚õî –°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å üìç ¬´–ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ¬ª"); return; }
      const district = districtGeometries.find(d => d.name === districtName);
      if (!district || !district.coordinates.length) { alert(`‚ö† –ù–µ–º–∞—î –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è ${districtName}`); return; }
      let nearestPoint = district.coordinates.reduce((nearest, coord) => {
        const distance = currentLocation.distanceTo(coord);
        return distance < currentLocation.distanceTo(nearest) ? coord : nearest;
      }, district.coordinates[0]);
      if (routeControl) map.removeControl(routeControl);
      routeControl = L.Routing.control({
        waypoints: [currentLocation, nearestPoint],
        routeWhileDragging: false,
        addWaypoints: false,
        show: true,
        createMarker: () => null,
        router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' })
      }).on('routesfound', function(e) {
        const dist = e.routes[0].summary.totalDistance;
        const distText = dist > 1000 ? (dist/1000).toFixed(2) + " –∫–º" : Math.round(dist) + " –º";
        currentMarker?.bindPopup(`–í–∞—à–µ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è<br>–ú–∞—Ä—à—Ä—É—Ç –¥–æ <b>${districtName}</b><br>–í—ñ–¥—Å—Ç–∞–Ω—å: ${distText}`).openPopup();
      }).on('routingerror', function(e) {
        console.error("Routing error:", e.error);
        alert(`‚ö† –ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç: ${e.error?.message || '–ø–æ–º–∏–ª–∫–∞'}`);
      }).addTo(map);
    }

    window.findLocation = findLocation;
    window.routeToDistrict = routeToDistrict;

    // ************ share ************
    window.shareTerritory = function(number) {
      const url = `${window.location.origin}${window.location.pathname}?territory=${number}`;
      const title = `–ö–∞—Ä—Ç–∞: –¢–µ—Ä–∏—Ç–æ—Ä—ñ—è ‚Ññ${number}`;
      if (navigator.share) {
        navigator.share({ title, text: `–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è: ‚Ññ${number}`, url }).catch(err => {
          console.warn('share failed', err);
          try { navigator.clipboard.writeText(url); alert('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä'); } catch(e){ prompt('–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—é:', url); }
        });
      } else {
        try {
          navigator.clipboard.writeText(url);
          alert('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É');
        } catch(e) {
          prompt('–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—é:', url);
        }
      }
    };

    // ************ –§—ñ–ª—å—Ç—Ä–∏ —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ) ************
    function getFilterState() {
      const state = {
        toggleAll: el('toggleAll')?.checked ?? true,
        showTaken: el('showTaken')?.checked ?? false,
        showFree: el('showFree')?.checked ?? false,
        showTakenPrivate: el('showTakenPrivate')?.checked ?? false,
        showTakenMultistory: el('showTakenMultistory')?.checked ?? false,
        showTakenBusiness: el('showTakenBusiness')?.checked ?? false,
        showFreePrivate: el('showFreePrivate')?.checked ?? false,
        showFreeMultistory: el('showFreeMultistory')?.checked ?? false,
        showFreeBusiness: el('showFreeBusiness')?.checked ?? false
      };
      return state;
    }

    function updateTerritoriesDisplay() {
      // –∫—ç—à—É–≤–∞–Ω–Ω—è —Å—Ç–∞–Ω—É —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
      const f = getFilterState();
      // –æ–Ω–æ–≤–ª—é—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏
      const totalCount = districts.length;
      const takenCount = Object.values(territoryStatuses).filter(s => s === "–Ω–∞ —Ä—É–∫–∞—Ö").length;
      const freeCount = Object.values(territoryStatuses).filter(s => s === "–≤—ñ–ª—å–Ω–æ").length;
      const takenPrivateCount = Object.keys(territoryStatuses).filter(id => territoryStatuses[id] === "–Ω–∞ —Ä—É–∫–∞—Ö" && territoryTypes[id] === "–ü—Ä–∏–≤–∞—Ç–Ω–∞").length;
      const takenMultistoryCount = Object.keys(territoryStatuses).filter(id => territoryStatuses[id] === "–Ω–∞ —Ä—É–∫–∞—Ö" && territoryTypes[id] === "–ü–æ–≤–µ—Ä—Ö—ñ–≤–∫–∏").length;
      const takenBusinessCount = Object.keys(territoryStatuses).filter(id => territoryStatuses[id] === "–Ω–∞ —Ä—É–∫–∞—Ö" && territoryTypes[id] === "–î—ñ–ª–æ–≤–∞").length;
      const freePrivateCount = Object.keys(territoryStatuses).filter(id => territoryStatuses[id] === "–≤—ñ–ª—å–Ω–æ" && territoryTypes[id] === "–ü—Ä–∏–≤–∞—Ç–Ω–∞").length;
      const freeMultistoryCount = Object.keys(territoryStatuses).filter(id => territoryStatuses[id] === "–≤—ñ–ª—å–Ω–æ" && territoryTypes[id] === "–ü–æ–≤–µ—Ä—Ö—ñ–≤–∫–∏").length;
      const freeBusinessCount = Object.keys(territoryStatuses).filter(id => territoryStatuses[id] === "–≤—ñ–ª—å–Ω–æ" && territoryTypes[id] === "–î—ñ–ª–æ–≤–∞").length;

      el('total-count').textContent = `(${totalCount})`;
      el('taken-count').textContent = `(${takenCount})`;
      el('free-count').textContent = `(${freeCount})`;
      el('taken-private-count').textContent = `(${takenPrivateCount})`;
      el('taken-multistory-count').textContent = `(${takenMultistoryCount})`;
      el('taken-business-count').textContent = `(${takenBusinessCount})`;
      el('free-private-count').textContent = `(${freePrivateCount})`;
      el('free-multistory-count').textContent = `(${freeMultistoryCount})`;
      el('free-business-count').textContent = `(${freeBusinessCount})`;

      // –Ø–∫—â–æ –∑–∞–¥–∞–Ω–æ targetId ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ –ª–∏—à–µ –π–æ–≥–æ
      if (targetId) {
        loadedLayers.forEach(item => {
          if (item.id === targetId) { if (!map.hasLayer(item.layerGroup)) map.addLayer(item.layerGroup); }
          else { if (map.hasLayer(item.layerGroup)) map.removeLayer(item.layerGroup); }
        });
        return;
      }

      // –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —à–∞—Ä—É –≤–∏—Ä—ñ—à—É—î–º–æ, —á–∏ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –π–æ–≥–æ
      loadedLayers.forEach(({ id, layerGroup }) => {
        const status = territoryStatuses[id] || "–≤—ñ–ª—å–Ω–æ";
        const type = territoryTypes[id] || "–Ω–µ–≤—ñ–¥–æ–º–æ";

        let show = false;
        if (f.toggleAll) show = true;
        else {
          if (f.showTaken && status === "–Ω–∞ —Ä—É–∫–∞—Ö") {
            if (!f.showTakenPrivate && !f.showTakenMultistory && !f.showTakenBusiness) show = true;
            else show = (f.showTakenPrivate && type === "–ü—Ä–∏–≤–∞—Ç–Ω–∞") || (f.showTakenMultistory && type === "–ü–æ–≤–µ—Ä—Ö—ñ–≤–∫–∏") || (f.showTakenBusiness && type === "–î—ñ–ª–æ–≤–∞");
          }
          if (f.showFree && status === "–≤—ñ–ª—å–Ω–æ") {
            if (!f.showFreePrivate && !f.showFreeMultistory && !f.showFreeBusiness) show = true;
            else show = (f.showFreePrivate && type === "–ü—Ä–∏–≤–∞—Ç–Ω–∞") || (f.showFreeMultistory && type === "–ü–æ–≤–µ—Ä—Ö—ñ–≤–∫–∏") || (f.showFreeBusiness && type === "–î—ñ–ª–æ–≤–∞");
          }
        }

        if (show) { if (!map.hasLayer(layerGroup)) map.addLayer(layerGroup); }
        else { if (map.hasLayer(layerGroup)) map.removeLayer(layerGroup); }
      });
    }

    // ************ –î–æ–¥–∞–≤–∞–Ω–Ω—è control —ñ –¥–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π (—Å–ø—Ä–æ—â–µ–Ω–æ) ************
    function tryAddLayersControl(){
      if (layersControl) return;
      const sortedOverlayMaps = {};
      // –¥–æ–¥–∞—î–º–æ —É —Ç–æ–π –∂–µ –ø–æ—Ä—è–¥–æ–∫, —è–∫ loadedLayers
      loadedLayers.forEach(({ name, layerGroup }) => { sortedOverlayMaps[name] = layerGroup; });
      layersControl = L.control.layers({ "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –∫–∞—Ä—Ç–∞": googleStreets, "–°—É–ø—É—Ç–Ω–∏–∫–æ–≤–∞ –∫–∞—Ä—Ç–∞": satellite }, sortedOverlayMaps, { collapsed: true }).addTo(map);

      // –∫–µ—à DOM —á–µ–∫–±–æ–∫—Å—ñ–≤ (—ó—Ö –º–æ–∂–µ –Ω–µ –±—É—Ç–∏ –¥–æ —Ä–µ–Ω–¥–µ—Ä—É)
      const ids = ['toggleAll','toggleAllLabel','showTaken','showFree','showTakenPrivate','showTakenMultistory','showTakenBusiness','showFreePrivate','showFreeMultistory','showFreeBusiness'];
      const elems = Object.fromEntries(ids.map(id => [id, el(id)]));

      // –ø–æ—á–∞—Ç–∫–æ–≤—ñ —Å—Ç–∞–Ω–∏
      elems.toggleAll.checked = !targetId;
      if (elems.showTaken) elems.showTaken.checked = false;
      if (elems.showFree) elems.showFree.checked = false;
      ['showTakenPrivate','showTakenMultistory','showTakenBusiness','showFreePrivate','showFreeMultistory','showFreeBusiness'].forEach(k => { if (elems[k]) elems[k].checked = false; });
      el('toggleAllLabel').innerText = '–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ—Ö';

      // –¥–µ–ª–µ–≥—É—î–º–æ –æ–±—Ä–æ–±–∫—É –≤—Å—ñ—Ö –∑–º—ñ–Ω–∏ —á–µ—Ä–µ–∑ –æ–¥–∏–Ω —Å–ª—É—Ö–∞—á
      const controlsPanel = el('controls-panel');
      controlsPanel.addEventListener('change', (ev) => {
        const t = ev.target;
        // –ª–æ–≥—ñ–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–∞: —è–∫—â–æ –Ω–∞—Ç–∏—Å–Ω—É–ª–∏ toggleAll
        if (t.id === 'toggleAll') {
          if (t.checked) {
            // –≤–∏–º–∏–∫–∞—î–º–æ –≤—Å—ñ —ñ–Ω—à—ñ
            ['showTaken','showFree','showTakenPrivate','showTakenMultistory','showTakenBusiness','showFreePrivate','showFreeMultistory','showFreeBusiness'].forEach(id => { if (el(id)) el(id).checked = false; });
            el('toggleAllLabel').innerText = '–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ—Ö';
          } else el('toggleAllLabel').innerText = '–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ—Ö';
        }
        // —è–∫—â–æ –Ω–∞—Ç–∏—Å–Ω—É–ª–∏ –≥–æ–ª–æ–≤–Ω–∏–π showTaken/showFree ‚Äî –≤–∏–∫–ª—é—á–∞—î–º–æ —ñ–Ω—à—É —Å–µ–∫—Ü—ñ—é —ñ –ø—ñ–¥—Ç–∏–ø–∏
        if (t.id === 'showTaken' && t.checked) {
          el('toggleAll').checked = false; el('toggleAllLabel').innerText = '–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ—Ö';
          ['showTakenPrivate','showTakenMultistory','showTakenBusiness'].forEach(id => { if (el(id)) el(id).checked = false; });
        }
        if (t.id === 'showFree' && t.checked) {
          el('toggleAll').checked = false; el('toggleAllLabel').innerText = '–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ—Ö';
          ['showFreePrivate','showFreeMultistory','showFreeBusiness'].forEach(id => { if (el(id)) el(id).checked = false; });
        }
        // —è–∫—â–æ –Ω–∞—Ç–∏—Å–Ω—É–ª–∏ –ø—ñ–¥—Ç–∏–ø ‚Äî –≤–º–∏–∫–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—É –≥–æ–ª–æ–≤–Ω—É —Å–µ–∫—Ü—ñ—é
        const parentMap = {
          showTakenPrivate: 'showTaken', showTakenMultistory: 'showTaken', showTakenBusiness: 'showTaken',
          showFreePrivate: 'showFree', showFreeMultistory: 'showFree', showFreeBusiness: 'showFree'
        };
        if (parentMap[t.id] && t.checked) {
          el(parentMap[t.id]).checked = true;
          el('toggleAll').checked = false; el('toggleAllLabel').innerText = '–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ—Ö';
        }
        // –ø—ñ—Å–ª—è –∫–æ–∂–Ω–æ—ó –∑–º—ñ–Ω–∏ ‚Äî –æ–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        if (targetId) targetId = null; // —Å–∫–∏–¥–∞—î–º–æ —Ç–∞—Ä–≥–µ—Ç –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∞
        updateTerritoriesDisplay();
      });
    }

  </script>
</body>
</html>
