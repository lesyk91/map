<!DOCTYPE html>
<html lang="uk">
<head>
<meta name="robots" content="noindex, nofollow">
<meta charset="utf-8" />
<title>–ö–∞—Ä—Ç–∞ –¢–µ—Ä–∏—Ç–æ—Ä—ñ–π –∑ Google Maps</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<style>
html,body,#map {
    height:100%;
    margin:0;
    padding:0;
}
button.layer-toggle,button.locate-btn,button.login-btn,button.logout-btn {
    position:absolute;
    left:50px;
    z-index:1000;
    padding:8px 12px;
    background:#ffffff;
    border:1px solid #ccc;
    border-radius:4px;
    cursor:pointer;
}
button.locate-btn { top: 10px }
button.layer-toggle { top: 50px }
button.login-btn, button.logout-btn { top: 90px }
#loader {
    position:absolute;
    top:10px;
    left:215px;
    z-index:1000;
    padding:8px;
    background:#ffffff;
    border:1px solid #ccc;
    border-radius:10px;
}
</style>
</head>
<body>
<button onclick="findLocation()" class="locate-btn">üìç –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ</button>
<button onclick="toggleLayers()" class="layer-toggle">üó∫ –®–∞—Ä–∏</button>
<div id="auth-buttons">
    <a href="enter.html"><button class="login-btn" style="display:none">üîê –£–≤—ñ–π—Ç–∏</button></a>
    <button class="logout-btn" style="display:none">üö™ –í–∏–π—Ç–∏</button>
</div>
<div id="loader"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = { 
    apiKey: "AIzaSyDracSUSYz_QrmmDj_HcBfQpJlJ3FjPHpU", 
    authDomain: "map-illintsi.firebaseapp.com", 
    projectId: "map-illintsi", 
    storageBucket: "map-illintsi.appspot.com", 
    messagingSenderId: "62267872375", 
    appId: "1:62267872375:web:10945d2d63b93bccc5e272" 
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
let currentUser = null;

const loginBtn = document.querySelector('.login-btn'); 
const logoutBtn = document.querySelector('.logout-btn'); 
 
onAuthStateChanged(auth, user => { 
    currentUser = user; 
    if (user) { 
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
    } else { 
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
    }
}); 
 
logoutBtn?.addEventListener("click", async () => { 
    await signOut(auth);
    location.reload();
}); 
 
onAuthStateChanged(auth, user => { 
    currentUser = user; 
}); 
 
window.getTerritoryStatusPopup = async (number, name) => { 
    if (!currentUser) return `<b>${name}</b><br><i>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å</i>`; 
    const q = query(collection(db, `territories/${number}/history`), orderBy("timestamp", "desc")); 
    const snap = await getDocs(q); 
    let popup = `<b>${name}</b><br>`; 
    if (snap.empty) { 
        popup += `<b>–°—Ç–∞—Ç—É—Å:</b> –≤—ñ–ª—å–Ω–æ`; 
    } else { 
        const data = snap.docs[0].data(); 
        popup += `<b>–°—Ç–∞—Ç—É—Å:</b> ${data.status}<br>`; 
        if (data.status === "–Ω–∞ —Ä—É–∫–∞—Ö") { 
            popup += `<b>–ü–Ü–ë:</b> ${data.pib}<br>`; 
            popup += `<b>–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è:</b> ${new Date(data.dateGet).toLocaleDateString("uk-UA")}`; 
        }
    }
    return popup; 
};

</script>

<script>
const map = L.map('map').setView([49.1029, 29.2074], 13);
const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
    attribution:'¬© Google Maps'
}).addTo(map);
const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution:'¬© Esri',
    maxZoom:20
});

// –≥–µ–Ω–µ—Ä—É—î–º–æ –≤—Å—ñ —Ä–∞–π–æ–Ω–∏ –≤—ñ–¥ 1 –¥–æ 150
const colors = ['blue', 'green', 'red', 'purple', 'orange']; 
function colorFor(id) { 
    const idx = parseInt(id.replace('district', ''), 10);
    return colors[idx % colors.length]; 
}

const districts = [];

for (let i = 1; i <= 150; i++) {
    districts.push({ 
        id: `district${i}`,
        name: `–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è ${i}`,
        color: colorFor(`district${i}`),
        fillColor: colorFor(`district${i}`),
    });
}

const districtGeometries = []; 
const overlayMaps = {};

function showLoading(show) {
    document.getElementById('loader').innerText = show ? '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...' : '';
}

function tryAddLayersControl(){
    if (Object.keys(overlayMaps).length === districts.length) {
        L.control.layers({"–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –∫–∞—Ä—Ç–∞": googleStreets,"–°—É–ø—É—Ç–Ω–∏–∫–æ–≤–∞ –∫–∞—Ä—Ç–∞": satellite}, overlayMaps,{collapsed:true}).addTo(map);
    }
}

function routeToDistrict(districtName) { 
    if (!currentLocation) return alert("‚õî –°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å üìç ¬´–ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ¬ª"); 
    const district = districtGeometries.find(d => d.name === districtName);
    if (!district || !district.coordinates.length) return alert(`‚ö† –ù–µ–º–∞—î –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è ${districtName}`);

    let nearestPoint = district.coordinates.reduce((nearest, coord) => 
        currentLocation.distanceTo(coord) < currentLocation.distanceTo(nearest) ? coord : nearest
    );

    if (routeControl) map.removeControl(routeControl);
    routeControl = L.Routing.control({ 
        waypoints: [currentLocation, nearestPoint],
        routeWhileDragging: false, 
        addWaypoints: false, 
        show: false, 
        createMarker: () => null 
    }).addTo(map);
    const dist = currentLocation.distanceTo(nearestPoint);
    const distText = dist > 1000 ? (dist / 1000).toFixed(2) + " –∫–º" : Math.round(dist) + " –º";
    currentMarker?.bindPopup(`–í–∞—à–µ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è<br>–ú–∞—Ä—à—Ä—É—Ç –¥–æ <b>${districtName}</b><br>–í—ñ–¥—Å—Ç–∞–Ω—å: ${distText}`).openPopup();
}

function findLocation() { 
    if (!navigator.geolocation) return alert('‚ö† –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é.'); 
    showLoading(true);
    map.locate({ setView: true, maxZoom: 16, timeout: 20000, enableHighAccuracy: true });
}

let currentLocation = null;
let currentMarker = null;
let currentCircle = null;
let routeControl = null;

map.on('locationfound', e => { 
    currentLocation = e.latlng; 
    showLoading(false);
    if (currentMarker) map.removeLayer(currentMarker);
    if (currentCircle) map.removeLayer(currentCircle);
    currentCircle = L.circle(e.latlng,{ radius: e.accuracy, color:'blue', fillColor:'#30f', fillOpacity:0.2 }).addTo(map);
    currentMarker = L.marker(e.latlng).addTo(map).bindPopup("–í–∞—à–µ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è (—Ç–æ—á–Ω—ñ—Å—Ç—å " + Math.round(e.accuracy) + " –º)").openPopup();
}); 
 
map.on('locationerror', e => { 
    showLoading(false);
    alert("‚ö† –ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è: " + e.message);
});

// –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—Å—ñ —Ä–∞–π–æ–Ω–∏
districts.forEach(d => { 
    showLoading(true);
    fetch(`${d.id}.json`)
    .then(res => res.json()) 
    .then(data => { 
        const layer = L.layerGroup();

        const geoJson = L.geoJSON(data,{ 
            onEachFeature: (feature, layer) => { 
                layer.on("click", async () => { 
                    const popupContent = await window.getTerritoryStatusPopup(d.id.replace("district",""), d.name);
                    layer.bindPopup(popupContent + `<br><button onclick="routeToDistrict('${d.name}')">üìå –ü—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç —Å—é–¥–∏</button>`).openPopup();
                }); 
            },
            style:{ color: d.color, fillColor: d.fillColor, fillOpacity: 0.4 }
        }).addTo(layer);
        
        overlayMaps[d.name] = layer;

        // –∑–±–µ—Ä–µ–∂—ñ—Ç—å –≤—Å—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –Ω–∞–π–±–ª–∏–∂—á–∏—Ö —Ç–æ—á–æ–∫
        const coords = []; 
        const geoms = data?.type === "FeatureCollection" ? data.features : [data]; 
        geoms?.forEach(f => { 
            if (f.geometry?.type === "Polygon") { 
                f.geometry.coordinates[0]?.forEach(([lon, lat]) => coords.push(L.latLng(lat, lon)));
            } else if (f.geometry?.type === "MultiPolygon") { 
                f.geometry.coordinates?.forEach(ring => { 
                    ring[0]?.forEach(([lon, lat]) => coords.push(L.latLng(lat, lon)));
                });
            }
        });

        districtGeometries.push({ name: d.name, coordinates: coords });

        showLoading(false);
        tryAddLayersControl();

    })
    .catch(err => { 
        console.error(err);
        showLoading(false);
    }); 
});

// —â–æ–± —Ä–æ–∑–≤–µ—Ä–Ω—É—Ç–∏/—Å–∫—Ä–∏—Ç–∏ –º–µ–Ω—é —à–∞—Ä—ñ–≤
function toggleLayers() {
    const control = document.querySelector('.leaflet-control-layers'); 
    if (control) control.classList.toggle('leaflet-control-layers-expanded'); 
    const btn = document.querySelector('.layer-toggle'); 
    btn.innerText = control?.classList?.contains('leaflet-control-layers-expanded') ? 'üó∫ –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —à–∞—Ä–∏' : 'üó∫ –®–∞—Ä–∏';
}

</script>

</body>
</html>
