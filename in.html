<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>–ö–∞—Ä—Ç–∞ –¢–µ—Ä–∏—Ç–æ—Ä—ñ–π "–Ü–ª–ª—ñ–Ω—Ü—ñ"</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .control-btn { position: absolute; left: 50px; z-index: 1000; padding: 8px 12px; background: white; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }
    .locate-btn { top: 10px; }
    .layer-toggle { top: 50px; }
    .auth-btn { top: 90px; }
    #loader { position: absolute; top: 10px; left: 215px; z-index: 1000; padding: 8px; background: white; border: 1px solid #ccc; border-radius: 10px; }
    #auth-container, #form-container { position: absolute; top: 140px; left: 50px; background: white; padding: 10px; z-index: 1001; border-radius: 6px; display: none; }
  </style>
</head>
<body>
<button onclick="findLocation()" class="control-btn locate-btn">üìç –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ</button>
<button onclick="toggleLayers()" class="control-btn layer-toggle">üó∫ –®–∞—Ä–∏</button>
<button onclick="toggleAuth()" class="control-btn auth-btn" id="authButton">üîê –£–≤—ñ–π—Ç–∏</button>
<div id="loader"></div>
<div id="auth-container">
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å"><br>
  <button onclick="login()">–£–≤—ñ–π—Ç–∏</button>
  <button onclick="logout()">–í–∏–π—Ç–∏</button>
</div>
<div id="form-container">
  <div id="form-content"></div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDracSUSYz_QrmmDj_HcBfQpJlJ3FjPHpU",
  authDomain: "map-illintsi.firebaseapp.com",
  projectId: "map-illintsi",
  storageBucket: "map-illintsi.firebasestorage.app",
  messagingSenderId: "62267872375",
  appId: "1:62267872375:web:10945d2d63b93bccc5e272",
  measurementId: "G-22L16KP5Z0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore(app);

let currentUser = null;
let selectedDistrict = null;

onAuthStateChanged(auth, (user) => {
  currentUser = user;
  document.getElementById('auth-container').style.display = user ? 'none' : 'block';
  document.getElementById('authButton').innerText = user ? 'üîì –í–∏–π—Ç–∏' : 'üîê –£–≤—ñ–π—Ç–∏';
});

window.toggleAuth = () => {
  const container = document.getElementById('auth-container');
  container.style.display = container.style.display === 'block' ? 'none' : 'block';
};

window.login = async () => {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch (e) {
    alert('–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: ' + e.message);
  }
};

window.logout = () => {
  signOut(auth);
};

const map = L.map('map').setView([49.1029, 29.2074], 13);
const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
  maxZoom: 20, subdomains: ['mt0', 'mt1', 'mt2', 'mt3'], attribution: '¬© Google Maps'
}).addTo(map);
const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: '¬© Esri', maxZoom: 20
});

const baseMaps = {"–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –∫–∞—Ä—Ç–∞": googleStreets, "–°—É–ø—É—Ç–Ω–∏–∫–æ–≤–∞ –∫–∞—Ä—Ç–∞": satellite};
const overlayMaps = {}; L.control.layers(baseMaps, overlayMaps, { collapsed: true }).addTo(map);

const districts = [
  { id: 'district1', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 1', color: 'blue', fillColor: '#99ccff' },
  { id: 'district2', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 2', color: 'green', fillColor: '#b6fcb6' },
  { id: 'district55', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 55', color: 'green', fillColor: '#b6fcb6' },
  { id: 'district56', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 56', color: 'green', fillColor: '#b6fcb6' }
];

function createDistrictPopup(name, latlng) {
  return `<b>${name}</b><br>
    <button onclick="routeToDistrict('${name}')">üìå –ü—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç —Å—é–¥–∏</button><br>
    ${currentUser ? `<button onclick="showForm('${name}')">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>` : ''}`;
}

async function showForm(name) {
  selectedDistrict = name;
  const formDiv = document.getElementById('form-content');
  formDiv.innerHTML = `
    <h3>${name}</h3>
    <input id="fullName" placeholder="–ü–Ü–ë –≤—ñ—Å–Ω–∏–∫–∞"><br>
    <input type="date" id="receivedDate"><br>
    <input type="date" id="processedDate"><br>
    <textarea id="extraInfo" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è"></textarea><br>
    <button onclick="saveRecord()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
  `;
  document.getElementById('form-container').style.display = 'block';
}

window.saveRecord = async () => {
  const record = {
    territory: selectedDistrict,
    pib: document.getElementById('fullName').value,
    receivedDate: document.getElementById('receivedDate').value,
    processedDate: document.getElementById('processedDate').value,
    extraInfo: document.getElementById('extraInfo').value,
    addedAt: Timestamp.now(),
    addedBy: currentUser.email
  };
  try {
    await addDoc(collection(db, 'territoryRecords'), record);
    alert('‚úÖ –ó–∞–ø–∏—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ');
    document.getElementById('form-container').style.display = 'none';
  } catch (e) {
    alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ: ' + e.message);
  }
};

function toggleLayers() {
  const control = document.querySelector('.leaflet-control-layers');
  control?.classList.toggle('leaflet-control-layers-expanded');
  document.querySelector('.layer-toggle').innerText = control.classList.contains('leaflet-control-layers-expanded') ? 'üó∫ –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —à–∞—Ä–∏' : 'üó∫ –®–∞—Ä–∏';
}

let currentLocation = null;
window.findLocation = () => {
  if (!navigator.geolocation) return alert('‚ö† –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é');
  map.locate({ setView: true, maxZoom: 16 });
};

map.on('locationfound', (e) => {
  currentLocation = e.latlng;
  L.marker(e.latlng).addTo(map).bindPopup('–í–∞—à–µ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è').openPopup();
});

window.routeToDistrict = (name) => {
  if (!currentLocation) return alert('üìç –°–ø–æ—á–∞—Ç–∫—É –≤–∏–∑–Ω–∞—á—ñ—Ç—å —Å–≤–æ—î –º—ñ—Å—Ü–µ');
};

districts.forEach(d => {
  const layer = L.layerGroup();
  fetch(`${d.id}.json`).then(res => res.json()).then(data => {
    const geoJsonLayer = L.geoJSON(data, {
      onEachFeature: (feature, l) => {
        const center = l.getBounds().getCenter();
        l.bindPopup(createDistrictPopup(d.name, center));
      },
      style: { color: d.color, fillColor: d.fillColor, fillOpacity: 0.4 }
    });
    geoJsonLayer.addTo(layer);
  });
  overlayMaps[d.name] = layer;
});
</script>
</body>
</html>
