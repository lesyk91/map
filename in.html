<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Території Іллінці</title>
  <script type="module">
    // --- Імпортуємо Firebase-модулі для роботи з авторизацією та Firestore ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, updateDoc, deleteDoc, query, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // --- Конфігурація Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyDracSUSYz_QrmmDj_HcBfQpJlJ3FjPHpU",
      authDomain: "map-illintsi.firebaseapp.com",
      projectId: "map-illintsi",
      storageBucket: "map-illintsi.firebasestorage.app",
      messagingSenderId: "62267872375",
      appId: "1:62267872375:web:10945d2d63b93bccc5e272",
      measurementId: "G-22L16KP5Z0"
    };

    // --- Ініціалізація Firebase додатку ---
    const app = initializeApp(firebaseConfig);
    // --- Ініціалізація модуля авторизації ---
    const auth = getAuth();
    // --- Ініціалізація Firestore ---
    const db = getFirestore(app);

    const loginForm = document.getElementById("login-form");
    const appContainer = document.getElementById("app");
    const territoriesList = document.getElementById("territories");
    const territoryData = document.getElementById("territory-data");
    const logoutBtn = document.getElementById("logout");

    // --- Обробка події входу ---
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = loginForm.email.value;
      const password = loginForm.password.value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        alert("Помилка входу: " + error.message);
      }
    });

    // --- Обробка виходу ---
    logoutBtn.onclick = () => signOut(auth);

    // --- Слухач змін авторизації ---
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginForm.style.display = "none";
        appContainer.style.display = "block";
        loadTerritories();
      } else {
        loginForm.style.display = "block";
        appContainer.style.display = "none";
      }
    });

    // --- Завантаження кнопок територій ---
    async function loadTerritories() {
      territoriesList.innerHTML = "";
      for (let i = 1; i <= 150; i++) {
        const btn = document.createElement("button");
        btn.textContent = `Територія ${i}`;
        btn.onclick = () => openTerritory(i);
        territoriesList.appendChild(btn);
      }
    }

    // --- Завантаження і відображення конкретної території ---
    async function openTerritory(number) {
      territoryData.innerHTML = `<h2>Територія ${number}</h2>`;
      const colRef = collection(db, `territories/${number}/history`);
      const q = query(colRef, orderBy("timestamp", "desc"));
      const snap = await getDocs(q);

      

      const form = document.createElement("form");
      form.innerHTML = `
        <h3>Новий запис</h3>
        <input required name="pib" placeholder="ПІБ вісника" /><br/>
        <input required name="dateGet" type="date" placeholder="Дата отримання" /><br/>
        <input name="dateProcess" type="date" placeholder="Дата опрацювання (необов’язково)" /><br/>
        <textarea name="note" placeholder="Додаткова інформація"></textarea><br/>
        <button type="submit">Зберегти</button>
      `;

      form.onsubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const dateGet = formData.get("dateGet");
        const dateProcess = formData.get("dateProcess");
        const status = dateProcess ? "вільно" : "на руках";
        const diffDays = dateProcess ? Math.ceil((new Date(dateProcess) - new Date(dateGet)) / 86400000) : null;
        const lastDiff = dateProcess ? Math.ceil((new Date() - new Date(dateProcess)) / 86400000) : null;

        await addDoc(collection(db, `territories/${number}/history`), {
          pib: formData.get("pib"),
          dateGet,
          dateProcess,
          note: formData.get("note"),
          user: auth.currentUser.email,
          timestamp: serverTimestamp(),
          status,
          processingTime: diffDays,
          timeSinceLast: lastDiff
        });

        openTerritory(number);
      };

      territoryData.appendChild(form);
	  
	  snap.forEach(docSnap => {
        const data = docSnap.data();
        const docId = docSnap.id;

        const entry = document.createElement("div");
        entry.innerHTML = `
          <hr />
          <strong>ПІБ:</strong> ${data.pib || "-"} <br/>
          <strong>Дата отримання:</strong> ${data.dateGet || "-"} <br/>
          <strong>Дата опрацювання:</strong> ${data.dateProcess || "-"} <br/>
          <strong>Додаткова інформація:</strong> ${data.note || "-"} <br/>
          <strong>Хто додав:</strong> ${data.user || "-"} <br/>
          <strong>Дата запису:</strong> ${data.timestamp?.toDate().toLocaleString() || "-"} <br/>
          <strong>Статус:</strong> ${data.status || "-"} <br/>
          <strong>Час опрацювання (днів):</strong> ${data.processingTime || "-"} <br/>
          <strong>Час від останнього опрацювання (днів):</strong> ${data.timeSinceLast || "-"} <br/>
          <button onclick="editEntry('${number}', '${docId}')">Редагувати</button>
          <button onclick="deleteEntry('${number}', '${docId}')">Видалити</button>
        `;

         territoryData.appendChild(entry);
      });
	 
    }

    // --- Функція редагування запису ---
    window.editEntry = async (territoryNumber, docId) => {
      const docRef = doc(db, `territories/${territoryNumber}/history/${docId}`);
      const docSnap = await getDoc(docRef);
      const data = docSnap.data();

      const form = document.createElement("form");
      form.innerHTML = `
        <h3>Редагувати запис</h3>
        <input required name="pib" value="${data.pib}" /><br/>
        <input required name="dateGet" type="date" value="${data.dateGet}" /><br/>
        <input name="dateProcess" type="date" value="${data.dateProcess || ''}" /><br/>
        <textarea name="note">${data.note || ''}</textarea><br/>
        <button type="submit">Оновити</button>
      `;

      form.onsubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const dateGet = formData.get("dateGet");
        const dateProcess = formData.get("dateProcess");
        const status = dateProcess ? "вільно" : "на руках";
        const diffDays = dateProcess ? Math.ceil((new Date(dateProcess) - new Date(dateGet)) / 86400000) : null;
        const lastDiff = dateProcess ? Math.ceil((new Date() - new Date(dateProcess)) / 86400000) : null;

        await updateDoc(docRef, {
          pib: formData.get("pib"),
          dateGet,
          dateProcess,
          note: formData.get("note"),
          user: auth.currentUser.email,
          status,
          processingTime: diffDays,
          timeSinceLast: lastDiff
        });

        openTerritory(territoryNumber);
      };

      territoryData.innerHTML = "";
      territoryData.appendChild(form);
    };

    // --- Функція видалення запису ---
    window.deleteEntry = async (territoryNumber, docId) => {
      if (confirm("Ви впевнені, що хочете видалити цей запис?")) {
        await deleteDoc(doc(db, `territories/${territoryNumber}/history/${docId}`));
        openTerritory(territoryNumber);
      }
    };

  </script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #territories button { margin: 5px; }
    #login-form, #app { display: none; }
    form input, form textarea { width: 100%; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>Ведення територій м. Іллінці</h1>
  <form id="login-form">
    <h2>Вхід</h2>
    <input name="email" type="email" placeholder="Email" required />
    <input name="password" type="password" placeholder="Пароль" required />
    <button type="submit">Увійти</button>
  </form>

  <div id="app">
    <button id="logout">Вийти</button>
        		<div id="territories"></div>
				<div id="territory-data"></div>
  </div>
</body>
</html>
