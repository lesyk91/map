<!DOCTYPE html>
<html lang="uk">
<head>
<meta name="robots" content="noindex, nofollow">
<meta charset="utf-8" />
<title>–ö–∞—Ä—Ç–∞ –¢–µ—Ä–∏—Ç–æ—Ä—ñ–π "–Ü–ª–ª—ñ–Ω—Ü—ñ" –∑ Google Maps</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<style>
html,body,#map { height: 100%; margin: 0; padding: 0 }
button.layer-toggle, button.locate-btn, button.login-btn, button.logout-btn {
	position: absolute;
	left: 50px;
	z-index: 1000;
	padding: 8px 12px;
	background: white;
	border: 1px solid #ccc;
	border-radius: 4px;
	cursor: pointer;
}
button.locate-btn { top: 10px }
button.layer-toggle { top: 50px }
button.login-btn, button.logout-btn { top: 90px }
#loader { 
	position: absolute; top: 10px; left: 215px; z-index: 1000;
	padding: 8px; background: white; border: 1px solid #ccc; border-radius: 10px;
}
</style>
</head>
<body>
<button onclick="findLocation()" class="locate-btn">üìç –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ</button> 
<button onclick="toggleLayers()" class="layer-toggle">üó∫ –®–∞—Ä–∏</button> 
<div id="auth-buttons">
	<a href="enter.html"><button class="login-btn" style="display:none">üîê –£–≤—ñ–π—Ç–∏</button></a> 
	<button class="logout-btn" style="display:none">üö™ –í–∏–π—Ç–∏</button> 
</div> 
<div id="loader"></div> 
<div id="map"></div> 
 
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script> 
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script> 
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = { 
	apiKey: "AIzaSyDracSUSYz_QrmmDj_HcBfQpJlJ3FjPHpU", 
	authDomain: "map-illintsi.firebaseapp.com", 
	projectId: "map-illintsi", 
	storageBucket: "map-illintsi.appspot.com", 
	messagingSenderId: "62267872375", 
	appId: "1:62267872375:web:10945d2d63b93bccc5e272" 
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
let currentUser = null;

const loginBtn = document.querySelector('.login-btn'); 
const logoutBtn = document.querySelector('.logout-btn'); 
onAuthStateChanged(auth, user => { 
	currentUser = user; 
	if (user) { 
		loginBtn.style.display = 'none';
		logoutBtn.style.display = 'inline-block';
	} else { 
		loginBtn.style.display = 'inline-block';
		logoutBtn.style.display = 'none';
	} 
}); 
logoutBtn?.addEventListener("click", async () => { 
	await signOut(auth);
	location.reload();
}); 


window.getTerritoryStatusPopup = async (number, name) => { 
	if (!currentUser) return `<b>${name}</b><br><i>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å</i>`; 
	const q = query(collection(db, `territories/${number}/history`), orderBy("timestamp", "desc")); 
	const snap = await getDocs(q); 
	let popup = `<b>${name}</b><br>`; 
	if (snap.empty) { 
		popup += `<b>–°—Ç–∞—Ç—É—Å:</b> –≤—ñ–ª—å–Ω–æ`; 
	} else { 
		const data = snap.docs[0].data(); 
		popup += `<b>–°—Ç–∞—Ç—É—Å:</b> ${data.status}<br>`; 
		if (data.status === "–Ω–∞ —Ä—É–∫–∞—Ö") { 
			popup += `<b>–ü–Ü–ë:</b> ${data.pib}<br>`; 
			popup += `<b>–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è:</b> ${new Date(data.dateGet).toLocaleDateString("uk-UA")}`; 
		} 
	} 
	return popup; 
};

</script>

<script>
const map = L.map('map').setView([49.1029, 29.2074], 13);
const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { 
	maxZoom: 20, 
	subdomains: ['mt0', 'mt1', 'mt2', 'mt3'], 
	attribution:'¬© Google Maps'
}).addTo(map);
const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { 
	attribution:'¬© Esri',
	maxZoom: 20
});

// —Å—Ç–≤–æ—Ä—é—î control –≤—ñ–¥—Ä–∞–∑—É
const baseMaps = { "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –∫–∞—Ä—Ç–∞": googleStreets,"–°—É–ø—É—Ç–Ω–∏–∫–æ–≤–∞ –∫–∞—Ä—Ç–∞": satellite };
const overlays = {};

const control = L.control.layers(baseMaps, overlays,{collapsed:true}).addTo(map);

// –ú–∞—Å–∏–≤ –∑ –≤—Å—ñ–º–∞ —Ä–∞–π–æ–Ω–∞–º–∏:
const districts = [
	{ id:'district1', name:'–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 1', color:'blue', fillColor:'#99ccff' },
	{ id:'district2', name:'–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 2', color:'green', fillColor:'#b6fcb6' },
	{ id:'district55', name:'–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 55', color:'green', fillColor:'#b6fcb6' },
	{ id:'district56', name:'–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 56', color:'red', fillColor:'#b6fcb6' }
	// –¢—É—Ç –º–æ–∂–µ—à –¥–æ–¥–∞—Ç–∏ –≤—Å—ñ 150...
];

// –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—Å—ñ:
districts.forEach(d => {
	fetch(`${d.id}.json`)
		.then(r => r.json()) 
		.then(data => { 
			const layer = L.geoJSON(data, { 
				onEachFeature: (feature, layer) => { 
					const center = layer.getBounds().getCenter();
					layer.on("click", async () => { 
						const popupContent = await window.getTerritoryStatusPopup(d.id.replace("district",""), d.name);
						layer.bindPopup(popupContent + `<br><button onclick="routeToDistrict('${d.name}')">üìå –ü—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç —Å—é–¥–∏</button>`).openPopup();
					}); 
				},
				style: { color: d.color, fillColor: d.fillColor, fillOpacity: 0.4 }
			}).addTo(map);
			control.addOverlay(layer, d.name);
		}) 
		.catch(err => console.error(err)); 
});

// –ú–∞—Ä—à—Ä—É—Ç:
let routeControl = null;
let currentLocation = null;

function routeToDistrict(districtName) {
	if (!currentLocation) return alert("‚õî –°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å üìç ¬´–ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ¬ª"); 
	const layer = Object.keys(control._layers)
		.map(id => control._layers[id].layer)
		.find(l => l?.options?.name === districtName);
	if (!layer) return;

	const coords = [];

	layer.eachLayer(l => {
		coords.push(l.getBounds().getCenter()); 
	}); 
	const nearestPoint = coords.reduce((nearest, c) => currentLocation.distanceTo(c) < currentLocation.distanceTo(nearest) ? c : nearest, coords[0]);

	if (routeControl) map.removeControl(routeControl);
	routeControl = L.Routing.control({ 
		waypoints: [currentLocation, nearestPoint],
		routeWhileDragging: false,
		addWaypoints: false,
		show: false,
		createMarker: () => null
	}).addTo(map);
}

function findLocation(){
	if (!navigator.geolocation) return alert('‚ö† –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é.');

	navigator.geolocation.getCurrentPosition(pos=>{
		currentLocation = L.latLng(pos.coords.latitude, pos.coords.longitude);
		L.marker(currentLocation).addTo(map).bindPopup("–í–∞—à–µ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è").openPopup();

	},err=>{
		alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è');
	},{enableHighAccuracy:true});
}

function toggleLayers(){
	const controlElem = document.querySelector('.leaflet-control-layers'); 
	controlElem?.classList.toggle('leaflet-control-layers-expanded'); 
	const btn = document.querySelector('.layer-toggle'); 
	btn.innerText = controlElem?.classList.contains('leaflet-control-layers-expanded') ? 'üó∫ –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —à–∞—Ä–∏' : 'üó∫ –®–∞—Ä–∏';
}

window.routeToDistrict = routeToDistrict;
window.toggleLayers = toggleLayers;
window.findLocation = findLocation;

</script>

</body>
</html>
