<!DOCTYPE html>
<html lang="uk">
<head>
<meta name="robots" content="noindex, nofollow">
<meta charset="utf-8" />
<title>–ö–∞—Ä—Ç–∞ –¢–µ—Ä–∏—Ç–æ—Ä—ñ–π "–Ü–ª–ª—ñ–Ω—Ü—ñ" –∑ Google Maps</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<style>
html,body,#map {height:100%;margin:0;padding:0;}
button.layer-toggle, button.locate-btn, button.login-btn, button.logout-btn {position:absolute; left:50px; z-index:1000;padding:8px 12px;background:#ffffff;border:1px solid #ccc;border-radius:4px;cursor:pointer;}
button.locate-btn {top:10px;}
button.layer-toggle {top:50px;}
button#showAllBtn {top: 90px;}
button#hideAllBtn {top: 130px;}
button#filter-free {top: 170px;}
button#filter-occupied {top: 210px;}

</style>
</head>
<body>

<button onclick="findLocation()" class="locate-btn">üìç –ü–æ–∫–∞–∑–∞—Ç–∏ –º—ñ—Å—Ü–µ</button>
<button id="showAllBtn" class="layer-toggle">üü£ –ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ</button>
<button id="hideAllBtn" class="layer-toggle">‚ö™ –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ</button>
<button id="filter-free" class="layer-toggle">‚úÖ –í—ñ–ª—å–Ω–æ</button>
<button id="filter-occupied" class="layer-toggle">üöÄ –ù–∞ —Ä—É–∫–∞—Ö</button>

<div id="loader"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDracSUSYz_QrmmDj_HcBfQpJlJ3FjPHpU",
    authDomain: "map-illintsi.firebaseapp.com",
    projectId: "map-illintsi",
    storageBucket: "map-illintsi.appspot.com",
    messagingSenderId: "62267872375",
    appId: "1:62267872375:web:10945d2d63b93bccc5e272"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
onAuthStateChanged(auth, user => {
    currentUser = user;
});

// –¥–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∏–ø–∞–¥–∫–æ–≤–æ–≥–æ –∫–æ–ª—å–æ—Ä—É
function getRandomColor(){
    return '#' + Math.floor(Math.random() * 16777215).toString(16);
}

window.getTerritoryStatusPopup = async (number, name) => {
    if (!currentUser) return `<b>${name}</b><br><i>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å</i>`;
    const q = query(collection(db, `territories/${number}/history`), orderBy("timestamp", "desc"));
    const snap = await getDocs(q);
    let popup = `<b>${name}</b><br>`;
    if (snap.empty) {
        popup += `<b>–°—Ç–∞—Ç—É—Å:</b> –≤—ñ–ª—å–Ω–æ`;
    } else {
        const data = snap.docs[0].data();
        popup += `<b>–°—Ç–∞—Ç—É—Å:</b> ${data.status}<br>`;
        if (data.status === "–Ω–∞ —Ä—É–∫–∞—Ö") {
            popup += `<b>–ü–Ü–ë:</b> ${data.pib}<br>`;
            popup += `<b>–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è:</b> ${new Date(data.dateGet).toLocaleDateString("uk-UA")}`;
        }
    }
    return popup;
};

</script>

<script>
const map = L.map('map').setView([49.1029, 29.2074], 13);
const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {maxZoom:20,subdomains:['mt0','mt1','mt2','mt3'],attribution:'¬© Google Maps'}).addTo(map);
const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:20,attribution:'¬© Esri'});

// –≤—Å—ñ –≤–µ—Ä—Å—Ç–≤–∏ –±—É–¥—É—Ç—å –∑–±–µ—Ä—ñ–≥–∞—Ç–∏—Å—è —Ç—É—Ç:
const overlayMaps = {};

function showLoading(show) {
    document.getElementById('loader').innerText = show ? '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...' : '';
}

function findLocation(){
    if (!navigator.geolocation) return alert('–ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è');
    showLoading(true);
    map.locate({setView:true,maxZoom:16,timeout:20000,enableHighAccuracy:true});
}

let currentLocation = null;
let currentMarker = null;
let currentCircle = null;

map.on('locationfound', e => {
    currentLocation = e.latlng;
    showLoading(false);
    if (currentMarker) map.removeLayer(currentMarker);
    if (currentCircle) map.removeLayer(currentCircle);
    currentCircle = L.circle(e.latlng,{radius:e.accuracy,color:'blue',fillColor:'#30f',fillOpacity:0.2}).addTo(map);
    currentMarker = L.marker(e.latlng).addTo(map).bindPopup("–í–∞—à–µ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è").openPopup();
});

map.on('locationerror', e => {
    showLoading(false);
    alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ.");
});

// –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—Å—ñ —Ä–∞–π–æ–Ω–∏
async function loadDistricts(){
    showLoading(true);
    for (let i = 1; i <= 150; i++) {
        let color = getRandomColor();
        let d = { id:'district'+i, name:'–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è '+i, color:color, fillColor:color };
        let res = await fetch(`${d.id}.json`).then(r=>r.json()).catch(err=>{return null;});
        if (res) {
            let layer = L.layerGroup();

            let geo = L.geoJSON(res,{ 
                onEachFeature: (feature, layerG) => {
                    layerG.on('click', async () => {
                        const popupContent = await window.getTerritoryStatusPopup(i.toString(), d.name);
                        layerG.bindPopup(popupContent + "<br><button onclick=\"routeToDistrict('" + d.name + "')\">üìå –ü—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç —Å—é–¥–∏</button>").openPopup();
                    })
                },
                style:{ color:d.color, fillColor:d.fillColor, fillOpacity: 0.4 }
            }).addTo(layer);
            overlayMaps[d.name] = layer;
            layer.addTo(map);
        }
    }
    showLoading(false);
    L.control.layers({"–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –∫–∞—Ä—Ç–∞":googleStreets,"–°—É–ø—É—Ç–Ω–∏–∫–æ–≤–∞ –∫–∞—Ä—Ç–∞":satellite},overlayMaps,{collapsed:true}).addTo(map);
}

loadDistricts();

function routeToDistrict(districtName) {
    if (!currentLocation) return alert("–°–ø–æ—á–∞—Ç–∫—É –≤–∏–∑–Ω–∞—á—ñ—Ç—å –º—ñ—Å—Ü–µ.");
    // –¢—É—Ç –≤–∏ –º–æ–∂–µ—Ç–µ –ø—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç, –∞–Ω–∞–ª–æ–≥—á–Ω–æ —Ç–æ–º—É —â–æ –±—É–ª–æ —Ä–∞–Ω—ñ—à–µ
}

document.getElementById('showAllBtn').addEventListener('click', () => {
    Object.keys(overlayMaps).forEach(key=>{
        if (!map.hasLayer(overlayMaps[key])) {
            map.addLayer(overlayMaps[key]);
        }
    })
});

document.getElementById('hideAllBtn').addEventListener('click', () => {
    Object.keys(overlayMaps).forEach(key=>{
        if (map.hasLayer(overlayMaps[key])) {
            map.removeLayer(overlayMaps[key]);
        }
    })
});

// –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –ø–æ —Å—Ç–∞—Ç—É—Å—É
async function filterDistrictsByStatus(status) {
    for (const key in overlayMaps) {
        const id = key.split(' ').pop();
        const popupContent = await window.getTerritoryStatusPopup(id, key);
        if (popupContent.indexOf(status) !== -1) {
            if (!map.hasLayer(overlayMaps[key])) {
                map.addLayer(overlayMaps[key]);
            }
        } else {
            if (map.hasLayer(overlayMaps[key])) {
                map.removeLayer(overlayMaps[key]);
            }
        }
    }
}

document.getElementById('filter-free').addEventListener('click', () => filterDistrictsByStatus('–≤—ñ–ª—å–Ω–æ'));

document.getElementById('filter-occupied').addEventListener('click', () => filterDistrictsByStatus('–Ω–∞ —Ä—É–∫–∞—Ö'));

</script>

</body>
</html>
