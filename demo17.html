<!DOCTYPE html>
<html lang="uk">
<head>
  <meta name="robots" content="noindex, nofollow">
  <meta charset="utf-8" />
  <title>Карта Територій "Іллінці"</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    /* Button Group */
    .button-group {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .action-btn {
      background: linear-gradient(to right, #3b82f6, #2563eb);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s, background 0.3s;
    }
    .action-btn:hover {
      background: linear-gradient(to right, #2563eb, #1e40af);
      transform: scale(1.05);
    }
    /* Sidebar for Checkboxes */
    .sidebar {
      position: fixed;
      top: 0;
      left: -300px;
      width: 300px;
      height: 100%;
      background: white;
      z-index: 2000;
      transition: left 0.3s ease;
      padding: 16px;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.2);
      overflow-y: auto;
    }
    .sidebar.open { left: 0; }
    .sidebar-toggle {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1001;
      background: linear-gradient(to right, #10b981, #059669);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s, background 0.3s;
    }
    .sidebar-toggle:hover {
      background: linear-gradient(to right, #059669, #047857);
      transform: scale(1.05);
    }
    .controls label {
      font-size: 14px;
      font-weight: 500;
      color: #1f2937;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .controls input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #3b82f6;
    }
    .subgroup { margin-left: 16px; }
    /* Loader */
    #loader {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 8px 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      font-size: 14px;
      color: #1f2937;
    }
    /* Progress Overlay */
    #progress-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    #progress-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      text-align: center;
      width: 80%;
      max-width: 300px;
    }
    #progress-bar {
      width: 100%;
      height: 20px;
      background: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
    }
    #progress-fill {
      height: 100%;
      background: linear-gradient(to right, #3b82f6, #2563eb);
      width: 0;
      transition: width 0.3s ease;
    }
    #progress-text {
      margin-top: 8px;
      font-size: 14px;
      color: #1f2937;
    }
    /* Popup Styling */
    .leaflet-popup-content-wrapper {
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .leaflet-popup-content {
      font-size: 14px;
      color: #1f2937;
      padding: 12px;
    }
    .leaflet-popup-content b {
      color: #3b82f6;
    }
    .leaflet-popup-content button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      margin-top: 8px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
    }
    .leaflet-popup-content button.share-btn {
      background: linear-gradient(to right, #10b981, #059669);
    }
    .leaflet-popup-content button.share-btn:hover {
      background: linear-gradient(to right, #059669, #047857);
    }
    .leaflet-popup-content button.edit-btn {
      background: linear-gradient(to right, #f59e0b, #d97706);
    }
    .leaflet-popup-content button.edit-btn:hover {
      background: linear-gradient(to right, #d97706, #b45309);
    }
    .leaflet-popup-content button.route-btn {
      background: linear-gradient(to right, #3b82f6, #2563eb);
    }
    .leaflet-popup-content button.route-btn:hover {
      background: linear-gradient(to right, #2563eb, #1e40af);
    }
    /* Mobile Adjustments */
    @media (max-width: 640px) {
      .button-group { gap: 6px; }
      .action-btn, .sidebar-toggle {
        padding: 6px 12px;
        font-size: 12px;
      }
      .sidebar { width: 250px; padding: 12px; }
      .controls label { font-size: 12px; }
      #loader { font-size: 12px; padding: 6px 12px; }
      #progress-container { padding: 16px; }
    }
  </style>
</head>
<body>
  <!-- Progress Overlay -->
  <div id="progress-overlay" class="flex">
    <div id="progress-container">
      <h2 class="text-lg font-semibold mb-2">Завантаження територій...</h2>
      <div id="progress-bar"><div id="progress-fill"></div></div>
      <p id="progress-text" class="mt-2 text-sm">0%</p>
    </div>
  </div>

  <!-- Button Group -->
  <div class="button-group">
    <button onclick="findLocation()" class="action-btn locate-btn">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
      Моє місцезнаходження
    </button>
    <div id="auth-buttons">
      <a href="enter.html"><button class="action-btn login-btn" style="display:none">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path></svg>
        Увійти
      </button></a>
      <button class="action-btn logout-btn" style="display:none">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path></svg>
        Вийти
      </button>
      <a href="territories.html"><button class="action-btn territories-btn" style="display:none">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
        Території
      </button></a>
    </div>
  </div>

  <!-- Sidebar Toggle Button -->
  <button class="sidebar-toggle" onclick="toggleSidebar()">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
    Фільтри
  </button>

  <!-- Sidebar for Checkboxes -->
  <div class="sidebar" id="sidebar">
    <h2 class="text-lg font-semibold mb-4">Фільтри територій</h2>
    <div class="controls">
      <label for="toggleAll" class="mb-2">
        <input type="checkbox" id="toggleAll" checked>
        <span id="toggleAllLabel">Показати всі</span> <span id="total-count" class="text-xs text-gray-500">(0)</span>
      </label><br>
      <div id="taken-control" style="display: none">
        <label for="showTaken" class="mb-2">
          <input type="checkbox" id="showTaken">
          На руках <span id="taken-count" class="text-xs text-gray-500">(0)</span>
        </label><br>
        <div class="subgroup">
          <label for="taken_Poverkhivky" class="mb-1">
            <input type="checkbox" id="taken_Poverkhivky" checked>
            Поверхівки <span id="taken_Poverkhivky-count" class="text-xs text-gray-500">(0)</span>
          </label><br>
          <label for="taken_Pryvatni" class="mb-1">
            <input type="checkbox" id="taken_Pryvatni" checked>
            Приватні <span id="taken_Pryvatni-count" class="text-xs text-gray-500">(0)</span>
          </label><br>
          <label for="taken_Dilovi" class="mb-1">
            <input type="checkbox" id="taken_Dilovi" checked>
            Ділові <span id="taken_Dilovi-count" class="text-xs text-gray-500">(0)</span>
          </label><br>
        </div>
      </div>
      <div id="free-control" style="display: none">
        <label for="showFree" class="mb-2">
          <input type="checkbox" id="showFree">
          Вільно <span id="free-count" class="text-xs text-gray-500">(0)</span>
        </label><br>
        <div class="subgroup">
          <label for="free_Poverkhivky" class="mb-1">
            <input type="checkbox" id="free_Poverkhivky" checked>
            Поверхівки <span id="free_Poverkhivky-count" class="text-xs text-gray-500">(0)</span>
          </label><br>
          <label for="free_Pryvatni" class="mb-1">
            <input type="checkbox" id="free_Pryvatni" checked>
            Приватні <span id="free_Pryvatni-count" class="text-xs text-gray-500">(0)</span>
          </label><br>
          <label for="free_Dilovi" class="mb-1">
            <input type="checkbox" id="free_Dilovi" checked>
            Ділові <span id="free_Dilovi-count" class="text-xs text-gray-500">(0)</span>
          </label><br>
        </div>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <div id="loader"></div>

  <!-- Map -->
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>

  <script type="module">
    // Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, getDocs, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDracSUSYz_QrmmDj_HcBfQpJlJ3FjPHpU",
      authDomain: "map-illintsi.firebaseapp.com",
      projectId: "map-illintsi",
      storageBucket: "map-illintsi.appspot.com",
      messagingSenderId: "62267872375",
      appId: "1:62267872375:web:10945d2d63b93bccc5e272"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;

    // DOM refs
    const loginBtn = document.querySelector('.login-btn');
    const logoutBtn = document.querySelector('.logout-btn');
    const territoriesBtn = document.querySelector('.territories-btn');
    const takenControl = document.getElementById('taken-control');
    const freeControl = document.getElementById('free-control');
    const sidebar = document.getElementById('sidebar');

    // Sidebar toggle function
    window.toggleSidebar = function() {
      sidebar.classList.toggle('open');
    };

    // Map
    const map = L.map('map', { zoomControl: false }).setView([49.1029, 29.2074], 13);

    const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
      maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3'], attribution: '© Google Maps'
    }).addTo(map);

    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '© Esri', maxZoom: 20
    });

    // Districts list
    const districts = [
      { id: 'district1', name: 'Територія 1', color: 'blue', fillColor: '#add8e6' },
      { id: 'district2', name: 'Територія 2', color: 'green', fillColor: '#90ee90' },
      // ... (rest of the districts list remains unchanged)
      { id: 'district102', name: 'Територія 102', color: 'green', fillColor: '#90ee90' }
    ];

    // Working structures
    const districtCenters = [];
    const districtGeometries = [];
    const overlayMaps = {};
    const territoryStatuses = {};
    const territoryTypes = {};
    let layersControl = null;
    const loadedLayers = [];
    const subTypes = ['Poverkhivky', 'Pryvatni', 'Dilovi'];
    const typeMap = {
      'Поверхівка': 'Poverkhivky',
      'Поверхівки': 'Poverkhivky',
      'Приватна': 'Pryvatni',
      'Приватні': 'Pryvatni',
      'Ділова': 'Dilovi',
      'Ділові': 'Dilovi'
    };

    // URL parameter handling
    const urlParams = new URLSearchParams(window.location.search);
    let rawTarget = urlParams.get("territory");
    let targetId = null;
    if (rawTarget) {
      if (rawTarget.startsWith('district')) targetId = rawTarget;
      else targetId = `district${rawTarget}`;
    }

    // Normalize districts
    districts.sort((a, b) => {
      const na = parseInt(a.id.replace('district', ''), 10);
      const nb = parseInt(b.id.replace('district', ''), 10);
      return na - nb;
    });

    // UI helpers
    function showLoadingText(txt) { document.getElementById('loader').innerText = txt || ''; }
    function updateProgress(percentage) {
      const progressOverlay = document.getElementById('progress-overlay');
      const progressFill = document.getElementById('progress-fill');
      const progressText = document.getElementById('progress-text');
      if (percentage < 100) {
        progressOverlay.style.display = 'flex';
        progressFill.style.width = `${percentage}%`;
        progressText.innerText = `${Math.round(percentage)}%`;
      } else {
        progressOverlay.style.display = 'none';
        progressFill.style.width = `100%`;
        progressText.innerText = `100%`;
      }
    }

    // Authentication
    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (user) {
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'flex';
        territoriesBtn.style.display = 'flex';
        takenControl.style.display = 'block';
        freeControl.style.display = 'block';
        updateTerritoryStatuses();
      } else {
        loginBtn.style.display = 'flex';
        logoutBtn.style.display = 'none';
        territoriesBtn.style.display = 'none';
        takenControl.style.display = 'block';
        freeControl.style.display = 'block';
        Object.keys(territoryStatuses).forEach(id => territoryStatuses[id] = "вільно");
        updateTerritoriesDisplay();
      }
    });

    logoutBtn?.addEventListener("click", async () => {
      await signOut(auth);
      layersControl = null;
      location.reload();
    });

    // Get popup content
    async function getTerritoryStatusPopup(number, name) {
      try {
        const q = query(collection(db, `territories/${number}/history`), orderBy("timestamp", "desc"));
        const snap = await getDocs(q);
        let popup = `<b>${name}</b><br>`;
        if (snap.empty) {
          popup += `<b>Статус:</b> вільно`;
        } else {
          const latest = snap.docs[0].data();
          const status = latest.status === "на руках" ? "на руках" : "вільно";
          popup += `<b>Статус:</b> ${status}`;
          if (currentUser && status === "на руках") {
            popup += `<br><b>ПІБ:</b> ${latest.pib || "невідомо"}`;
            popup += `<br><b>Дата отримання:</b> ${latest.dateGet ? new Date(latest.dateGet).toLocaleDateString("uk-UA") : "невідомо"}`;
          }
        }
        popup += `<br><button class="share-btn" onclick="shareTerritory('${number}')"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>Поділитися</button>`;
        if (currentUser) {
          popup += `<br><a href="territory-detail.html?number=${number}"><button class="edit-btn"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>Редагувати</button></a>`;
        }
        return popup;
      } catch (err) {
        console.warn('getTerritoryStatusPopup error', err);
        return `<b>${name}</b><br><b>Статус:</b> невідомий`;
      }
    }

    // Update territory statuses
    function updateTerritoryStatuses() {
      districts.forEach(d => {
        try {
          const idNum = d.id.replace('district', '');
          const q = query(collection(db, `territories/${idNum}/history`), orderBy("timestamp", "desc"));
          onSnapshot(q, snap => {
            if (!snap || snap.empty) territoryStatuses[d.id] = "вільно";
            else {
              const latest = snap.docs[0].data();
              territoryStatuses[d.id] = latest.status === "на руках" ? "на руках" : "вільно";
            }
            updateTerritoriesDisplay();
          }, err => {
            console.warn(`Помилка onSnapshot для ${d.id}:`, err);
            territoryStatuses[d.id] = "вільно";
            updateTerritoriesDisplay();
          });
        } catch (e) {
          console.warn('updateTerritoryStatuses catch', e);
        }
      });
    }

    // Load districts and create layers
    (async () => {
      showLoadingText('Завантаження територій...');
      updateProgress(0);
      let loadedCount = 0;
      const totalDistricts = districts.length;

      try {
        const res = await fetch('all_districts.json');
        if (!res.ok) throw new Error(`Не вдалося завантажити all_districts.json: ${res.status}`);
        const data = await res.json();

        data.features.forEach((feature) => {
          const d = districts.find(x => x.id === feature.id);
          if (!d) {
            console.warn(`Не знайдено опису для feature.id=${feature.id}`);
            loadedCount++;
            updateProgress((loadedCount/totalDistricts)*100);
            return;
          }

          const layerGroup = L.layerGroup();
          const geoJsonLayer = L.geoJSON(feature, {
            style: { color: d.color, fillColor: d.fillColor, fillOpacity: 0.4 },
            onEachFeature: (feat, lyr) => {
              const center = lyr.getBounds().getCenter();
              districtCenters.push({ id: d.id, name: feat.properties?.name || d.name, latlng: center });
              lyr.on('click', async () => {
                const idNum = d.id.replace('district', '');
                const popupContent = await getTerritoryStatusPopup(idNum, d.name);
                lyr.bindPopup(popupContent + `<br><button class="route-btn" onclick="routeToDistrict('${d.name}')"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>Прокласти маршрут</button>`).openPopup();
              });
            }
          });

          geoJsonLayer.addTo(layerGroup);
          loadedLayers.push({ id: d.id, name: d.name, layerGroup, geoJsonLayer });
          overlayMaps[d.name] = layerGroup;
          territoryStatuses[d.id] = "вільно";

          if (!targetId) {
            map.addLayer(layerGroup);
          } else {
            if (d.id === targetId) {
              map.addLayer(layerGroup);
              const bounds = geoJsonLayer.getBounds();
              if (bounds && bounds.isValid && bounds.isValid()) map.fitBounds(bounds.pad(0.15));
              (async () => {
                const idNum = d.id.replace('district', '');
                const popupContent = await getTerritoryStatusPopup(idNum, d.name);
                geoJsonLayer.eachLayer(sub => sub.bindPopup(popupContent + `<br><button class="route-btn" onclick="routeToDistrict('${d.name}')"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>Прокласти маршрут</button>`).openPopup());
              })();
            }
          }

          const coordinates = [];
          const geometries = feature.geometry.type === "GeometryCollection" ? feature.geometry.geometries : [feature.geometry];
          geometries.forEach(geom => {
            const coords = geom.coordinates;
            const pushCoords = ring => ring.forEach(c => coordinates.push(L.latLng(c[1], c[0])));
            if (geom.type === "Polygon") coords.forEach(pushCoords);
            if (geom.type === "MultiPolygon") coords.forEach(polygon => polygon.forEach(pushCoords));
          });
          districtGeometries.push({ id: d.id, name: d.name, coordinates });

          loadedCount++;
          updateProgress((loadedCount / totalDistricts) * 100);
        });

        const typePromises = districts.map(async (d) => {
          const idNum = d.id.replace('district', '');
          const docRef = doc(db, 'territories', idNum);
          const snap = await getDoc(docRef);
          if (snap.exists()) {
            const dbType = snap.data().type || 'невідомо';
            territoryTypes[d.id] = typeMap[dbType] || 'невідомо';
          } else {
            territoryTypes[d.id] = 'невідомо';
          }
        });
        await Promise.all(typePromises);

      } catch (err) {
        console.warn('Помилка при завантаженні all_districts.json:', err);
      }

      showLoadingText('');
      tryAddLayersControl();
      updateTerritoriesDisplay();
      updateTerritoryStatuses();
    })();

    // Navigation / Geolocation
    let currentMarker = null, currentCircle = null, routeControl = null, currentLocation = null;
    function findLocation() {
      if (!navigator.geolocation) { alert('⚠ Ваш браузер не підтримує геолокацію.'); return; }
      showLoadingText('Визначення місцезнаходження...');
      navigator.geolocation.getCurrentPosition(position => {
        const latlng = L.latLng(position.coords.latitude, position.coords.longitude);
        currentLocation = latlng;
        showLoadingText('');
        if (currentMarker) map.removeLayer(currentMarker);
        if (currentCircle) map.removeLayer(currentCircle);
        currentCircle = L.circle(latlng, { radius: position.coords.accuracy, color: 'blue', fillColor: '#30f', fillOpacity: 0.2 }).addTo(map);
        currentMarker = L.marker(latlng).addTo(map).bindPopup(`Ваше місцерозташування (точність ${Math.round(position.coords.accuracy)} м)`).openPopup();
        map.setView(latlng, 16);
      }, error => {
        showLoadingText('');
        console.error("Geolocation error:", error.message);
        alert(`⚠ Не вдалося визначити місцерозташування: ${error.message}`);
      }, { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 });
    }

    function routeToDistrict(districtName) {
      if (!currentLocation) { alert("⛔ Спочатку натисніть «Моє місцезнаходження»"); return; }
      const district = districtGeometries.find(d => d.name === districtName);
      if (!district || !district.coordinates.length) { alert(`⚠ Немає координат для ${districtName}`); return; }
      let nearestPoint = district.coordinates.reduce((nearest, coord) => {
        const distance = currentLocation.distanceTo(coord);
        return distance < currentLocation.distanceTo(nearest) ? coord : nearest;
      }, district.coordinates[0]);
      if (routeControl) map.removeControl(routeControl);
      routeControl = L.Routing.control({
        waypoints: [currentLocation, nearestPoint],
        routeWhileDragging: false,
        addWaypoints: false,
        show: true,
        createMarker: () => null,
        router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' })
      }).on('routesfound', function(e) {
        const dist = e.routes[0].summary.totalDistance;
        const distText = dist > 1000 ? (dist/1000).toFixed(2) + " км" : Math.round(dist) + " м";
        currentMarker?.bindPopup(`Ваше місцерозташування<br>Маршрут до <b>${districtName}</b><br>Відстань: ${distText}`).openPopup();
      }).on('routingerror', function(e) {
        console.error("Routing error:", e.error);
        alert(`⚠ Не вдалося прокласти маршрут: ${e.error?.message || 'помилка'}`);
      }).addTo(map);
    }

    window.findLocation = findLocation;
    window.routeToDistrict = routeToDistrict;

    window.shareTerritory = function(number) {
      const url = `${window.location.origin}${window.location.pathname}?territory=${number}`;
      const title = `Карта: Територія №${number}`;
      if (navigator.share) {
        navigator.share({ title, text: `Територія: №${number}`, url }).catch(err => {
          console.warn('share failed', err);
          try { navigator.clipboard.writeText(url); alert('Посилання скопійовано в буфер'); } catch(e) { prompt('Посилання на територію:', url); }
        });
      } else {
        try {
          navigator.clipboard.writeText(url);
          alert('Посилання скопійовано в буфер обміну');
        } catch(e) {
          prompt('Посилання на територію:', url);
        }
      }
    };

    function updateTerritoriesDisplay() {
      const toggleAllCheckbox = document.getElementById('toggleAll');
      const totalCountSpan = document.getElementById('total-count');
      const takenCountSpan = document.getElementById('taken-count');
      const freeCountSpan = document.getElementById('free-count');

      const toggleAll = toggleAllCheckbox?.checked ?? true;

      const totalCount = districts.length;
      let takenCount = 0;
      let freeCount = 0;
      const takenSubCounts = {};
      const freeSubCounts = {};
      subTypes.forEach(t => { takenSubCounts[t] = 0; freeSubCounts[t] = 0; });

      Object.keys(territoryStatuses).forEach(id => {
        const status = territoryStatuses[id];
        const typeKey = territoryTypes[id];
        if (status === "на руках") {
          takenCount++;
          if (subTypes.includes(typeKey)) takenSubCounts[typeKey]++;
        } else {
          freeCount++;
          if (subTypes.includes(typeKey)) freeSubCounts[typeKey]++;
        }
      });

      if (totalCountSpan) totalCountSpan.textContent = `(${totalCount})`;
      if (takenCountSpan) takenCountSpan.textContent = `(${takenCount})`;
      if (freeCountSpan) freeCountSpan.textContent = `(${freeCount})`;

      subTypes.forEach(t => {
        const takenSubSpan = document.getElementById(`taken_${t}-count`);
        const freeSubSpan = document.getElementById(`free_${t}-count`);
        if (takenSubSpan) takenSubSpan.textContent = `(${takenSubCounts[t]})`;
        if (freeSubSpan) freeSubSpan.textContent = `(${freeSubCounts[t]})`;
      });

      if (targetId) {
        loadedLayers.forEach(item => {
          if (item.id === targetId) {
            if (!map.hasLayer(item.layerGroup)) map.addLayer(item.layerGroup);
          } else {
            if (map.hasLayer(item.layerGroup)) map.removeLayer(item.layerGroup);
          }
        });
        return;
      }

      loadedLayers.forEach(({ id, layerGroup }) => {
        const status = territoryStatuses[id] || "вільно";
        const typeKey = territoryTypes[id];
        let shouldShow = false;

        if (toggleAll) {
          shouldShow = true;
        } else {
          if (status === "на руках" && subTypes.includes(typeKey) && document.getElementById(`taken_${typeKey}`).checked) {
            shouldShow = true;
          } else if (status === "вільно" && subTypes.includes(typeKey) && document.getElementById(`free_${typeKey}`).checked) {
            shouldShow = true;
          }
        }

        if (shouldShow) {
          if (!map.hasLayer(layerGroup)) map.addLayer(layerGroup);
        } else {
          if (map.hasLayer(layerGroup)) map.removeLayer(layerGroup);
        }
      });
    }

    function updateParentState(statusPrefix) {
      const parentCheckbox = document.getElementById(`show${statusPrefix.charAt(0).toUpperCase() + statusPrefix.slice(1)}`);
      const subCheckboxes = subTypes.map(t => document.getElementById(`${statusPrefix}_${t}`));
      const checkedSubs = subCheckboxes.filter(cb => cb.checked).length;

      if (checkedSubs === subTypes.length) {
        parentCheckbox.checked = true;
        parentCheckbox.indeterminate = false;
      } else if (checkedSubs === 0) {
        parentCheckbox.checked = false;
        parentCheckbox.indeterminate = false;
      } else {
        parentCheckbox.checked = false;
        parentCheckbox.indeterminate = true;
      }
    }

    function tryAddLayersControl() {
      if (layersControl) return;
      const sortedOverlayMaps = {};
      loadedLayers.forEach(({ name, layerGroup }) => { sortedOverlayMaps[name] = layerGroup; });

      layersControl = L.control.layers({ "Стандартна карта": googleStreets, "Супутникова карта": satellite }, sortedOverlayMaps, { collapsed: true }).addTo(map);

      const toggleAllCheckbox = document.getElementById('toggleAll');
      const toggleAllLabel = document.getElementById('toggleAllLabel');
      const showTakenCheckbox = document.getElementById('showTaken');
      const showFreeCheckbox = document.getElementById('showFree');

      toggleAllCheckbox.checked = !targetId;
      toggleAllLabel.innerText = toggleAllCheckbox.checked ? 'Приховати всіх' : 'Показати всіх';

      if (showTakenCheckbox) showTakenCheckbox.checked = false;
      if (showFreeCheckbox) showFreeCheckbox.checked = false;
      subTypes.forEach(t => {
        const takenSub = document.getElementById(`taken_${t}`);
        const freeSub = document.getElementById(`free_${t}`);
        if (takenSub) takenSub.checked = false;
        if (freeSub) freeSub.checked = false;
      });

      toggleAllCheckbox.addEventListener('change', function() {
        toggleAllLabel.innerText = this.checked ? 'Приховати всіх' : 'Показати всіх';
        if (targetId) targetId = null;
        if (this.checked) {
          showTakenCheckbox.checked = false;
          showFreeCheckbox.checked = false;
          subTypes.forEach(t => {
            document.getElementById(`taken_${t}`).checked = false;
            document.getElementById(`free_${t}`).checked = false;
          });
          updateParentState('taken');
          updateParentState('free');
        } else {
          showTakenCheckbox.checked = false;
          showFreeCheckbox.checked = false;
          subTypes.forEach(t => {
            document.getElementById(`taken_${t}`).checked = false;
            document.getElementById(`free_${t}`).checked = false;
          });
          updateParentState('taken');
          updateParentState('free');
        }
        updateTerritoriesDisplay();
      });

      if (showTakenCheckbox) {
        showTakenCheckbox.addEventListener('change', () => {
          toggleAllCheckbox.checked = false;
          toggleAllLabel.innerText = 'Показати всіх';
          subTypes.forEach(t => {
            const subCheckbox = document.getElementById(`taken_${t}`);
            if (subCheckbox) subCheckbox.checked = showTakenCheckbox.checked;
          });
          if (targetId) targetId = null;
          updateTerritoriesDisplay();
          updateParentState('taken');
        });
      }

      if (showFreeCheckbox) {
        showFreeCheckbox.addEventListener('change', () => {
          toggleAllCheckbox.checked = false;
          toggleAllLabel.innerText = 'Показати всіх';
          subTypes.forEach(t => {
            const subCheckbox = document.getElementById(`free_${t}`);
            if (subCheckbox) subCheckbox.checked = showFreeCheckbox.checked;
          });
          if (targetId) targetId = null;
          updateTerritoriesDisplay();
          updateParentState('free');
        });
      }

      subTypes.forEach(t => {
        const takenSub = document.getElementById(`taken_${t}`);
        const freeSub = document.getElementById(`free_${t}`);
        if (takenSub) {
          takenSub.addEventListener('change', () => {
            toggleAllCheckbox.checked = false;
            toggleAllLabel.innerText = 'Показати всіх';
            if (targetId) targetId = null;
            updateTerritoriesDisplay();
            updateParentState('taken');
          });
        }
        if (freeSub) {
          freeSub.addEventListener('change', () => {
            toggleAllCheckbox.checked = false;
            toggleAllLabel.innerText = 'Показати всіх';
            if (targetId) targetId = null;
            updateTerritoriesDisplay();
            updateParentState('free');
          });
        }
      });

      updateParentState('taken');
      updateParentState('free');
      updateTerritoriesDisplay();
    }
  </script>
</body>
</html>
