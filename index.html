<!DOCTYPE html>
<html lang="uk">
<head>
  <meta name="robots" content="noindex, nofollow">
  <meta charset="utf-8" />
  <title>–ö–∞—Ä—Ç–∞ –¢–µ—Ä–∏—Ç–æ—Ä—ñ–π "–Ü–ª–ª—ñ–Ω—Ü—ñ" –∑ Google Maps</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    button.layer-toggle, button.locate-btn {
      position: absolute;
      left: 50px;
      z-index: 1000;
      padding: 8px 12px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }
    button.locate-btn {
      top: 10px;
    }
    button.layer-toggle {
      top: 50px;
    }
    #loader {
      position: absolute;
      top: 10px;
      left: 215px;
      z-index: 1000;
      padding: 8px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
  </style>
</head>
<body>
<button onclick="findLocation()" class="locate-btn">üìç –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ</button>
<button onclick="toggleLayers()" class="layer-toggle">üóö –®–∞—Ä–∏</button>
<div id="loader"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import {
    getFirestore,
    collection, query, orderBy, getDocs,
    doc, getDoc
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDracSUSYz_QrmmDj_HcBfQpJlJ3FjPHpU",
    authDomain: "map-illintsi.firebaseapp.com",
    projectId: "map-illintsi",
    storageBucket: "map-illintsi.appspot.com",
    messagingSenderId: "62267872375",
    appId: "1:62267872375:web:10945d2d63b93bccc5e272"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
    }
  });

  async function fetchTerritoryStatus(number) {
    try {
      const colRef = collection(db, `territories/${number}/history`);
      const q = query(colRef, orderBy("timestamp", "desc"));
      const snap = await getDocs(q);
      const latest = snap.docs[0]?.data();
      if (!latest || latest.status !== "–Ω–∞ —Ä—É–∫–∞—Ö") {
        return "–°—Ç–∞—Ç—É—Å: –≤—ñ–ª—å–Ω–æ";
      }
      const userSnap = await getDoc(doc(db, "users", latest.user));
      const pib = userSnap.exists() ? userSnap.data().name : "–ù–µ–≤—ñ–¥–æ–º–æ";
      const date = latest.dateGet ? new Date(latest.dateGet).toLocaleDateString("uk-UA") : "-";
      return `–°—Ç–∞—Ç—É—Å: <b>–Ω–∞ —Ä—É–∫–∞—Ö</b><br>–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è: ${date}<br>–ü–Ü–ë: ${pib}`;
    } catch (e) {
      console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–∞—Ç—É—Å—É:", e);
      return "‚ö† –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å.";
    }
  }

  window.createDistrictPopup = (name, latlng) => {
    const number = name.match(/\d+/)?.[0];
    let html = `<b>${name}</b><br><button onclick="routeToDistrict('${name}')">üìå –ü—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç</button>`;
    if (currentUser && number) {
      html += `<br><span id="status-${number}">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É...</span>`;
      setTimeout(async () => {
        const statusText = await fetchTerritoryStatus(number);
        const el = document.getElementById(`status-${number}`);
        if (el) el.innerHTML = statusText;
      }, 100);
    }
    return html;
  };
</script>
<script>
  const map = L.map('map').setView([49.1029, 29.2074], 13);
  const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
    attribution: '¬© Google Maps'
  }).addTo(map);
  const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: '¬© Esri',
    maxZoom: 20
  });
  const districts = [
    { id: 'district1', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 1', color: 'blue', fillColor: '#99ccff' },
    { id: 'district2', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 2', color: 'green', fillColor: '#b6fcb6' },
    { id: 'district55', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 55', color: 'green', fillColor: '#b6fcb6' },
    { id: 'district56', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 56', color: 'green', fillColor: '#b6fcb6' }
  ];
  const districtCenters = [], districtGeometries = [], overlayMaps = {};

  function showLoading(show) {
    let loader = document.getElementById('loader');
    loader.innerText = show ? '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...' : '';
  }

  districts.forEach(d => {
    const layer = L.layerGroup();
    showLoading(true);
    fetch(`${d.id}.json`)
      .then(res => res.json())
      .then(data => {
        const geoJsonLayer = L.geoJSON(data, {
          onEachFeature: (feature, layer) => {
            const center = layer.getBounds().getCenter();
            districtCenters.push({ name: feature.properties?.name || d.name, latlng: center });
            layer.bindPopup(createDistrictPopup(feature.properties?.name || d.name, center));
          },
          style: { color: d.color, fillColor: d.fillColor, fillOpacity: 0.4 }
        }).addTo(layer);

        const coordinates = [];
        if (data.type === "GeometryCollection") {
          data.geometries.forEach(geom => {
            if (geom.type === "Polygon" || geom.type === "MultiPolygon") {
              const coords = geom.coordinates;
              if (geom.type === "Polygon") {
                coords.forEach(ring => coordinates.push(...ring.map(c => L.latLng(c[1], c[0]))));
              } else {
                coords.forEach(polygon => polygon.forEach(ring => coordinates.push(...ring.map(c => L.latLng(c[1], c[0])))));
              }
            }
          });
        }
        districtGeometries.push({ name: d.name, coordinates });
        showLoading(false);
      })
      .catch(err => {
        alert(`‚ö† –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –¥–ª—è ${d.name}`);
        showLoading(false);
      });
    overlayMaps[d.name] = layer;
  });

  const baseMaps = {"–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –∫–∞—Ä—Ç–∞": googleStreets,"–°—É–ø—É—Ç–Ω–∏–∫–æ–≤–∞ –∫–∞—Ä—Ç–∞": satellite};
  L.control.layers(baseMaps, overlayMaps, { collapsed: true }).addTo(map);

  function toggleLayers() {
    const control = document.querySelector('.leaflet-control-layers');
    control.classList.toggle('leaflet-control-layers-expanded');
    const btn = document.querySelector('.layer-toggle');
    btn.innerText = control.classList.contains('leaflet-control-layers-expanded') ? 'üó∫ –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —à–∞—Ä–∏' : 'üó∫ –ü–æ–∫–∞–∑–∞—Ç–∏ —à–∞—Ä–∏';
  }

  let currentMarker = null, currentCircle = null, routeControl = null, currentLocation = null;
  function findLocation() {
    if (!navigator.geolocation) return alert('‚ö† –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é.');
    showLoading(true);
    map.locate({setView: true, maxZoom: 16, timeout: 20000, enableHighAccuracy: true});
  }
  map.on('locationfound', function (e) {
    currentLocation = e.latlng;
    showLoading(false);
    if (currentMarker) map.removeLayer(currentMarker);
    if (currentCircle) map.removeLayer(currentCircle);
    currentCircle = L.circle(e.latlng, {radius: e.accuracy, color: 'blue', fillColor: '#30f', fillOpacity: 0.2}).addTo(map);
    currentMarker = L.marker(e.latlng).addTo(map)
      .bindPopup("–í–∞—à–µ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è (—Ç–æ—á–Ω—ñ—Å—Ç—å " + Math.round(e.accuracy) + " –º)").openPopup();
  });
  map.on('locationerror', function (e) {
    showLoading(false);
    alert("‚ö† –ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è: " + e.message);
  });

  function routeToDistrict(districtName) {
    if (!currentLocation) return alert("‚õî –°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É üìç ¬´–ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ¬ª");
    const district = districtGeometries.find(d => d.name === districtName);
    if (!district || !district.coordinates.length) return alert(`‚ö† –ù–µ–º–∞—î –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è ${districtName}`);
    let nearestPoint = district.coordinates[0];
    let minDist = currentLocation.distanceTo(nearestPoint);
    district.coordinates.forEach(coord => {
      const dist = currentLocation.distanceTo(coord);
      if (dist < minDist) {minDist = dist; nearestPoint = coord;}
    });
    if (routeControl) map.removeControl(routeControl);
    routeControl = L.Routing.control({waypoints: [currentLocation, nearestPoint],routeWhileDragging: false,addWaypoints: false,show: false,createMarker: () => null}).addTo(map);
    const distText = minDist > 1000 ? (minDist / 1000).toFixed(2) + " –∫–º" : Math.round(minDist) + " –º";
    currentMarker?.bindPopup(`–í–∞—à–µ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è<br>–ú–∞—Ä—à—Ä—É—Ç –¥–æ <b>${districtName}</b><br>–í—ñ–¥—Å—Ç–∞–Ω—å: ${distText}`).openPopup();
  }
</script>
</body>
</html>
