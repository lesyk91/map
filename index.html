<!DOCTYPE html>
<html lang="uk">
<head>
  <meta name="robots" content="noindex, nofollow">
  <meta charset="utf-8" />
  <title>–ö–∞—Ä—Ç–∞ –¢–µ—Ä–∏—Ç–æ—Ä—ñ–π "–Ü–ª–ª—ñ–Ω—Ü—ñ" –∑ Google Maps</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    button.layer-toggle, button.locate-btn {
      position: absolute;
      left: 50px;
      z-index: 1000;
      padding: 8px 12px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }
    button.locate-btn {
      top: 10px;
    }
    button.layer-toggle {
      top: 50px;
    }
    #loader {
      position: absolute;
      top: 10px;
      left: 215px;
      z-index: 1000;
      padding: 8px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
  </style>
</head>
<body>
<button onclick="findLocation()" class="locate-btn">üìç –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ</button>
<button onclick="toggleLayers()" class="layer-toggle">üó∫ –®–∞—Ä–∏</button>
<div id="loader"></div>
<button id="auth-btn" style="position:absolute; top:90px; left:50px; z-index:1000;">üîê –£–≤—ñ–π—Ç–∏</button>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>

<script>
  const map = L.map('map').setView([49.1029, 29.2074], 13);

// Google Maps —à–∞—Ä (–≤—É–ª–∏—Ü—ñ)
const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
  maxZoom: 20,
  subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
  attribution: '¬© Google Maps'
}).addTo(map);

// –°—É–ø—É—Ç–Ω–∏–∫–æ–≤–∏–π —à–∞—Ä (Esri)
const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: '¬© Esri',
  maxZoom: 20
});

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —à–∞—Ä—ñ–≤ —Ä–∞–π–æ–Ω—ñ–≤
const districts = [
  { id: 'district1', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 1', color: 'blue', fillColor: '#99ccff' },
  { id: 'district2', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 2', color: 'green', fillColor: '#b6fcb6' },
  { id: 'district55', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 55', color: 'green', fillColor: '#b6fcb6' },
  { id: 'district56', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 56', color: 'green', fillColor: '#b6fcb6' }
];

const districtCenters = [];
const districtGeometries = [];
const overlayMaps = {};

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ–ø–∞–ø—É
function createDistrictPopup(name, latlng) {
  return `<b>${name}</b><br>
    <button onclick="routeToDistrict('${name}')">üìå –ü—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç —Å—é–¥–∏</button>`;
}

// –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
function showLoading(show) {
  let loader = document.getElementById('loader');
  loader.innerText = show ? '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...' : '';
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–∞–π–æ–Ω—ñ–≤
districts.forEach(d => {
  const layer = L.layerGroup();
  showLoading(true);
  fetch(`${d.id}.json`)
    .then(res => {
      if (!res.ok) throw new Error(`HTTP –ø–æ–º–∏–ª–∫–∞: ${res.status}`);
      return res.json();
    })
    .then(data => {
      console.log(`–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –¥–∞–Ω—ñ –¥–ª—è ${d.name}:`, data);
      const geoJsonLayer = L.geoJSON(data, {
        onEachFeature: (feature, layer) => {
          const center = layer.getBounds().getCenter();
          districtCenters.push({ name: feature.properties?.name || d.name, latlng: center });
          layer.bindPopup(createDistrictPopup(feature.properties?.name || d.name, center));
        },
        style: { color: d.color, fillColor: d.fillColor, fillOpacity: 0.4 }
      }).addTo(layer);
      
      // –í–∏—Ç—è–≥—É—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –¥–ª—è GeometryCollection
      const coordinates = [];
      if (data.type === "GeometryCollection") {
        data.geometries.forEach(geom => {
          if (geom.type === "Polygon" || geom.type === "MultiPolygon") {
            const coords = geom.coordinates;
            if (geom.type === "Polygon") {
              coords.forEach(ring => coordinates.push(...ring.map(c => L.latLng(c[1], c[0]))));
            } else if (geom.type === "MultiPolygon") {
              coords.forEach(polygon => polygon.forEach(ring => coordinates.push(...ring.map(c => L.latLng(c[1], c[0])))));
            }
          }
        });
      } else if (data.type === "Feature" && (data.geometry.type === "Polygon" || data.geometry.type === "MultiPolygon")) {
        const coords = data.geometry.coordinates;
        if (data.geometry.type === "Polygon") {
          coords.forEach(ring => coordinates.push(...ring.map(c => L.latLng(c[1], c[0]))));
        } else {
          coords.forEach(polygon => polygon.forEach(ring => coordinates.push(...ring.map(c => L.latLng(c[1], c[0])))));
        }
      }
      console.log(`–ó—ñ–±—Ä–∞–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –¥–ª—è ${d.name}:`, coordinates);
      districtGeometries.push({ name: d.name, coordinates: coordinates });
      showLoading(false);
    })
    .catch(err => {
      console.error(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ${d.id}.json:`, err);
      alert(`‚ö† –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –¥–ª—è ${d.name}. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.`);
      showLoading(false);
    });
  overlayMaps[d.name] = layer;
});

// –ë–∞–∑–æ–≤—ñ —à–∞—Ä–∏
const baseMaps = {
  "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –∫–∞—Ä—Ç–∞": googleStreets,
  "–°—É–ø—É—Ç–Ω–∏–∫–æ–≤–∞ –∫–∞—Ä—Ç–∞": satellite
};

// –î–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞ —à–∞—Ä—ñ–≤
L.control.layers(baseMaps, overlayMaps, { collapsed: true }).addTo(map);

// –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —à–∞—Ä—ñ–≤
function toggleLayers() {
  const control = document.querySelector('.leaflet-control-layers');
  if (control) {
    control.classList.toggle('leaflet-control-layers-expanded');
  }
  const btn = document.querySelector('.layer-toggle');
  btn.innerText = control.classList.contains('leaflet-control-layers-expanded') ? 'üó∫ –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —à–∞—Ä–∏' : 'üó∫ –ü–æ–∫–∞–∑–∞—Ç–∏ —à–∞—Ä–∏';
}

let currentMarker = null;
let currentCircle = null;
let routeControl = null;
let currentLocation = null;

// –ü–æ—à—É–∫ –º—ñ—Å—Ü—è
function findLocation() {
  if (!navigator.geolocation) {
    alert('‚ö† –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é.');
    return;
  }
  showLoading(true);
  map.locate({
    setView: true,
    maxZoom: 16,
    timeout: 20000,
    enableHighAccuracy: true
  });
}

// –û–±—Ä–æ–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó
map.on('locationfound', function (e) {
  currentLocation = e.latlng;
  showLoading(false);

  if (currentMarker) map.removeLayer(currentMarker);
  if (currentCircle) map.removeLayer(currentCircle);

  currentCircle = L.circle(e.latlng, {
    radius: e.accuracy,
    color: 'blue',
    fillColor: '#30f',
    fillOpacity: 0.2
  }).addTo(map);

  currentMarker = L.marker(e.latlng).addTo(map)
    .bindPopup("–í–∞—à–µ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è (—Ç–æ—á–Ω—ñ—Å—Ç—å " + Math.round(e.accuracy) + " –º)").openPopup();
});

// –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–∫–∏ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó
map.on('locationerror', function (e) {
  showLoading(false);
  alert("‚ö† –ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è: " + e.message +
    "\n\n–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:\n- –í–∏–º–∫–Ω–µ–Ω—ñ —Å–ª—É–∂–±–∏ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó\n- –í—ñ–¥—Å—É—Ç–Ω—ñ–π –¥–æ–∑–≤—ñ–ª —É –±—Ä–∞—É–∑–µ—Ä—ñ\n- –ü–æ–≤—ñ–ª—å–Ω–µ –∑'—î–¥–Ω–∞–Ω–Ω—è\n- –°–∞–π—Ç –º–∞—î –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ —á–µ—Ä–µ–∑ HTTPS");
});

// –ü—Ä–æ–∫–ª–∞–¥–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É –¥–æ –Ω–∞–π–±–ª–∏–∂—á–æ—ó —Ç–æ—á–∫–∏ —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—ó
function routeToDistrict(districtName) {
  if (!currentLocation) {
    alert("‚õî –°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É üìç ¬´–ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ¬ª");
    return;
  }

  const district = districtGeometries.find(d => d.name === districtName);
  if (!district) {
    alert(`‚ö† –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –≥–µ–æ–º–µ—Ç—Ä—ñ—é –¥–ª—è ${districtName}`);
    return;
  }

  const coordinates = district.coordinates;
  console.log(`–ó—ñ–±—Ä–∞–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –¥–ª—è ${districtName}:`, coordinates);
  if (!coordinates || coordinates.length === 0) {
    alert(`‚ö† –ù–µ–º–∞—î –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è ${districtName}`);
    return;
  }

  let nearestPoint = coordinates[0];
  let minDist = currentLocation.distanceTo(nearestPoint);
  coordinates.forEach(coord => {
    const dist = currentLocation.distanceTo(coord);
    if (dist < minDist) {
      minDist = dist;
      nearestPoint = coord;
    }
  });

  if (routeControl) {
    map.removeControl(routeControl);
  }

  routeControl = L.Routing.control({
    waypoints: [currentLocation, nearestPoint],
    routeWhileDragging: false,
    addWaypoints: false,
    show: false,
    createMarker: () => null
  }).addTo(map);

  const distText = minDist > 1000 ? (minDist / 1000).toFixed(2) + " –∫–º" : Math.round(minDist) + " –º";
  if (currentMarker) {
    currentMarker.bindPopup(
      `–í–∞—à–µ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è<br>–ú–∞—Ä—à—Ä—É—Ç –¥–æ <b>${districtName}</b><br>–í—ñ–¥—Å—Ç–∞–Ω—å: ${distText}`
    ).openPopup();
  }
}
// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDracSUSYz_QrmmDj_HcBfQpJlJ3FjPHpU",
  authDomain: "map-illintsi.firebaseapp.com",
  projectId: "map-illintsi",
  storageBucket: "map-illintsi.firebasestorage.app",
  messagingSenderId: "62267872375",
  appId: "1:62267872375:web:10945d2d63b93bccc5e272",
  measurementId: "G-22L16KP5Z0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore(app);
const authBtn = document.getElementById('auth-btn');

authBtn.addEventListener('click', () => {
  if (auth.currentUser) {
    signOut(auth).then(() => alert('–í–∏ –≤–∏–π—à–ª–∏ –∑ —Å–∏—Å—Ç–µ–º–∏'));
  } else {
    const email = prompt("–í–≤–µ–¥—ñ—Ç—å email:");
    const password = prompt("–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å:");
    if (!email || !password) return;

    signInWithEmailAndPassword(auth, email, password)
      .then(userCredential => {
        alert("–£—Å–ø—ñ—à–Ω–∏–π –≤—Ö—ñ–¥!");
      })
      .catch(error => {
        alert("–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: " + error.message);
      });
  }
});

onAuthStateChanged(auth, (user) => {
  if (user) {
    authBtn.innerText = "üö™ –í–∏–π—Ç–∏";
  } else {
    authBtn.innerText = "üîê –£–≤—ñ–π—Ç–∏";
  }
});


</script>
</body>
</html>
