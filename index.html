<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>–ö–∞—Ä—Ç–∞ –¢–µ—Ä–∏—Ç–æ—Ä—ñ–π "–Ü–ª–ª—ñ–Ω—Ü—ñ"</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    button.layer-toggle, button.locate-btn, button.auth-btn, button.history-btn {
      position: absolute;
      left: 50px;
      z-index: 1000;
      padding: 8px 12px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }
    button.locate-btn { top: 10px; }
    button.layer-toggle { top: 50px; }
    button.auth-btn { top: 90px; }
    button.history-btn { top: 130px; }
    #history-view {
      display: none;
      position: absolute;
      top: 170px;
      left: 50px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      max-height: 50vh;
      overflow-y: auto;
    }
    #edit-form {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2000;
      background: white;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #edit-form input, #edit-form textarea {
      display: block;
      margin: 10px 0;
      width: 100%;
    }
  </style>
</head>
<body>
  <button onclick="findLocation()" class="locate-btn">üìç –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ</button>
  <button onclick="toggleLayers()" class="layer-toggle">üó∫ –®–∞—Ä–∏</button>
  <button onclick="toggleAuth()" class="auth-btn" id="auth-btn">üîí –£–≤—ñ–π—Ç–∏</button>
  <button onclick="showHistory()" class="history-btn">üìú –Ü—Å—Ç–æ—Ä—ñ—è</button>
  <div id="map"></div>
  <div id="history-view"></div>
  <div id="edit-form">
    <h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é</h3>
    <input type="text" id="edit-date-received" placeholder="–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è (—Ä—Ä—Ä—Ä-–º–º-–¥–¥)">
    <input type="text" id="edit-date-processed" placeholder="–î–∞—Ç–∞ –æ–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è (—Ä—Ä—Ä—Ä-–º–º-–¥–¥)">
    <input type="text" id="edit-bulletin" placeholder="–í—ñ—Å–Ω–∏–∫">
    <textarea id="edit-additional" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤–æ"></textarea>
    <button onclick="saveInfo()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    <button onclick="closeEditForm()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const map = L.map('map').setView([49.1029, 29.2074], 14);
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap',
      maxZoom: 19
    }).addTo(map);
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '¬© Esri',
      maxZoom: 19
    });
    const district1 = L.layerGroup().addTo(map);
    const district2 = L.layerGroup().addTo(map);
    const baseMaps = { "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –∫–∞—Ä—Ç–∞": osm, "–°—É–ø—É—Ç–Ω–∏–∫–æ–≤–∞ –∫–∞—Ä—Ç–∞": satellite };
    const overlayMaps = { "–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 1": district1, "–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 2": district2 };
    L.control.layers(baseMaps, overlayMaps, { collapsed: true }).addTo(map);

    let currentUser = null;
    let currentMarker = null;
    let currentCircle = null;
    let routeControl = null;
    let currentLocation = null;
    let currentFeatureId = null;

    // Authentication state
    auth.onAuthStateChanged(user => {
      currentUser = user;
      document.getElementById('auth-btn').textContent = user ? 'üîì –í–∏–π—Ç–∏' : 'üîí –£–≤—ñ–π—Ç–∏';
      document.querySelector('.history-btn').style.display = user ? 'block' : 'none';
      loadDistricts();
    });

    function toggleAuth() {
      if (currentUser) {
        auth.signOut();
      } else {
        const email = prompt("–í–≤–µ–¥—ñ—Ç—å email:");
        const password = prompt("–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å:");
        auth.signInWithEmailAndPassword(email, password).catch(error => {
          alert("‚ö† –ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: " + error.message);
        });
      }
    }

    function loadDistricts() {
      district1.clearLayers();
      district2.clearLayers();
      db.collection('districts').get().then(snapshot => {
        snapshot.forEach(doc => {
          const data = doc.data();
          const layerGroup = data.district === 'district1' ? district1 : district2;
          const geoJsonLayer = L.geoJSON(data.geojson, {
            style: {
              color: data.district === 'district1' ? 'blue' : 'green',
              fillColor: data.district === 'district1' ? '#99ccff' : '#b6fcb6',
              fillOpacity: 0.4
            },
            onEachFeature: (feature, layer) => {
              const center = layer.getBounds().getCenter();
              const popupContent = createDistrictPopup(feature.properties?.name || `–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è ${data.district}`, center, doc.id);
              layer.bindPopup(popupContent);
              if (currentUser) {
                const tooltipContent = createTooltipContent(data.info);
                layer.bindTooltip(tooltipContent, { direction: 'top' });
                layer.on('mouseover', () => layer.openTooltip());
                layer.on('mouseout', () => layer.closeTooltip());
              }
            }
          }).addTo(layerGroup);
        });
      });
    }

    function createDistrictPopup(name, latlng, docId) {
      let content = `<b>${name}</b><br><button onclick="routeToDistrict(${latlng.lat}, ${latlng.lng}, '${name}')">üìå –ü—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç —Å—é–¥–∏</button>`;
      if (currentUser) {
        content += `<br><button onclick="openEditForm('${docId}')">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>`;
      }
      return content;
    }

    function createTooltipContent(info) {
      if (!info) return '–ù–µ–º–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó';
      return `–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:<br>
        –î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è: ${info.dateReceived || '‚Äî'}<br>
        –î–∞—Ç–∞ –æ–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è: ${info.dateProcessed || '‚Äî'}<br>
        –í—ñ—Å–Ω–∏–∫: ${info.bulletin || '‚Äî'}<br>
        –î–æ–¥–∞—Ç–∫–æ–≤–æ: ${info.additional || '‚Äî'}`;
    }

    function openEditForm(docId) {
      currentFeatureId = docId;
      document.getElementById('edit-form').style.display = 'block';
      db.collection('districts').doc(docId).get().then(doc => {
        if (doc.exists) {
          const data = doc.data().info || {};
          document.getElementById('edit-date-received').value = data.dateReceived || '';
          document.getElementById('edit-date-processed').value = data.dateProcessed || '';
          document.getElementById('edit-bulletin').value = data.bulletin || '';
          document.getElementById('edit-additional').value = data.additional || '';
        }
      });
    }

    function closeEditForm() {
      document.getElementById('edit-form').style.display = 'none';
      currentFeatureId = null;
    }

    function saveInfo() {
      if (!currentUser || !currentFeatureId) return;
      const info = {
        dateReceived: document.getElementById('edit-date-received').value,
        dateProcessed: document.getElementById('edit-date-processed').value,
        bulletin: document.getElementById('edit-bulletin').value,
        additional: document.getElementById('edit-additional').value,
        updatedBy: currentUser.email,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      db.collection('districts').doc(currentFeatureId).update({ info }).then(() => {
        db.collection('history').add({
          districtId: currentFeatureId,
          info,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        loadDistricts();
        closeEditForm();
      }).catch(error => {
        alert("‚ö† –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: " + error.message);
      });
    }

    function showHistory() {
      const historyView = document.getElementById('history-view');
      historyView.style.display = historyView.style.display === 'block' ? 'none' : 'block';
      if (historyView.style.display === 'block') {
        db.collection('history').orderBy('timestamp', 'desc').get().then(snapshot => {
          let content = '<h3>–Ü—Å—Ç–æ—Ä—ñ—è –∑–º—ñ–Ω</h3>';
          content += '<button onclick="exportHistory()">üì• –ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏</button><br>';
          snapshot.forEach(doc => {
            const data = doc.data();
            content += `<p><b>–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è:</b> ${data.districtId}<br>
              <b>–û–Ω–æ–≤–ª–µ–Ω–æ:</b> ${data.info.updatedBy}<br>
              <b>–î–∞—Ç–∞:</b> ${data.timestamp.toDate().toLocaleString('uk-UA')}<br>
              <b>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:</b><br>
              –î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è: ${data.info.dateReceived || '‚Äî'}<br>
              –î–∞—Ç–∞ –æ–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è: ${data.info.dateProcessed || '‚Äî'}<br>
              –í—ñ—Å–Ω–∏–∫: ${data.info.bulletin || '‚Äî'}<br>
              –î–æ–¥–∞—Ç–∫–æ–≤–æ: ${data.info.additional || '‚Äî'}</p>`;
          });
          historyView.innerHTML = content;
        });
      }
    }

    function exportHistory() {
      db.collection('history').orderBy('timestamp', 'desc').get().then(snapshot => {
        const data = snapshot.docs.map(doc => ({
          districtId: doc.data().districtId,
          ...doc.data().info,
          timestamp: doc.data().timestamp.toDate().toLocaleString('uk-UA')
        }));
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'history.json';
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    function toggleLayers() {
      const control = document.querySelector('.leaflet-control-layers');
      if (control) {
        control.classList.toggle('leaflet-control-layers-expanded');
      }
    }

    function findLocation() {
      map.locate({
        setView: true,
        maxZoom: 16,
        timeout: 20000,
        enableHighAccuracy: true
      });
    }

    map.on('locationfound', function (e) {
      currentLocation = e.latlng;
      if (currentMarker) map.removeLayer(currentMarker);
      if (currentCircle) map.removeLayer(currentCircle);
      currentCircle = L.circle(e.latlng, {
        radius: e.accuracy,
        color: 'blue',
        fillColor: '#30f',
        fillOpacity: 0.2
      }).addTo(map);
      currentMarker = L.marker(e.latlng).addTo(map)
        .bindPopup("–í–∞—à–µ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è (—Ç–æ—á–Ω—ñ—Å—Ç—å " + Math.round(e.accuracy) + " –º)").openPopup();
    });

    map.on('locationerror', function (e) {
      alert("‚ö† –ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è: " + e.message +
        "\n\n–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:\n- –í–∏–º–∫–Ω–µ–Ω—ñ —Å–ª—É–∂–±–∏ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó\n- –í—ñ–¥—Å—É—Ç–Ω—ñ–π –¥–æ–∑–≤—ñ–ª —É –±—Ä–∞—É–∑–µ—Ä—ñ\n- –ü–æ–≤—ñ–ª—å–Ω–µ –∑'—î–¥–Ω–∞–Ω–Ω—è –∞–±–æ —Å–ª–∞–±–∫–∏–π —Å–∏–≥–Ω–∞–ª\n- –°–∞–π—Ç –ø–æ–≤–∏–Ω–µ–Ω –≤—ñ–¥–∫—Ä–∏–≤–∞—Ç–∏—Å—è —á–µ—Ä–µ–∑ HTTPS");
    });

    window.routeToDistrict = function(lat, lng, name) {
      if (!currentLocation) {
        alert("‚õî –°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É üìç ¬´–ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ¬ª");
        return;
      }
      if (routeControl) {
        map.removeControl(routeControl);
      }
      routeControl = L.Routing.control({
        waypoints: [currentLocation, L.latLng(lat, lng)],
        routeWhileDragging: false,
        addWaypoints: false,
        show: false,
        createMarker: () => null
      }).addTo(map);
      const dist = currentLocation.distanceTo(L.latLng(lat, lng));
      const distText = dist > 1000 ? (dist / 1000).toFixed(2) + " –∫–º" : Math.round(dist) + " –º";
      if (currentMarker) {
        currentMarker.bindPopup(
          `–í–∞—à–µ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—àdrivers license: 24.10.2025
        ).openPopup();
      }
    };
  </script>
</body>
</html>
