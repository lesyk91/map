<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>–ö–∞—Ä—Ç–∞ –¢–µ—Ä–∏—Ç–æ—Ä—ñ–π "–Ü–ª–ª—ñ–Ω—Ü—ñ" –∑ Google Maps</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    button.layer-toggle, button.locate-btn, button.auth-button {
      position: absolute;
      left: 50px;
      z-index: 1000;
      padding: 8px 12px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }
    button.locate-btn { top: 10px; }
    button.layer-toggle { top: 50px; }
    button.auth-button { top: 90px; }
    #loader {
      position: absolute;
      top: 10px;
      left: 215px;
      z-index: 1000;
      padding: 8px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    .info-panel {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 5px;
      width: 300px;
      display: none;
    }
    .info-panel input, .info-panel textarea {
      width: 100%;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
<button onclick="findLocation()" class="locate-btn">üìç –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ</button>
<button onclick="toggleLayers()" class="layer-toggle">üó∫ –®–∞—Ä–∏</button>
<button id="authBtn" class="auth-button">üîê –£–≤—ñ–π—Ç–∏</button>
<div id="loader"></div>
<div id="map"></div>
<div class="info-panel" id="infoPanel">
  <h3>–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—ó</h3>
  <input type="text" id="editorName" placeholder="–ü–Ü–ë –≤—ñ—Å–Ω–∏–∫–∞" />
  <input type="date" id="receiveDate" placeholder="–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è" />
  <input type="date" id="processDate" placeholder="–î–∞—Ç–∞ –æ–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è" />
  <textarea id="extraInfo" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è"></textarea>
  <button id="saveBtn">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDracSUSYz_QrmmDj_HcBfQpJlJ3FjPHpU",
  authDomain: "map-illintsi.firebaseapp.com",
  projectId: "map-illintsi",
  storageBucket: "map-illintsi.firebasestorage.app",
  messagingSenderId: "62267872375",
  appId: "1:62267872375:web:10945d2d63b93bccc5e272",
  measurementId: "G-22L16KP5Z0"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null;
let selectedDistrict = null;

auth.onAuthStateChanged(user => {
  currentUser = user;
  document.getElementById('authBtn').textContent = user ? 'üîì –í–∏–π—Ç–∏' : 'üîê –£–≤—ñ–π—Ç–∏';
});

document.getElementById('authBtn').addEventListener('click', () => {
  if (currentUser) {
    auth.signOut();
  } else {
    const email = prompt("Email:");
    const password = prompt("–ü–∞—Ä–æ–ª—å:");
    if (email && password) {
      auth.signInWithEmailAndPassword(email, password).catch(err => alert("‚ùå " + err.message));
    }
  }
});

const map = L.map('map').setView([49.1029, 29.2074], 13);
const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
  maxZoom: 20,
  subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
  attribution: '¬© Google Maps'
}).addTo(map);
const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: '¬© Esri',
  maxZoom: 20
});

const districts = [
  { id: 'district1', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 1', color: 'blue', fillColor: '#99ccff' },
  { id: 'district2', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 2', color: 'green', fillColor: '#b6fcb6' },
  { id: 'district55', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 55', color: 'green', fillColor: '#b6fcb6' },
  { id: 'district56', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 56', color: 'green', fillColor: '#b6fcb6' }
];

const districtCenters = [];
const districtGeometries = [];
const overlayMaps = {};

function createDistrictPopup(name, latlng) {
  return `<b>${name}</b><br>
    <button onclick="routeToDistrict('${name}')">üìå –ü—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç —Å—é–¥–∏</button>`;
}

function showLoading(show) {
  document.getElementById('loader').innerText = show ? '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...' : '';
}

districts.forEach(d => {
  const layer = L.layerGroup();
  showLoading(true);
  fetch(`${d.id}.json`).then(res => res.json()).then(data => {
    const geoJsonLayer = L.geoJSON(data, {
      onEachFeature: (feature, lyr) => {
        const center = lyr.getBounds().getCenter();
        districtCenters.push({ name: feature.properties?.name || d.name, latlng: center });
        lyr.bindPopup(createDistrictPopup(feature.properties?.name || d.name, center));
        lyr.on('click', () => {
          selectedDistrict = feature.properties?.name || d.name;
          if (currentUser) document.getElementById('infoPanel').style.display = 'block';
          else document.getElementById('infoPanel').style.display = 'none';
          loadLastEntry(selectedDistrict);
        });
      },
      style: { color: d.color, fillColor: d.fillColor, fillOpacity: 0.4 }
    }).addTo(layer);

    overlayMaps[d.name] = layer;
    showLoading(false);
  }).catch(err => {
    console.error(`–ü–æ–º–∏–ª–∫–∞ ${d.id}.json:`, err);
    alert(`‚ö† –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ ${d.name}`);
    showLoading(false);
  });
});

L.control.layers({ "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –∫–∞—Ä—Ç–∞": googleStreets, "–°—É–ø—É—Ç–Ω–∏–∫–æ–≤–∞ –∫–∞—Ä—Ç–∞": satellite }, overlayMaps, { collapsed: true }).addTo(map);

function toggleLayers() {
  const control = document.querySelector('.leaflet-control-layers');
  if (control) {
    control.classList.toggle('leaflet-control-layers-expanded');
  }
  const btn = document.querySelector('.layer-toggle');
  btn.innerText = control.classList.contains('leaflet-control-layers-expanded') ? 'üó∫ –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —à–∞—Ä–∏' : 'üó∫ –ü–æ–∫–∞–∑–∞—Ç–∏ —à–∞—Ä–∏';
}

let currentMarker = null;
let currentCircle = null;
let routeControl = null;
let currentLocation = null;

function findLocation() {
  if (!navigator.geolocation) {
    alert('‚ö† –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é.');
    return;
  }
  showLoading(true);
  map.locate({ setView: true, maxZoom: 16, timeout: 20000, enableHighAccuracy: true });
}

map.on('locationfound', function (e) {
  currentLocation = e.latlng;
  showLoading(false);
  if (currentMarker) map.removeLayer(currentMarker);
  if (currentCircle) map.removeLayer(currentCircle);
  currentCircle = L.circle(e.latlng, { radius: e.accuracy, color: 'blue', fillColor: '#30f', fillOpacity: 0.2 }).addTo(map);
  currentMarker = L.marker(e.latlng).addTo(map).bindPopup("–í–∞—à–µ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è (—Ç–æ—á–Ω—ñ—Å—Ç—å " + Math.round(e.accuracy) + " –º)").openPopup();
});

map.on('locationerror', function (e) {
  showLoading(false);
  alert("‚ö† –ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è: " + e.message);
});

function routeToDistrict(districtName) {
  if (!currentLocation) {
    alert("‚õî –°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É üìç ¬´–ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ¬ª");
    return;
  }
  const district = districtGeometries.find(d => d.name === districtName);
  if (!district || !district.coordinates?.length) return alert("‚ö† –ù–µ–º–∞—î –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è " + districtName);
  let nearestPoint = district.coordinates[0];
  let minDist = currentLocation.distanceTo(nearestPoint);
  district.coordinates.forEach(coord => {
    const dist = currentLocation.distanceTo(coord);
    if (dist < minDist) {
      minDist = dist;
      nearestPoint = coord;
    }
  });
  if (routeControl) map.removeControl(routeControl);
  routeControl = L.Routing.control({
    waypoints: [currentLocation, nearestPoint], routeWhileDragging: false, addWaypoints: false, show: false, createMarker: () => null
  }).addTo(map);
  if (currentMarker) currentMarker.bindPopup(`–í–∞—à–µ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è<br>–ú–∞—Ä—à—Ä—É—Ç –¥–æ <b>${districtName}</b><br>–í—ñ–¥—Å—Ç–∞–Ω—å: ${minDist > 1000 ? (minDist/1000).toFixed(2) + " –∫–º" : Math.round(minDist) + " –º"}`).openPopup();
}

async function loadLastEntry(sectorId) {
  const docRef = db.collection('sectors').doc(sectorId);
  const docSnap = await docRef.get();
  if (docSnap.exists) {
    const data = docSnap.data();
    const history = data.history || [];
    if (history.length > 0) {
      const last = history[history.length - 1];
      alert("–û—Å—Ç–∞–Ω–Ω—ñ–π –∑–∞–ø–∏—Å:\n–ü–Ü–ë: " + last.pib + "\n–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è: " + last.date_get + "\n–î–∞—Ç–∞ –æ–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è: " + last.date_process + "\n–†–µ–¥–∞–≥—É–≤–∞–≤: " + (last.editedBy || '–Ω–µ–≤—ñ–¥–æ–º–æ'));
    }
  }
}

document.getElementById('saveBtn').addEventListener('click', async () => {
  if (!selectedDistrict || !currentUser) return;
  const pib = document.getElementById('editorName').value;
  const date_get = document.getElementById('receiveDate').value;
  const date_process = document.getElementById('processDate').value;
  const extra = document.getElementById('extraInfo').value;

  const newEntry = {
    pib,
    date_get,
    date_process,
    extra,
    editedBy: currentUser.email,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };

  const docRef = db.collection('sectors').doc(selectedDistrict);
  await docRef.set({ history: firebase.firestore.FieldValue.arrayUnion(newEntry) }, { merge: true });
  alert("‚úÖ –î–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ");
});
</script>
</body>
</html>
