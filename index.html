<!DOCTYPE html>
<html lang="uk">
<head>
  <meta name="robots" content="noindex, nofollow">
  <meta charset="utf-8" />
  <title>–ö–∞—Ä—Ç–∞ –¢–µ—Ä–∏—Ç–æ—Ä—ñ–π "–Ü–ª–ª—ñ–Ω—Ü—ñ" –∑ Google Maps</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <style>
    html, body, #map {
      height: 100%; margin: 0; padding: 0;
    }
    button.layer-toggle, button.locate-btn, #auth-btn {
      position: absolute; left: 50px; z-index: 1000;
      padding: 8px 12px; background: white; border: 1px solid #ccc;
      border-radius: 4px; cursor: pointer;
    }
    button.locate-btn { top: 10px; }
    button.layer-toggle { top: 50px; }
    #auth-btn { top: 90px; }
    #loader {
      position: absolute; top: 10px; left: 215px; z-index: 1000;
      padding: 8px; background: white; border: 1px solid #ccc;
      border-radius: 10px;
    }
    #form-container {
      position: absolute; top: 150px; left: 50px; background: white;
      padding: 10px; border: 1px solid #ccc; border-radius: 10px;
      z-index: 1000; display: none; max-width: 300px;
    }
  </style>
</head>
<body>
  <button onclick="findLocation()" class="locate-btn">üìç –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ</button>
  <button onclick="toggleLayers()" class="layer-toggle">üó∫ –®–∞—Ä–∏</button>
  <button id="auth-btn">üîê –£–≤—ñ–π—Ç–∏</button>
  <div id="loader"></div>
  <div id="form-container">
    <h3 id="form-title">–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è</h3>
    <form id="info-form">
      <label>–ü–Ü–ë:<br><input type="text" id="pib" required></label><br>
      <label>–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è:<br><input type="date" id="date-received"></label><br>
      <label>–î–∞—Ç–∞ –æ–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è:<br><input type="date" id="date-processed"></label><br>
      <label>–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:<br><textarea id="info" rows="3"></textarea></label><br>
      <button type="submit">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
      <button type="button" onclick="closeForm()">‚úñ –ó–∞–∫—Ä–∏—Ç–∏</button>
    </form>
    <div id="last-update" style="font-size: 0.9em; color: gray;"></div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDracSUSYz_QrmmDj_HcBfQpJlJ3FjPHpU",
      authDomain: "map-illintsi.firebaseapp.com",
      projectId: "map-illintsi",
      storageBucket: "map-illintsi.firebasestorage.app",
      messagingSenderId: "62267872375",
      appId: "1:62267872375:web:10945d2d63b93bccc5e272",
      measurementId: "G-22L16KP5Z0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);

    const authBtn = document.getElementById('auth-btn');
    authBtn.addEventListener('click', () => {
      if (auth.currentUser) signOut(auth);
      else {
        const email = prompt("–í–≤–µ–¥—ñ—Ç—å email:");
        const password = prompt("–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å:");
        if (!email || !password) return;
        signInWithEmailAndPassword(auth, email, password).catch(err => alert("‚ùå " + err.message));
      }
    });

    onAuthStateChanged(auth, (user) => {
      authBtn.innerText = user ? "üö™ –í–∏–π—Ç–∏" : "üîê –£–≤—ñ–π—Ç–∏";
    });

    const map = L.map('map').setView([49.1029, 29.2074], 13);
    const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
      maxZoom: 20,
      subdomains: ['mt0','mt1','mt2','mt3'], attribution: '¬© Google Maps'
    }).addTo(map);
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '¬© Esri', maxZoom: 20
    });
    const baseMaps = {"–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –∫–∞—Ä—Ç–∞": googleStreets, "–°—É–ø—É—Ç–Ω–∏–∫–æ–≤–∞ –∫–∞—Ä—Ç–∞": satellite};
    const overlayMaps = {};
    const districts = [
      { id: 'district1', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 1', color: 'blue', fillColor: '#99ccff' },
      { id: 'district2', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 2', color: 'green', fillColor: '#b6fcb6' },
      { id: 'district55', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 55', color: 'green', fillColor: '#b6fcb6' },
      { id: 'district56', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 56', color: 'green', fillColor: '#b6fcb6' }
    ];

    function showLoading(show) {
      document.getElementById('loader').innerText = show ? '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...' : '';
    }

    districts.forEach(d => {
      const layer = L.layerGroup();
      showLoading(true);
      fetch(`${d.id}.json`).then(res => res.json()).then(data => {
        const geoJsonLayer = L.geoJSON(data, {
          style: { color: d.color, fillColor: d.fillColor, fillOpacity: 0.4 },
          onEachFeature: (feature, layer) => {
            layer.on('click', () => handleDistrictClick(feature.properties?.name || d.name));
          }
        }).addTo(layer);
        showLoading(false);
      }).catch(err => {
        console.error(err);
        alert(`‚ö† –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ ${d.name}`);
        showLoading(false);
      });
      overlayMaps[d.name] = layer;
    });

    L.control.layers(baseMaps, overlayMaps).addTo(map);

    function toggleLayers() {
      const control = document.querySelector('.leaflet-control-layers');
      if (control) control.classList.toggle('leaflet-control-layers-expanded');
    }

    let currentMarker = null;
    function findLocation() {
      if (!navigator.geolocation) return alert("–ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è");
      showLoading(true);
      map.locate({ setView: true, maxZoom: 16 });
    }

    map.on('locationfound', e => {
      showLoading(false);
      if (currentMarker) map.removeLayer(currentMarker);
      currentMarker = L.marker(e.latlng).addTo(map).bindPopup("–í–∞—à–µ –º—ñ—Å—Ü–µ —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è").openPopup();
    });

    map.on('locationerror', e => {
      showLoading(false);
      alert("–ü–æ–º–∏–ª–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó: " + e.message);
    });

    async function handleDistrictClick(name) {
      document.getElementById('form-title').innerText = `–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è: ${name}`;
      const form = document.getElementById('form-container');
      const docRef = doc(db, "territories", name);
      const docSnap = await getDoc(docRef);
      const data = docSnap.exists() ? docSnap.data() : {};
      document.getElementById('pib').value = data.pib || '';
      document.getElementById('date-received').value = data.date_received || '';
      document.getElementById('date-processed').value = data.date_processed || '';
      document.getElementById('info').value = data.info || '';
      document.getElementById('last-update').innerText = data.updated_by ? `–û–Ω–æ–≤–∏–≤: ${data.updated_by}, ${data.updated_at?.toDate().toLocaleString()}` : '–ó–∞–ø–∏—Å—ñ–≤ —â–µ –Ω–µ–º–∞—î';

      const disabled = !auth.currentUser;
      ['pib','date-received','date-processed','info'].forEach(id => document.getElementById(id).disabled = disabled);
      document.querySelector('#info-form button[type=submit]').style.display = disabled ? 'none' : 'inline-block';
      form.style.display = 'block';

      document.getElementById('info-form').onsubmit = async (e) => {
        e.preventDefault();
        if (!auth.currentUser) return;
        await setDoc(docRef, {
          pib: document.getElementById('pib').value,
          date_received: document.getElementById('date-received').value,
          date_processed: document.getElementById('date-processed').value,
          info: document.getElementById('info').value,
          updated_by: auth.currentUser.email,
          updated_at: serverTimestamp()
        }, { merge: true });
        alert("‚úÖ –î–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ");
        form.style.display = 'none';
      };
    }

    window.closeForm = () => {
      document.getElementById('form-container').style.display = 'none';
    }
  </script>
</body>
</html>
