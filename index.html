<!-- Базовий шаблон з Firebase підключенням -->
<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>Інтерактивна карта з Firebase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .auth-button { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    .info-panel { position: absolute; bottom: 10px; right: 10px; z-index: 1000; background: white; padding: 10px; border-radius: 5px; width: 300px; display: none; }
    .info-panel textarea { width: 100%; height: 60px; }
    .info-panel input { width: 100%; margin-bottom: 5px; }
  </style>
</head>
<body>
<div id="map"></div>
<button class="auth-button" id="loginBtn">Увійти</button>
<div class="info-panel" id="infoPanel">
  <h3>Редагування території</h3>
  <input type="text" id="editorName" placeholder="ПІБ вісника" />
  <input type="date" id="receiveDate" placeholder="Дата отримання" />
  <input type="date" id="processDate" placeholder="Дата опрацювання" />
  <textarea id="extraInfo" placeholder="Додаткова інформація"></textarea>
  <button id="saveBtn">Зберегти</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDracSUSYz_QrmmDj_HcBfQpJlJ3FjPHpU",
    authDomain: "map-illintsi.firebaseapp.com",
    projectId: "map-illintsi",
    storageBucket: "map-illintsi.firebasestorage.app",
    messagingSenderId: "62267872375",
    appId: "1:62267872375:web:10945d2d63b93bccc5e272",
    measurementId: "G-22L16KP5Z0"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let currentUser = null;
  let selectedDistrict = null;

  auth.onAuthStateChanged(user => {
    currentUser = user;
    document.getElementById('loginBtn').textContent = user ? 'Вийти' : 'Увійти';
  });

  document.getElementById('loginBtn').addEventListener('click', () => {
    if (currentUser) {
      auth.signOut();
    } else {
      const email = prompt("Введіть email:");
      const password = prompt("Введіть пароль:");
      if (email && password) {
        auth.signInWithEmailAndPassword(email, password)
          .catch(err => alert("Помилка входу: " + err.message));
      }
    }
  });

  const map = L.map('map').setView([49.1029, 29.2074], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  // Завантаження одного прикладного шару (можна цикл на всі .json)
  fetch('district1.json')
    .then(res => res.json())
    .then(data => {
      const geoLayer = L.geoJSON(data, {
        onEachFeature: (feature, layer) => {
          layer.on('click', () => {
            selectedDistrict = feature.properties.name || 'district1';
            document.getElementById('infoPanel').style.display = currentUser ? 'block' : 'none';
            loadLastEntry(selectedDistrict);
          });
        },
        style: { color: 'blue', fillColor: '#99ccff', fillOpacity: 0.4 }
      }).addTo(map);
    });

  async function loadLastEntry(sectorId) {
    const docRef = db.collection('sectors').doc(sectorId);
    const docSnap = await docRef.get();
    if (docSnap.exists) {
      const data = docSnap.data();
      const history = data.history || [];
      if (history.length > 0) {
        const last = history[history.length - 1];
        alert("Останній запис:\nПІБ: " + last.pib + "\nДата отримання: " + last.date_get + "\nДата опрацювання: " + last.date_process);
      }
    }
  }

  document.getElementById('saveBtn').addEventListener('click', async () => {
    if (!selectedDistrict || !currentUser) return;
    const pib = document.getElementById('editorName').value;
    const date_get = document.getElementById('receiveDate').value;
    const date_process = document.getElementById('processDate').value;
    const extra = document.getElementById('extraInfo').value;

    const newEntry = {
      pib,
      date_get,
      date_process,
      extra,
      editedBy: currentUser.email,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    const docRef = db.collection('sectors').doc(selectedDistrict);
    await docRef.set({ history: firebase.firestore.FieldValue.arrayUnion(newEntry) }, { merge: true });
    alert("Дані збережено");
  });
</script>
</body>
</html>
