<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Експорт історії всіх територій</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx-style@0.8.13/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background-color: #f0f0f0;
    }
    .btn {
      transition: all 0.3s ease;
    }
    #progress-container {
      display: none;
      margin-top: 1rem;
    }
    #progress-bar {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 0.5rem;
      overflow: hidden;
    }
    #progress-fill {
      height: 1.5rem;
      background-color: #4CAF50;
      width: 0%;
      transition: width 0.3s ease;
    }
    #progress-text {
      margin-top: 0.5rem;
      font-weight: 600;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="max-w-7xl mx-auto text-center">
    <h1 class="text-2xl font-bold text-gray-800 mb-4">Експорт історії всіх територій</h1>
    <button onclick="exportToExcel()" class="btn bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg">Експорт в Excel</button>
    <div id="progress-container">
      <div id="progress-bar">
        <div id="progress-fill"></div>
      </div>
      <div id="progress-text">Прогрес: 0%</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDracSUSYz_QrmmDj_HcBfQpJlJ3FjPHpU",
      authDomain: "map-illintsi.firebaseapp.com",
      projectId: "map-illintsi",
      storageBucket: "map-illintsi.appspot.com",
      messagingSenderId: "62267872375",
      appId: "1:62267872375:web:10945d2d63b93bccc5e272"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const formatDate = (str) => str ? new Date(str).toLocaleDateString("uk-UA", { day: '2-digit', month: '2-digit', year: '2-digit' }) : "";

    window.exportToExcel = async function() {
      if (!auth.currentUser) {
        alert('Будь ласка, увійдіть у систему для експорту.');
        return;
      }

      const XLSX = window.XLSX;
      const progressContainer = document.getElementById('progress-container');
      const progressFill = document.getElementById('progress-fill');
      const progressText = document.getElementById('progress-text');
      progressContainer.style.display = 'block';

      const dataRows = [];
      const maxTerritoryNumber = 102;

      for (let territoryNumber = 1; territoryNumber <= maxTerritoryNumber; territoryNumber++) {
        const historyQuery = query(
          collection(db, `territories/${territoryNumber}/history`),
          orderBy('timestamp', 'asc'), // старіші спочатку
          limit(4)
        );
        const historySnapshot = await getDocs(historyQuery);
        const history = [];
        historySnapshot.forEach(doc => history.push(doc.data()));

        const lastProcessedDate = [...history].reverse().find(r => r.dateProcess)?.dateProcess || "";

        const rowNames = [territoryNumber, formatDate(lastProcessedDate)];
        const rowDates = ["", ""];

        for (let i = 0; i < 4; i++) {
          rowNames.push(history[i]?.pib || "");
          rowNames.push(""); // для об’єднання
          rowDates.push(history[i]?.dateGet ? formatDate(history[i].dateGet) : "");
          rowDates.push(history[i]?.dateProcess ? formatDate(history[i].dateProcess) : "");
        }

        dataRows.push(rowNames);
        dataRows.push(rowDates);

        const progress = Math.round((territoryNumber / maxTerritoryNumber) * 100);
        progressFill.style.width = `${progress}%`;
        progressText.innerText = `Прогрес: ${progress}%`;
      }

      const header = [
        ["ЗАПИСИ ПРО ОПРАЦЮВАННЯ ТЕРИТОРІЙ", "", "", "", "", "", "", "", "", ""],
        ["№ території", "Остання дата опрацювання", "Вісник 1", "", "Вісник 2", "", "Вісник 3", "", "Вісник 4", ""],
        ["", "", "Дата отримання", "Дата опрацювання", "Дата отримання", "Дата опрацювання", "Дата отримання", "Дата опрацювання", "Дата отримання", "Дата опрацювання"]
      ];

      const worksheet = XLSX.utils.aoa_to_sheet([...header, ...dataRows]);

      // Об’єднання комірок
      worksheet['!merges'] = [
        { s: { r:0, c:0 }, e: { r:0, c:9 } },
        { s: { r:1, c:2 }, e: { r:1, c:3 } },
        { s: { r:1, c:4 }, e: { r:1, c:5 } },
        { s: { r:1, c:6 }, e: { r:1, c:7 } },
        { s: { r:1, c:8 }, e: { r:1, c:9 } },
      ];

      // Вертикальні об’єднання для № території та дати
      for (let i = 3; i < 3 + dataRows.length; i += 2) {
        worksheet['!merges'].push({ s: { r:i, c:0 }, e: { r:i+1, c:0 } });
        worksheet['!merges'].push({ s: { r:i, c:1 }, e: { r:i+1, c:1 } });
        worksheet['!merges'].push({ s: { r:i, c:2 }, e: { r:i, c:3 } });
        worksheet['!merges'].push({ s: { r:i, c:4 }, e: { r:i, c:5 } });
        worksheet['!merges'].push({ s: { r:i, c:6 }, e: { r:i, c:7 } });
        worksheet['!merges'].push({ s: { r:i, c:8 }, e: { r:i, c:9 } });
      }

      // Стиль чорної рамки
      const borderStyle = { top:{style:"thin", color:{rgb:"000000"}}, bottom:{style:"thin", color:{rgb:"000000"}}, left:{style:"thin", color:{rgb:"000000"}}, right:{style:"thin", color:{rgb:"000000"}} };

      const range = XLSX.utils.decode_range(worksheet['!ref']);
      for (let R = range.s.r; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= 9; ++C) {
          const cell_ref = XLSX.utils.encode_cell({ r: R, c: C });
          if (!worksheet[cell_ref]) worksheet[cell_ref] = { t: "s", v: "" };
          if (!worksheet[cell_ref].s) worksheet[cell_ref].s = {};
          worksheet[cell_ref].s.border = borderStyle;
        }
      }

      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Записи');
      XLSX.writeFile(workbook, 'ЗаписТериторій.xlsx');
      progressContainer.style.display = 'none';
    };
  </script>
</body>
</html>
