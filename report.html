<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Звіти по Територіях</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-6xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Звіти по Територіях</h1>

    <div class="space-y-4 mb-6">
      <button id="report-1" class="bg-blue-500 text-white px-4 py-2 rounded">Території "на руках"</button>
      <div>
        <label for="daysOnHands" class="block font-medium">Території "на руках" більше ніж (днів):</label>
        <input id="daysOnHands" type="number" class="border rounded p-2 w-32">
        <button id="report-2" class="bg-blue-500 text-white px-4 py-2 rounded ml-2">Звіт</button>
      </div>
      <button id="report-3" class="bg-blue-500 text-white px-4 py-2 rounded">Неопрацьовані території</button>
      <div>
        <label for="daysProcessed" class="block font-medium">Опрацьовані більше ніж (днів) тому:</label>
        <input id="daysProcessed" type="number" class="border rounded p-2 w-32">
        <button id="report-4" class="bg-blue-500 text-white px-4 py-2 rounded ml-2">Звіт</button>
      </div>
    </div>

    <div id="results" class="bg-white shadow p-4 rounded overflow-auto"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDracSUSYz_QrmmDj_HcBfQpJlJ3FjPHpU",
      authDomain: "map-illintsi.firebaseapp.com",
      projectId: "map-illintsi",
      storageBucket: "map-illintsi.appspot.com",
      messagingSenderId: "62267872375",
      appId: "1:62267872375:web:10945d2d63b93bccc5e272"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const results = document.getElementById('results');

    const formatDate = (str) => str ? new Date(str) : null;
    const daysBetween = (d1, d2) => Math.floor((d2 - d1) / (1000 * 60 * 60 * 24));

    onAuthStateChanged(auth, async user => {
      if (!user) {
        alert('Будь ласка, увійдіть у систему.');
        window.location.href = 'index.html';
        return;
      }

      async function fetchTerritories() {
        const maxTerritoryNumber = 102;
        const all = [];
        for (let t = 1; t <= maxTerritoryNumber; t++) {
          const q = query(collection(db, `territories/${t}/history`), orderBy('timestamp', 'desc'), limit(4));
          const snap = await getDocs(q);
          const records = [];
          snap.forEach(doc => records.push(doc.data()));
          all.push({ number: t, history: records });
        }
        return all;
      }

      function render(title, data) {
        results.innerHTML = `<h2 class="text-xl font-semibold mb-4">${title}</h2>` +
          (data.length > 0 ?
          `<table class="table-auto w-full text-sm"><thead><tr><th class="border px-2">#</th><th class="border px-2">Вісник</th><th class="border px-2">Територія</th><th class="border px-2">Дата отримання</th><th class="border px-2">Дата опрацювання</th></tr></thead><tbody>` +
          data.map((r, i) => `<tr><td class="border px-2">${i+1}</td><td class="border px-2">${r.pib}</td><td class="border px-2">${r.territory}</td><td class="border px-2">${r.dateGet || ''}</td><td class="border px-2">${r.dateProcess || ''}</td></tr>`).join('') +
          '</tbody></table>' : '<p>Даних не знайдено.</p>');
      }

      const allTerritories = await fetchTerritories();

      document.getElementById('report-1').onclick = () => {
        const filtered = [];
        allTerritories.forEach(t => {
          const h = t.history[0];
          if (h?.dateGet && !h?.dateProcess) {
            filtered.push({ territory: t.number, pib: h.pib || '', dateGet: h.dateGet, dateProcess: '' });
          }
        });
        render('Території "на руках"', filtered);
      };

      document.getElementById('report-2').onclick = () => {
        const days = parseInt(document.getElementById('daysOnHands').value);
        const filtered = [];
        allTerritories.forEach(t => {
          const h = t.history[0];
          const dGet = formatDate(h?.dateGet);
          if (dGet && !h?.dateProcess && daysBetween(dGet, new Date()) > days) {
            filtered.push({ territory: t.number, pib: h.pib || '', dateGet: h.dateGet, dateProcess: '' });
          }
        });
        render(`Території "на руках" більше ${days} днів`, filtered);
      };

      document.getElementById('report-3').onclick = () => {
        const filtered = allTerritories.filter(t => t.history.length === 0)
          .map(t => ({ territory: t.number, pib: '', dateGet: '', dateProcess: '' }));
        render('Неопрацьовані території', filtered);
      };

      document.getElementById('report-4').onclick = () => {
        const days = parseInt(document.getElementById('daysProcessed').value);
        const filtered = [];
        allTerritories.forEach(t => {
          const h = t.history[0];
          const dProc = formatDate(h?.dateProcess);
          if (dProc && daysBetween(dProc, new Date()) > days) {
            filtered.push({ territory: t.number, pib: h.pib || '', dateGet: h.dateGet, dateProcess: h.dateProcess });
          }
        });
        render(`Території опрацьовані більше ${days} днів тому`, filtered);
      };
    });
  </script>
</body>
</html>
