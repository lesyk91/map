<!DOCTYPE html>
<html lang="uk">
<head>
<meta name="robots" content="noindex, nofollow">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Планування завдань вісників</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 0px 0;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .card-title {
            font-size: 1.4rem;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .filter-group label {
            font-weight: 500;
            cursor: pointer;
        }
        
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .list-container {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 8px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: var(--light-color);
            font-weight: 600;
            cursor: pointer;
            position: sticky;
            top: 0;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        th:hover {
            background-color: #dfe6e9;
        }
        
        th.sorted-asc::after {
            content: " ▲";
            font-size: 0.8em;
            color: var(--secondary-color);
        }
        
        th.sorted-desc::after {
            content: " ▼";
            font-size: 0.8em;
            color: var(--secondary-color);
        }
        
        tr {
            transition: background-color 0.2s;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        tr.selected {
            background-color: #e1f5fe;
        }
        
        .input-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--dark-color);
        }
        
        input, select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .history-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 20px;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .history-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .history-filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .history-filter-group label {
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-active {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .sort-indicator {
            margin-left: 5px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .history-filters {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .filters {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .actions {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Планування завдань вісників</h1>
            <div class="subtitle" id="pageSubtitle">Система планування та відстеження завдань</div>
        </header>
        
        <div class="main-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Головні вісники</div>
                    <div class="record-count" id="mainCount">0 записів</div>
                </div>
                
                <div class="filters">
                    <div class="filter-group">
                        <input type="checkbox" id="filterMainBrother" checked>
                        <label for="filterMainBrother">Брати</label>
                    </div>
                    <div class="filter-group">
                        <input type="checkbox" id="filterMainSister" checked>
                        <label for="filterMainSister">Сестри</label>
                    </div>
                </div>
                
                <div class="list-container">
                    <table id="mainHeraldsTable">
                        <thead>
                            <tr>
                                <th data-sort="name">ПІБ</th>
                                <th data-sort="lastMain" class="sorted-asc">Ост.раз Голов.</th>
                                <th data-sort="lastPartner">Ост.раз Напар</th>
                                <th data-sort="lastTask">Ост.Завдання</th>
                            </tr>
                        </thead>
                        <tbody id="mainHeraldsBody">
                            <!-- Дані будуть додані через JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Напарники</div>
                    <div class="record-count" id="partnerCount">0 записів</div>
                </div>
                
                <div class="filters">
                    <div class="filter-group">
                        <input type="checkbox" id="filterPartnerBrother" checked>
                        <label for="filterPartnerBrother">Брати</label>
                    </div>
                    <div class="filter-group">
                        <input type="checkbox" id="filterPartnerSister" checked>
                        <label for="filterPartnerSister">Сестри</label>
                    </div>
                </div>
                
                <div class="list-container">
                    <table id="partnerHeraldsTable">
                        <thead>
                            <tr>
                                <th data-sort="name">ПІБ</th>
                                <th data-sort="lastPartner" class="sorted-asc">Ост.раз Напар</th>
                                <th data-sort="lastMain">Ост.раз Голов.</th>
                                <th data-sort="lastTogether">Коли в парі</th>
                                <th data-sort="lastTask">Ост.Завдання</th>
                            </tr>
                        </thead>
                        <tbody id="partnerHeraldsBody">
                            <!-- Дані будуть додані через JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="input-section">
            <div class="form-row">
                <div class="form-group">
                    <label for="taskNumber">Номер завдання:</label>
                    <select id="taskNumber">
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="taskDate">Дата:</label>
                    <input type="date" id="taskDate">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="mainHerald">Головний вісник:</label>
                    <input type="text" id="mainHerald" readonly>
                </div>
                
                <div class="form-group">
                    <label for="partnerHerald">Напарник:</label>
                    <input type="text" id="partnerHerald" readonly>
                </div>
            </div>
            
            <div class="form-group">
                <label for="taskSelect">Завдання:</label>
                <select id="taskSelect">
                    <option value="">-- Виберіть завдання --</option>
                    <!-- Завдання будуть додані через JavaScript -->
                </select>
            </div>
            
            <div class="actions">
                <button id="saveButton" class="btn-primary">Зберегти запис</button>
                <button id="updateButton" class="btn-success" style="display: none;">Оновити запис</button>
                <button id="deleteButton" class="btn-danger" style="display: none;">Видалити запис</button>
                <button id="cancelButton" class="btn-secondary">Скасувати</button>
            </div>
        </div>
        
        <div class="history-section">
            <div class="history-header">
                <div class="card-title">Історія завдань</div>
                <div class="record-count" id="historyCount">0 записів</div>
            </div>
            
            <div class="history-filters">
                <div class="history-filter-group">
                    <label for="filterMainHerald">Головний:</label>
                    <select id="filterMainHerald">
                        <option value="">Всі головні</option>
                    </select>
                </div>
                <div class="history-filter-group">
                    <label for="filterPartnerHerald">Напарник:</label>
                    <select id="filterPartnerHerald">
                        <option value="">Всі напарники</option>
                    </select>
                </div>
                <div class="history-filter-group">
                    <label for="filterDateFrom">Дата від:</label>
                    <input type="date" id="filterDateFrom">
                </div>
                <div class="history-filter-group">
                    <label for="filterDateTo">Дата до:</label>
                    <input type="date" id="filterDateTo">
                </div>
                <div class="history-filter-group">
                    <label>&nbsp;</label>
                    <button id="clearFilters" class="btn-secondary">Очистити фільтри</button>
                </div>
            </div>
            
            <div class="list-container">
                <table id="historyTable">
                    <thead>
                        <tr>
							 <th data-sort="serialNumber">№</th> 
                            <th data-sort="taskNumber">№ завдання</th>
                            <th data-sort="main">Головний</th>
                            <th data-sort="partner">Напарник</th>
                            <th data-sort="date">Дата</th>
                            <th data-sort="task">Завдання</th>
                            <th>Дії</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <!-- Історія буде додана через JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Firebase конфігурація
        const firebaseConfig = {
            apiKey: "AIzaSyCKOETwl_-0PD4qdgkazLECzy4w5BGs4nQ",
            authDomain: "school-82913.firebaseapp.com",
            projectId: "school-82913",
            storageBucket: "school-82913.firebasestorage.app",
            messagingSenderId: "753638595191",
            appId: "1:753638595191:web:7a4b1e4457782a14288472",
            measurementId: "G-8FVHRNMELV"
        };

        // Ініціалізація Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Глобальні змінні
		let nextSerialNumber = 1;
        let heraldsData = [];
        let tasksData = [];
        let historyData = [];
        let heraldTasksMap = new Map();
        let selectedMainHerald = null;
        let selectedPartnerHerald = null;
        let isEditMode = false;
        let editingRecordId = null;
        let mainBrotherSelected = true;
        let mainSisterSelected = true;
        let partnerBrotherSelected = true;
        let partnerSisterSelected = true;
        
        // Налаштування сортування
        let mainSortConfig = { column: 'lastMain', direction: 'asc' };
        let partnerSortConfig = { column: 'lastPartner', direction: 'asc' };
        let historySortConfig = { column: 'date', direction: 'desc' };
        
        // Фільтри історії
        let historyFilters = {
            mainHerald: '',
            partnerHerald: '',
            dateFrom: '',
            dateTo: ''
        };

        // DOM елементи
        const mainHeraldsBody = document.getElementById('mainHeraldsBody');
        const partnerHeraldsBody = document.getElementById('partnerHeraldsBody');
        const historyBody = document.getElementById('historyBody');
        const taskNumber = document.getElementById('taskNumber');
        const taskDate = document.getElementById('taskDate');
        const mainHerald = document.getElementById('mainHerald');
        const partnerHerald = document.getElementById('partnerHerald');
        const taskSelect = document.getElementById('taskSelect');
        const saveButton = document.getElementById('saveButton');
        const updateButton = document.getElementById('updateButton');
        const deleteButton = document.getElementById('deleteButton');
        const cancelButton = document.getElementById('cancelButton');
        const filterMainBrother = document.getElementById('filterMainBrother');
        const filterMainSister = document.getElementById('filterMainSister');
        const filterPartnerBrother = document.getElementById('filterPartnerBrother');
        const filterPartnerSister = document.getElementById('filterPartnerSister');
        const filterMainHerald = document.getElementById('filterMainHerald');
        const filterPartnerHerald = document.getElementById('filterPartnerHerald');
        const filterDateFrom = document.getElementById('filterDateFrom');
        const filterDateTo = document.getElementById('filterDateTo');
        const clearFilters = document.getElementById('clearFilters');
        const mainCount = document.getElementById('mainCount');
        const partnerCount = document.getElementById('partnerCount');
        const historyCount = document.getElementById('historyCount');
        const pageSubtitle = document.getElementById('pageSubtitle');

        // Ініціалізація додатка
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            taskDate.value = today.toISOString().split('T')[0];
            
            loadAllData();
            setupEventListeners();
        });

        // Завантаження всіх даних
        async function loadAllData() {
            try {
                await Promise.all([
                    loadHeraldsData(),
                    loadHeraldTasksData(),
                    loadTasksData(),
                    loadHistoryData()
                ]);
                console.log('Всі дані завантажено');
                
                // Оновлення відображення після завантаження всіх даних
                updateMainHeraldsList();
                if (selectedMainHerald) {
                    updatePartnerHeraldsList();
                }
            } catch (error) {
                console.error('Помилка при завантаженні даних:', error);
            }
        }

        // Налаштування обробників подій
        function setupEventListeners() {
            // Фільтри головних вісників
            filterMainBrother.addEventListener('change', function() {
                mainBrotherSelected = this.checked;
                updateMainHeraldsList();
            });
            
            filterMainSister.addEventListener('change', function() {
                mainSisterSelected = this.checked;
                updateMainHeraldsList();
            });
            
            // Фільтри напарників
            filterPartnerBrother.addEventListener('change', function() {
                partnerBrotherSelected = this.checked;
                updatePartnerHeraldsList();
            });
            
            filterPartnerSister.addEventListener('change', function() {
                partnerSisterSelected = this.checked;
                updatePartnerHeraldsList();
            });
            
            // Фільтри історії
            filterMainHerald.addEventListener('change', function() {
                historyFilters.mainHerald = this.value;
                updateHistoryTable();
            });
            
            filterPartnerHerald.addEventListener('change', function() {
                historyFilters.partnerHerald = this.value;
                updateHistoryTable();
            });
            
            filterDateFrom.addEventListener('change', function() {
                historyFilters.dateFrom = this.value;
                updateHistoryTable();
            });
            
            filterDateTo.addEventListener('change', function() {
                historyFilters.dateTo = this.value;
                updateHistoryTable();
            });
            
            clearFilters.addEventListener('click', function() {
                clearHistoryFilters();
            });
            
            // Кнопки форми
            saveButton.addEventListener('click', saveRecord);
            updateButton.addEventListener('click', updateRecord);
            deleteButton.addEventListener('click', deleteRecord);
            cancelButton.addEventListener('click', cancelEdit);
            
            // Сортування таблиць
            setupTableSorting();
        }

        // Налаштування сортування таблиць
        function setupTableSorting() {
            // Сортування головних вісників
            document.querySelectorAll('#mainHeraldsTable th[data-sort]').forEach(header => {
                header.addEventListener('click', function() {
                    const sortColumn = this.getAttribute('data-sort');
                    if (mainSortConfig.column === sortColumn) {
                        mainSortConfig.direction = mainSortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        mainSortConfig.column = sortColumn;
                        mainSortConfig.direction = 'asc';
                    }
                    updateMainHeraldsList();
                });
            });
            
            // Сортування напарників
            document.querySelectorAll('#partnerHeraldsTable th[data-sort]').forEach(header => {
                header.addEventListener('click', function() {
                    const sortColumn = this.getAttribute('data-sort');
                    if (partnerSortConfig.column === sortColumn) {
                        partnerSortConfig.direction = partnerSortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        partnerSortConfig.column = sortColumn;
                        partnerSortConfig.direction = 'asc';
                    }
                    updatePartnerHeraldsList();
                });
            });
            
            // Сортування історії
            document.querySelectorAll('#historyTable th[data-sort]').forEach(header => {
                header.addEventListener('click', function() {
                    const sortColumn = this.getAttribute('data-sort');
                    if (historySortConfig.column === sortColumn) {
                        historySortConfig.direction = historySortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        historySortConfig.column = sortColumn;
                        historySortConfig.direction = 'asc';
                    }
                    updateHistoryTable();
                });
            });
        }

        // Завантаження даних вісників
        async function loadHeraldsData() {
            try {
                const querySnapshot = await db.collection('visnyky').get();
                heraldsData = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    heraldsData.push({
                        id: doc.id,
                        name: data.name || '',
                        gender: data.gender || ''
                    });
                });
                updateMainHeraldsList();
            } catch (error) {
                console.error("Помилка при завантаженні вісників: ", error);
            }
        }

        // Завантаження завдань вісників
        async function loadHeraldTasksData() {
            try {
                const querySnapshot = await db.collection('visnykyTasks').get();
                heraldTasksMap.clear();
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const visnykId = data.visnykId;
                    const task = data.task;
                    
                    if (visnykId && task) {
                        if (!heraldTasksMap.has(visnykId)) {
                            heraldTasksMap.set(visnykId, new Set());
                        }
                        heraldTasksMap.get(visnykId).add(task);
                    }
                });
                
                updateMainHeraldsList();
            } catch (error) {
                console.error("Помилка при завантаженні завдань вісників: ", error);
            }
        }

        // Завантаження типів завдань
        function loadTasksData() {
            tasksData = [
                "Починаємо розмову",
                "Розвиваємо інтерес", 
                "Підготовка учнів",
                "Пояснюємо свої переконання"
            ];
            
            taskSelect.innerHTML = '<option value="">-- Виберіть завдання --</option>';
            tasksData.forEach(task => {
                const option = document.createElement('option');
                option.value = task;
                option.textContent = task;
                taskSelect.appendChild(option);
            });
        }

        // Завантаження історії завдань
// Завантаження історії завдань
async function loadHistoryData() {
    try {
        const querySnapshot = await db.collection('taskHistory').orderBy('date', 'desc').get();
        historyData = [];
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            historyData.push({
                id: doc.id,
                taskNumber: data.taskNumber || 1,
                mainHerald: data.mainHerald || '',
                partnerHerald: data.partnerHerald || '',
                date: data.date ? data.date.toDate() : new Date(),
                task: data.task || '',
                serialNumber: data.serialNumber || 0 // Додано це поле
            });
        });
        
        // Визначити наступний серійний номер
        if (historyData.length > 0) {
            const maxSerial = Math.max(...historyData.map(record => record.serialNumber || 0));
            nextSerialNumber = maxSerial + 1;
        } else {
            nextSerialNumber = 1;
        }
        
        updateHistoryFilters();
        updateHistoryTable();
    } catch (error) {
        console.error("Помилка при завантаженні історії: ", error);
        historyData = [];
        updateHistoryTable();
    }
}

        // Оновлення фільтрів історії
        function updateHistoryFilters() {
            const mainHeralds = [...new Set(historyData.map(record => record.mainHerald))].filter(Boolean);
            const partnerHeralds = [...new Set(historyData.map(record => record.partnerHerald))].filter(Boolean);
            
            // Оновлення випадаючих списків
            updateSelectOptions(filterMainHerald, mainHeralds, 'Всі головні');
            updateSelectOptions(filterPartnerHerald, partnerHeralds, 'Всі напарники');
        }

        function updateSelectOptions(selectElement, options, defaultText) {
            const currentValue = selectElement.value;
            selectElement.innerHTML = `<option value="">${defaultText}</option>`;
            
            options.sort().forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                selectElement.appendChild(optionElement);
            });
            
            // Відновлення вибраного значення
            if (options.includes(currentValue)) {
                selectElement.value = currentValue;
            }
        }

        // Очищення фільтрів історії
        function clearHistoryFilters() {
            filterMainHerald.value = '';
            filterPartnerHerald.value = '';
            filterDateFrom.value = '';
            filterDateTo.value = '';
            
            historyFilters = {
                mainHerald: '',
                partnerHerald: '',
                dateFrom: '',
                dateTo: ''
            };
            
            updateHistoryTable();
        }

        // Перевірка можливості виконання завдань
        function canPerformMainDialog(visnykId) {
            const tasks = heraldTasksMap.get(visnykId);
            return tasks && tasks.has('Діалог Головний');
        }

        function canPerformPartnerDialog(visnykId) {
            const tasks = heraldTasksMap.get(visnykId);
            return tasks && tasks.has('Діалог Партнер');
        }

        // Оновлення списку головних вісників з сортуванням
        function updateMainHeraldsList() {
            let filteredHeralds = heraldsData.filter(herald => {
                if (herald.gender === 'брат' && !mainBrotherSelected) return false;
                if (herald.gender === 'сестра' && !mainSisterSelected) return false;
                return canPerformMainDialog(herald.id);
            });

            // Сортування
            filteredHeralds.sort((a, b) => {
                const aInfo = getLastDatesForHerald(a.name);
                const bInfo = getLastDatesForHerald(b.name);
                
                let aValue, bValue;
                
                switch (mainSortConfig.column) {
                    case 'name':
                        aValue = a.name;
                        bValue = b.name;
                        break;
                    case 'lastMain':
                        aValue = aInfo.lastMainDate ? new Date(aInfo.lastMainDate) : new Date(0);
                        bValue = bInfo.lastMainDate ? new Date(bInfo.lastMainDate) : new Date(0);
                        break;
                    case 'lastPartner':
                        aValue = aInfo.lastPartnerDate ? new Date(aInfo.lastPartnerDate) : new Date(0);
                        bValue = bInfo.lastPartnerDate ? new Date(bInfo.lastPartnerDate) : new Date(0);
                        break;
                    case 'lastTask':
                        aValue = aInfo.lastTask || '';
                        bValue = bInfo.lastTask || '';
                        break;
                    default:
                        return 0;
                }
                
                let result = 0;
                if (typeof aValue === 'string') {
                    result = aValue.localeCompare(bValue);
                } else {
                    result = aValue - bValue;
                }
                
                return mainSortConfig.direction === 'desc' ? -result : result;
            });

            renderMainHeraldsTable(filteredHeralds);
        }

        function renderMainHeraldsTable(heralds) {
            mainHeraldsBody.innerHTML = '';
            mainCount.textContent = `${heralds.length} записів`;
            
            if (heralds.length === 0) {
                mainHeraldsBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <div>Немає вісників, що відповідають критеріям</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Оновлення індикаторів сортування
            updateSortIndicators('mainHeraldsTable', mainSortConfig);
            
            heralds.forEach(herald => {
                const lastDates = getLastDatesForHerald(herald.name);
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${herald.name}</td>
                    <td>${formatDaysDifference(lastDates.lastMainDate)}</td>
                    <td>${formatDaysDifference(lastDates.lastPartnerDate)}</td>
                    <td>${lastDates.lastTask || 'Не виконував'}</td>
                `;
                
                row.addEventListener('click', () => {
                    document.querySelectorAll('#mainHeraldsBody tr').forEach(r => {
                        r.classList.remove('selected');
                    });
                    row.classList.add('selected');
                    selectedMainHerald = herald;
                    mainHerald.value = herald.name;
                    updatePartnerHeraldsList();
                });
                
                mainHeraldsBody.appendChild(row);
            });
        }

        // Оновлення списку напарників з сортуванням
        function updatePartnerHeraldsList() {
            if (!selectedMainHerald) {
                partnerHeraldsBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div>Спочатку виберіть головного вісника</div>
                        </td>
                    </tr>
                `;
                partnerCount.textContent = '0 записів';
                return;
            }
            
            let filteredHeralds = heraldsData.filter(herald => {
                if (herald.id === selectedMainHerald.id) return false;
                if (herald.gender === 'брат' && !partnerBrotherSelected) return false;
                if (herald.gender === 'сестра' && !partnerSisterSelected) return false;
                return canPerformPartnerDialog(herald.id);
            });

            // Сортування
            filteredHeralds.sort((a, b) => {
                const aInfo = getPartnerInfo(a.name, selectedMainHerald.name);
                const bInfo = getPartnerInfo(b.name, selectedMainHerald.name);
                
                let aValue, bValue;
                
                switch (partnerSortConfig.column) {
                    case 'name':
                        aValue = a.name;
                        bValue = b.name;
                        break;
                    case 'lastPartner':
                        aValue = aInfo.lastPartnerDate ? new Date(aInfo.lastPartnerDate) : new Date(0);
                        bValue = bInfo.lastPartnerDate ? new Date(bInfo.lastPartnerDate) : new Date(0);
                        break;
                    case 'lastMain':
                        aValue = aInfo.lastMainDate ? new Date(aInfo.lastMainDate) : new Date(0);
                        bValue = bInfo.lastMainDate ? new Date(bInfo.lastMainDate) : new Date(0);
                        break;
                    case 'lastTogether':
                        aValue = aInfo.lastDateTogether ? new Date(aInfo.lastDateTogether) : new Date(0);
                        bValue = bInfo.lastDateTogether ? new Date(bInfo.lastDateTogether) : new Date(0);
                        break;
                    case 'lastTask':
                        aValue = aInfo.lastTask || '';
                        bValue = bInfo.lastTask || '';
                        break;
                    default:
                        return 0;
                }
                
                let result = 0;
                if (typeof aValue === 'string') {
                    result = aValue.localeCompare(bValue);
                } else {
                    result = aValue - bValue;
                }
                
                return partnerSortConfig.direction === 'desc' ? -result : result;
            });

            renderPartnerHeraldsTable(filteredHeralds);
        }

        function renderPartnerHeraldsTable(heralds) {
            partnerHeraldsBody.innerHTML = '';
            partnerCount.textContent = `${heralds.length} записів`;
            
            if (heralds.length === 0) {
                partnerHeraldsBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div>Немає напарників, що відповідають критеріям</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Оновлення індикаторів сортування
            updateSortIndicators('partnerHeraldsTable', partnerSortConfig);
            
            heralds.forEach(herald => {
                const partnerInfo = getPartnerInfo(herald.name, selectedMainHerald.name);
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${herald.name}</td>
                    <td>${formatDaysDifference(partnerInfo.lastPartnerDate)}</td>
                    <td>${formatDaysDifference(partnerInfo.lastMainDate)}</td>
                    <td>${formatDaysDifference(partnerInfo.lastDateTogether)}</td>
                    <td>${partnerInfo.lastTask || 'Не виконував'}</td>
                `;
                
                if (partnerInfo.workedTogether) {
                    row.style.color = '#a07800';
                }
                
                row.addEventListener('click', () => {
                    document.querySelectorAll('#partnerHeraldsBody tr').forEach(r => {
                        r.classList.remove('selected');
                    });
                    row.classList.add('selected');
                    selectedPartnerHerald = herald;
                    partnerHerald.value = herald.name;
                });
                
                partnerHeraldsBody.appendChild(row);
            });
        }

        // Оновлення індикаторів сортування
        function updateSortIndicators(tableId, sortConfig) {
            const table = document.getElementById(tableId);
            const headers = table.querySelectorAll('th[data-sort]');
            
            headers.forEach(header => {
                header.classList.remove('sorted-asc', 'sorted-desc');
                if (header.getAttribute('data-sort') === sortConfig.column) {
                    header.classList.add(sortConfig.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            });
        }

        // Оновлення таблиці історії з фільтрацією та сортуванням
// Оновлення таблиці історії з фільтрацією та сортуванням
function updateHistoryTable() {
    let filteredHistory = historyData.filter(record => {
        if (historyFilters.mainHerald && record.mainHerald !== historyFilters.mainHerald) return false;
        if (historyFilters.partnerHerald && record.partnerHerald !== historyFilters.partnerHerald) return false;
        
        const recordDate = new Date(record.date);
        if (historyFilters.dateFrom && recordDate < new Date(historyFilters.dateFrom)) return false;
        if (historyFilters.dateTo && recordDate > new Date(historyFilters.dateTo + 'T23:59:59')) return false;
        
        return true;
    });

    // Сортування історії
    filteredHistory.sort((a, b) => {
        let aValue, bValue;
        
        switch (historySortConfig.column) {
            case 'serialNumber': // Додано новий case
                aValue = a.serialNumber || 0;
                bValue = b.serialNumber || 0;
                break;
            case 'taskNumber':
                aValue = a.taskNumber;
                bValue = b.taskNumber;
                break;
            case 'main':
                aValue = a.mainHerald;
                bValue = b.mainHerald;
                break;
            case 'partner':
                aValue = a.partnerHerald;
                bValue = b.partnerHerald;
                break;
            case 'date':
                aValue = new Date(a.date);
                bValue = new Date(b.date);
                break;
            case 'task':
                aValue = a.task;
                bValue = b.task;
                break;
            default:
                return 0;
        }
        
        let result = 0;
        if (typeof aValue === 'string') {
            result = aValue.localeCompare(bValue);
        } else {
            result = aValue - bValue;
        }
        
        return historySortConfig.direction === 'desc' ? -result : result;
    });

    renderHistoryTable(filteredHistory);
}

function renderHistoryTable(records) {
    historyBody.innerHTML = '';
    historyCount.textContent = `${records.length} записів`;
    
    if (records.length === 0) {
        historyBody.innerHTML = `
            <tr>
                <td colspan="7" class="empty-state"> <!-- Змінити з 6 на 7 -->
                    <div>Історія завдань порожня</div>
                </td>
            </tr>
        `;
        return;
    }
    
    // Оновлення індикаторів сортування
    updateSortIndicators('historyTable', historySortConfig);
    
    records.forEach(record => {
        const row = document.createElement('tr');
        const date = record.date instanceof Date ? record.date : record.date.toDate();
        
        row.innerHTML = `
            <td>${record.serialNumber || ''}</td> <!-- Додано цей стовпець -->
            <td>${record.taskNumber}</td>
            <td>${record.mainHerald}</td>
            <td>${record.partnerHerald}</td>
            <td>${formatDate(date)}</td>
            <td>${record.task}</td>
            <td>
                <button class="btn-secondary edit-record" data-id="${record.id}">Редагувати</button>
            </td>
        `;
        
        historyBody.appendChild(row);
    });
    
    // Додати обробники подій для кнопок редагування
    document.querySelectorAll('.edit-record').forEach(button => {
        button.addEventListener('click', function() {
            const recordId = this.getAttribute('data-id');
            editRecord(recordId);
        });
    });
}

        // Отримання останніх дат для вісника
        function getLastDatesForHerald(heraldName) {
            // Видаляємо зайві пробіли з імені
            const cleanHeraldName = heraldName.trim();
            
            let lastMainDate = null;
            let lastPartnerDate = null;
            let lastTask = 'Не виконував';
            
            // Шукаємо останню дату коли вісник був головним
            const mainRecords = historyData.filter(record => {
                const cleanMainHerald = record.mainHerald ? record.mainHerald.trim() : '';
                return cleanMainHerald === cleanHeraldName;
            });
            
            if (mainRecords.length > 0) {
                // Сортуємо за датою (від найновішої до найстарішої)
                mainRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                lastMainDate = mainRecords[0].date;
                lastTask = mainRecords[0].task;
            }
            
            // Шукаємо останню дату коли вісник був напарником
            const partnerRecords = historyData.filter(record => {
                const cleanPartnerHerald = record.partnerHerald ? record.partnerHerald.trim() : '';
                return cleanPartnerHerald === cleanHeraldName;
            });
            
            if (partnerRecords.length > 0) {
                // Сортуємо за датою (від найновішої до найстарішої)
                partnerRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                lastPartnerDate = partnerRecords[0].date;
            }
            
            return {
                lastMainDate,
                lastPartnerDate,
                lastTask
            };
        }

        // Отримання інформації про напарника
        function getPartnerInfo(partnerName, mainName) {
            // Видаляємо зайві пробіли з імен
            const cleanPartnerName = partnerName.trim();
            const cleanMainName = mainName.trim();
            
            let lastPartnerDate = null;
            let lastMainDate = null;
            let lastDateTogether = null;
            let lastTask = 'Не виконував';
            let workedTogether = false;
            
            // Шукаємо записи де напарник був напарником
            const partnerRecords = historyData.filter(record => {
                const cleanPartnerHerald = record.partnerHerald ? record.partnerHerald.trim() : '';
                return cleanPartnerHerald === cleanPartnerName;
            });
            
            if (partnerRecords.length > 0) {
                partnerRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                lastPartnerDate = partnerRecords[0].date;
                lastTask = partnerRecords[0].task;
            }
            
            // Шукаємо записи де напарник був головним
            const mainRecords = historyData.filter(record => {
                const cleanMainHerald = record.mainHerald ? record.mainHerald.trim() : '';
                return cleanMainHerald === cleanPartnerName;
            });
            
            if (mainRecords.length > 0) {
                mainRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                lastMainDate = mainRecords[0].date;
            }
            
            // Шукаємо записи де вони працювали разом
            const togetherRecords = historyData.filter(record => {
                const cleanMainHerald = record.mainHerald ? record.mainHerald.trim() : '';
                const cleanPartnerHerald = record.partnerHerald ? record.partnerHerald.trim() : '';
                
                return (cleanMainHerald === cleanMainName && cleanPartnerHerald === cleanPartnerName) ||
                       (cleanMainHerald === cleanPartnerName && cleanPartnerHerald === cleanMainName);
            });
            
            if (togetherRecords.length > 0) {
                workedTogether = true;
                togetherRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                lastDateTogether = togetherRecords[0].date;
            }
            
            return {
                lastPartnerDate,
                lastMainDate,
                lastDateTogether,
                lastTask,
                workedTogether
            };
        }

        // Форматування різниці днів з кольором
        function formatDaysDifference(date) {
            if (!date) return '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const targetDate = new Date(date);
            targetDate.setHours(0, 0, 0, 0);
            
            const diffTime = today - targetDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return '0 дн.';
            } else if (diffDays > 0) {
                return `${diffDays} дн. тому`;
            } else {
                return `<span style="color: red;">${Math.abs(diffDays)} дн.</span>`;
            }
        }

function saveRecord() {
    if (!validateInput()) return;
    
    const record = {
        taskNumber: parseInt(taskNumber.value),
        mainHerald: mainHerald.value,
        partnerHerald: partnerHerald.value,
        date: new Date(taskDate.value),
        task: taskSelect.value,
        serialNumber: nextSerialNumber // Додано це поле
    };
    
    db.collection('taskHistory').add(record)
        .then(() => {
            nextSerialNumber++; // Збільшити для наступного запису
            alert('Запис успішно збережено!');
            clearForm();
            loadHistoryData();
            updateMainHeraldsList();
            
            if (selectedMainHerald) {
                updatePartnerHeraldsList();
            }
        })
        .catch((error) => {
            console.error("Помилка при збереженні запису: ", error);
            alert('Помилка при збереженні запису: ' + error.message);
        });
}

function editRecord(recordId) {
    const record = historyData.find(r => r.id === recordId);
    if (!record) return;
    
    isEditMode = true;
    editingRecordId = recordId;
    
    taskNumber.value = record.taskNumber;
    taskDate.value = formatDateForInput(record.date);
    mainHerald.value = record.mainHerald;
    partnerHerald.value = record.partnerHerald;
    taskSelect.value = record.task;
    
    saveButton.style.display = 'none';
    updateButton.style.display = 'inline-block';
    deleteButton.style.display = 'inline-block'; // Змінити з 'none' на 'inline-block'
    pageSubtitle.textContent = 'Режим редагування запису';
    
    document.querySelector('.input-section').scrollIntoView({ behavior: 'smooth' });
}

function updateRecord() {
    if (!validateInput()) return;
    
    const currentRecord = historyData.find(record => record.id === editingRecordId);
    
    const record = {
        taskNumber: parseInt(taskNumber.value),
        mainHerald: mainHerald.value,
        partnerHerald: partnerHerald.value,
        date: new Date(taskDate.value),
        task: taskSelect.value,
        serialNumber: currentRecord.serialNumber // Зберегти оригінальний номер
    };
    
    db.collection('taskHistory').doc(editingRecordId).update(record)
        .then(() => {
            alert('Запис успішно оновлено!');
            cancelEdit();
            loadHistoryData();
            updateMainHeraldsList();
            
            if (selectedMainHerald) {
                updatePartnerHeraldsList();
            }
        })
        .catch((error) => {
            console.error("Помилка при оновленні запису: ", error);
            alert('Помилка при оновленні запису: ' + error.message);
        });
}

        function deleteRecord() {
            if (!confirm('Ви впевнені, що хочете видалити цей запис?')) return;
            
            db.collection('taskHistory').doc(editingRecordId).delete()
                .then(() => {
                    alert('Запис успішно видалено!');
                    cancelEdit();
                    loadHistoryData();
                    updateMainHeraldsList();
                    
                    if (selectedMainHerald) {
                        updatePartnerHeraldsList();
                    }
                })
                .catch((error) => {
                    console.error("Помилка при видаленні запису: ", error);
                    alert('Помилка при видаленні запису: ' + error.message);
                });
        }

function cancelEdit() {
    isEditMode = false;
    editingRecordId = null;
    
    saveButton.style.display = 'inline-block';
    updateButton.style.display = 'none';
    deleteButton.style.display = 'none'; // Залишаємо прихованою
    pageSubtitle.textContent = 'Система планування та відстеження завдань';
    
    clearForm();
}

        function validateInput() {
            if (!mainHerald.value) {
                alert('Будь ласка, виберіть головного вісника');
                return false;
            }
            
            if (!partnerHerald.value) {
                alert('Будь ласка, виберіть напарника');
                return false;
            }
            
            if (!taskSelect.value) {
                alert('Будь ласка, виберіть завдання');
                return false;
            }
            
            if (!taskDate.value) {
                alert('Будь ласка, введіть дату');
                return false;
            }
            
            return true;
        }

        function clearForm() {
            mainHerald.value = '';
            partnerHerald.value = '';
            taskSelect.value = '';
            taskNumber.value = '1';
            
            document.querySelectorAll('tr.selected').forEach(row => {
                row.classList.remove('selected');
            });
            
            selectedMainHerald = null;
            selectedPartnerHerald = null;
            
            updatePartnerHeraldsList();
            taskDate.value = new Date().toISOString().split('T')[0];
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString('uk-UA');
        }
        
        function formatDateForInput(date) {
            return new Date(date).toISOString().split('T')[0];
        }
    </script>
</body>
</html>