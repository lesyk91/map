<!DOCTYPE html>
<html lang="uk">
<head>
  <meta name="robots" content="noindex, nofollow">
  <meta charset="utf-8" />
  <title>–ö–∞—Ä—Ç–∞ –¢–µ—Ä–∏—Ç–æ—Ä—ñ–π "–Ü–ª–ª—ñ–Ω—Ü—ñ" –∑ Google Maps</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <script src="try.js" defer></script>
  <style>
    html,body,#map {height: 100%;margin: 0;padding: 0;}
    button.locate-btn, button.layer-toggle, button.toggle-all, button.highlight-free, button.highlight-taken {
      position: absolute;
      left: 50px;
      z-index: 1000;
      padding: 8px 12px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }
    button.locate-btn {top: 10px;}
    button.layer-toggle {top: 50px;}
    button.toggle-all {top: 90px;}
    button.highlight-free {top: 130px;}
    button.highlight-taken {top: 170px;}

    #loader {
      position: absolute;top: 10px;left: 215px;z-index: 1000;
      padding: 8px;background: white;border: 1px solid #ccc;
      border-radius: 10px;
    }
  </style>
</head>
<body>
<button onclick="findLocation()" class="locate-btn">üìç –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ</button>
<button onclick="toggleLayers()" class="layer-toggle">üó∫ –®–∞—Ä–∏</button>
<button onclick="toggleAll()" class="toggle-all">üó∫ –ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ / –ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ</button>
<button onclick="highlightStatus('–≤—ñ–ª—å–Ω–æ')" class="highlight-free">–ü–æ—Å–≤—ñ—Ç–∏—Ç–∏ –≤—Å—ñ –≤—ñ–ª—å–Ω–æ</button>
<button onclick="highlightStatus('–Ω–∞ —Ä—É–∫–∞—Ö')" class="highlight-taken">–ü–æ—Å–≤—ñ—Ç–∏—Ç–∏ –≤—Å—ñ –Ω–∞ —Ä—É–∫–∞—Ö</button>

<div id="loader"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDracSUSYz_QrmmDj_HcBfQpJlJ3FjPHpU",
    authDomain: "map-illintsi.firebaseapp.com",
    projectId: "map-illintsi",
    storageBucket: "map-illintsi.appspot.com",
    messagingSenderId: "62267872375",
    appId: "1:62267872375:web:10945d2d63b93bccc5e272"
  };
  
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  let currentUser = null;

  onAuthStateChanged(auth, user => {
    currentUser = user;
  });

  window.getTerritoryStatusPopup = async (number, name) => {
    if (!currentUser) return `<b>${name}</b><br><i>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å</i>`;
    const q = query(collection(db, `territories/${number}/history`), orderBy("timestamp", "desc"));
    const snap = await getDocs(q);
    let popup = `<b>${name}</b><br>`;
    if (snap.empty) {
      popup += `<b>–°—Ç–∞—Ç—É—Å:</b> –≤—ñ–ª—å–Ω–æ`;
    } else {
      const data = snap.docs[0].data();
      popup += `<b>–°—Ç–∞—Ç—É—Å:</b> ${data.status}<br>`;
      if (data.status === "–Ω–∞ —Ä—É–∫–∞—Ö") {
        popup += `<b>–ü–Ü–ë:</b> ${data.pib}<br>`;
        popup += `<b>–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è:</b> ${new Date(data.dateGet).toLocaleDateString("uk-UA")}`;

      }
    }
    return popup;
  };
</script>

<script>
  const map = L.map('map').setView([49.1029, 29.2074], 13);

  const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
    attribution: '¬© Google Maps'
  }).addTo(map);

  const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution:'¬© Esri', maxZoom:20
  });

  const districts = [
    { id:'district1', name:'–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 1', color:'blue', fillColor:'#99ccff' },
    { id:'district2', name:'–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 2', color:'green', fillColor:'#b6fcb6' },
    { id:'district55', name:'–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 55', color:'green', fillColor:'#b6fcb6' },
    { id:'district56', name:'–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 56', color:'red', fillColor:'#b6fcb6' }
  ];

  const districtGeometries = [];

  let loadedLayers = [];

  async function loadDistricts(){
    for (const d of districts){
      const layer = L.layerGroup();
      showLoading(true);
      try {
        const res = await fetch(`${d.id}.json`);
        const data = await res.json();

        const geoJson = L.geoJSON(data, {
          onEachFeature: async (feature, layer) => {
            const center = layer.getBounds().getCenter();

            layer.on("click", async () => {
              const popupContent = await window.getTerritoryStatusPopup(d.id.replace("district",""), d.name);
              layer.bindPopup(popupContent + `<br><button onclick="routeToDistrict('${d.name}')">üìå –ü—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç —Å—é–¥–∏</button>`).openPopup();

              if (popupContent.indexOf("–Ω–∞ —Ä—É–∫–∞—Ö") !== -1) {
                districtGeometries.find(el=>el.id===d.id).status = "–Ω–∞ —Ä—É–∫–∞—Ö";
              } else if (popupContent.indexOf("–≤—ñ–ª—å–Ω–æ") !== -1) {
                districtGeometries.find(el=>el.id===d.id).status = "–≤—ñ–ª—å–Ω–æ";
              }
            });
          },
          style:{ color: d.color, fillColor: d.fillColor, fillOpacity: 0.4 }
        }).addTo(layer);

        const coords = [];

        const geoms = data?.type==='GeometryCollection'?data.geometries:[data.geometry];
        geoms?.forEach(geom=>{
          if (geom?.type==='Polygon') {
            geom.coordinates[0].forEach(ring=>{
              coords.push(L.latLng(ring[1],ring[0]));
            });
          }
        });

        layer.addTo(map);
        loadedLayers.push(d.name);
        districtGeometries.push({ 
          id: d.id, 
          name: d.name, 
          color: d.color, 
          fillColor: d.fillColor, 
          layer: geoJson, 
          coords, 
          status:''
        });

      } catch (err) {
        console.error(err);
      } finally {
        showLoading(false);
      }
    }
  }
  loadDistricts();

  function showLoading(show){
    document.getElementById('loader').innerText = show ? '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...' : '';
  }
  
  let routeControl = null;
  let currentLocation = null;
  let currentMarker = null;
  let currentCircle = null;

  function findLocation(){
    if (!navigator.geolocation) return alert('–ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è');
    showLoading(true);
    map.locate({setView:true,maxZoom:16,timeout:20000,enableHighAccuracy:true});
  }
  
  map.on('locationfound',(e)=>{
    currentLocation = e.latlng;
    showLoading(false);
    if (currentMarker) map.removeLayer(currentMarker);
    if (currentCircle) map.removeLayer(currentCircle);
    currentMarker = L.marker(e.latlng).addTo(map).bindPopup("–í–∞—à–µ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è").openPopup();
    currentCircle = L.circle(e.latlng,{radius:e.accuracy,color:'blue',fillColor:'#30f',fillOpacity:0.2}).addTo(map);
  });

  map.on('locationerror',(e)=>{
    showLoading(false);
    alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è.");
  });

  window.routeToDistrict = function(districtName){
    if (!currentLocation) return alert("–°–ø–æ—á–∞—Ç–∫—É –≤–∏–∑–Ω–∞—á—ñ—Ç—å –º—ñ—Å—Ü–µ —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è.");

    const d = districtGeometries.find(el=>el.name===districtName);
    if (!d) return;

    let nearestPoint = d.coords.reduce((nearest,c)=>{
      return currentLocation.distanceTo(c) < currentLocation.distanceTo(nearest) ? c : nearest;
    });

    if (routeControl) map.removeControl(routeControl);
    routeControl = L.Routing.control({ 
      waypoints:[currentLocation, nearestPoint],
      routeWhileDragging:false, addWaypoints:false, show:false, createMarker:()=>null
    }).addTo(map);
  };

  window.toggleAll = function(){
    for (let d of districtGeometries){
      if (map.hasLayer(d.layer)) {
        map.removeLayer(d.layer);
      } else {
        d.layer.addTo(map);
      }
    }
  };

  window.highlightStatus = function(status){
    for (let d of districtGeometries){
      if (d.status === status){
        d.layer.setStyle({ color:'yellow', fillColor:'yellow' });
      } else {
        d.layer.setStyle({ color: d.color, fillColor: d.fillColor });
      }
    }
  };
</script>

</body>
</html>
