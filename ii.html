<!DOCTYPE html>
<html lang="uk">
<head>
<meta name="robots" content="noindex, nofollow">
<meta charset="utf-8" />
<title>–ö–∞—Ä—Ç–∞ –¢–µ—Ä–∏—Ç–æ—Ä—ñ–π "–Ü–ª–ª—ñ–Ω—Ü—ñ" –∑ Google Maps</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<style>
html,body,#map {height: 100%;margin: 0;padding: 0;}
button.layer-toggle,button.locate-btn,button.login-btn,button.logout-btn {
	position: absolute;
	left: 50px;
	z-index: 1000;
	padding: 8px 12px;
	background: white;
	border: 1px solid #ccc;
	border-radius: 4px;
	cursor: pointer;
}
button.locate-btn {top: 10px;}
button.layer-toggle {top: 50px;}
button.login-btn,button.logout-btn {top: 90px;}
#loader {position: absolute;top: 10px;left: 215px;z-index: 1000;padding: 8px;background: white;border: 1px solid #ccc;border-radius: 10px;}
</style>
</head>
<body>
<button onclick="findLocation()" class="locate-btn">üìç –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ</button>
<button onclick="toggleLayers()" class="layer-toggle">üó∫ –®–∞—Ä–∏</button>
<div id="auth-buttons">
  <a href="enter.html"><button class="login-btn" style="display:none">üîê –£–≤—ñ–π—Ç–∏</button></a>
  <button class="logout-btn" style="display:none">üö™ –í–∏–π—Ç–∏</button>
</div>
<div id="loader"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDracSUSYz_QrmmDj_HcBfQpJlJ3FjPHpU",
  authDomain: "map-illintsi.firebaseapp.com",
  projectId: "map-illintsi",
  storageBucket: "map-illintsi.appspot.com",
  messagingSenderId: "62267872375",
  appId: "1:62267872375:web:10945d2d63b93bccc5e272"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
let currentUser = null;

const loginBtn = document.querySelector('.login-btn');
const logoutBtn = document.querySelector('.logout-btn');

onAuthStateChanged(auth, user => {
  currentUser = user;
  if (user) {
    loginBtn.style.display = 'none';
    logoutBtn.style.display = 'inline-block';
  } else {
    loginBtn.style.display = 'inline-block';
    logoutBtn.style.display = 'none';
  }
});

logoutBtn?.addEventListener("click", async () => {
  await signOut(auth);
  location.reload();
});

// findLocation —Ñ—É–Ω–∫—Ü–∏—è
function findLocation(){
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        L.marker([lat, lng]).addTo(map).bindPopup("–¢–∏ —Ç—É—Ç").openPopup();
        map.setView([lat, lng], 15);
      },
      (err) => {
        console.error(err);
        alert("–ù–µ –º–æ–∂—É –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è.");
      }
    )
  } else {
    alert("–ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è.");
  }
}

window.findLocation = findLocation;

// —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏
const map = L.map('map').setView([49.1029, 29.2074], 13);
const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
  maxZoom: 20,
  subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
  attribution: '¬© Google Maps'
}).addTo(map);
const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: '¬© Esri',
  maxZoom: 20
});

// —Å—Ç–≤–æ—Ä—é—î–º–æ control —Ä–∞–Ω—ñ—à–µ
const baseMaps = { "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –∫–∞—Ä—Ç–∞": googleStreets, "–°—É–ø—É—Ç–Ω–∏–∫–æ–≤–∞ –∫–∞—Ä—Ç–∞": satellite };
const overlays = {};

const layerControl = L.control.layers(baseMaps, overlays, { collapsed: true }).addTo(map);

// –í–∫–∞–∑—É—î–º–æ –≤—Å—ñ —Ä–∞–π–æ–Ω–∏
const districts = [
  { id:'district1', name:'–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 1', color:'blue', fillColor:'#99ccff' },
  { id:'district2', name:'–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 2', color:'green', fillColor:'#b6fcb6' },
  { id:'district55', name:'–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 55', color:'green', fillColor:'#b6fcb6' },
  { id:'district56', name:'–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 56', color:'red', fillColor:'#b6fcb6' }
  // –¢—É—Ç –≤–∏ –ø–æ—Ç—ñ–º –¥–æ–¥–∞—Å—Ç–µ –≤—Å—ñ 150...
];

// —â–æ–± –ª–µ–≥—à–µ –±—É–ª–æ –ø–µ—Ä–µ–π—Ç–∏ –ø–æ—Ç—ñ–º –¥–æ –≤—Å—ñ—î—ó –ª–æ–≥—ñ–∫–∏
window.districts = districts;

const loadedLayers = [];

function showLoading(show) {
  document.getElementById('loader').innerText = show ? '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...' : '';
}

function toggleLayers(){
  const control = document.querySelector('.leaflet-control-layers'); 
  if (control) control.classList.toggle('leaflet-control-layers-expanded'); 
  const btn = document.querySelector('.layer-toggle'); 
  btn.innerText = control?.classList.contains('leaflet-control-layers-expanded') ? 'üó∫ –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —à–∞—Ä–∏' : 'üó∫ –®–∞—Ä–∏';
}

window.toggleLayers = toggleLayers;

function routeToDistrict(districtName) {
  if (!currentLocation) return alert("‚õî –°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å üìç ¬´–ü–æ–∫–∞–∑–∞—Ç–∏ –º—ñ—Å—Ü–µ¬ª"); 
  const district = districtGeometries.find(d => d.name === districtName);
  if (!district || !district.coordinates.length) return alert(`‚ö† –ù–µ–º–∞—î –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è ${districtName}`);

  let nearestPoint = district.coordinates.reduce((nearest, coord) => currentLocation.distanceTo(coord) < currentLocation.distanceTo(nearest) ? coord : nearest);
  if (routeControl) map.removeControl(routeControl);
  routeControl = L.Routing.control({ 
    waypoints: [currentLocation, nearestPoint],
    routeWhileDragging: false,
    addWaypoints: false,
    show: false,
    createMarker: () => null
  }).addTo(map);
}

window.routeToDistrict = routeToDistrict;

async function getTerritoryStatusPopup(number, name) {
  if (!currentUser) return `<b>${name}</b><br><i>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å</i>`;
  const q = query(collection(db, `territories/${number}/history`), orderBy("timestamp", "desc"));
  const snap = await getDocs(q);
  let popup = `<b>${name}</b><br>`;
  if (snap.empty) {
    popup += `<b>–°—Ç–∞—Ç—É—Å:</b> –≤—ñ–ª—å–Ω–æ`; 
  } else {
    const data = snap.docs[0].data();
    popup += `<b>–°—Ç–∞—Ç—É—Å:</b> ${data.status}<br>`;
    if (data.status === "–Ω–∞ —Ä—É–∫–∞—Ö") {
      popup += `<b>–ü–Ü–ë:</b> ${data.pib}<br>`;
      popup += `<b>–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è:</b> ${new Date(data.dateGet).toLocaleDateString("uk-UA")}`;

    }
  }
  return popup;
}

window.getTerritoryStatusPopup = getTerritoryStatusPopup;

// –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—Å—ñ —Ä–∞–π–æ–Ω–∏
const districtGeometries = [];

function tryAddToMap(){
  if (loadedLayers.length === districts.length) {
    for (let [name, layer] of Object.entries(overlays)) {
      layerControl.addOverlay(layer, name);
    }
  }
}

for (const d of districts) {
  showLoading(true);
  fetch(`${d.id}.json`)
    .then(res => res.json()) 
    .then(data => {
      const layer = L.layerGroup();

      const geoJson = L.geoJSON(data, {
        onEachFeature: (feature, layerFeature) => {
          const center = layerFeature.getBounds().getCenter();

          layerFeature.on("click", async () => {
            const popup = await getTerritoryStatusPopup(d.id.replace("district",""), d.name);
            layerFeature.bindPopup(popup + `<br><button onclick="routeToDistrict('${d.name}')">üìå –ü—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç —Å—é–¥–∏</button>`).openPopup();
          });

        },
        style: { color: d.color, fillColor: d.fillColor, fillOpacity: 0.4 }
      }).addTo(layer);
      overlays[d.name] = layer;
      loadedLayers.push(d.name);
      tryAddToMap();

      // –∑–±–∏—Ä–∞—î–º–æ –≤—Å—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
      const coords = [];

      const geoms = data?.type === "Feature" ? [data.geometry] :
                      data?.type === "FeatureCollection" ? data.features.map(f => f.geometry) :
                      data?.type === "GeometryCollection" ? data.geometries :
                      [data.geometry];
      geoms?.forEach(geom => {
        if (geom?.type === "Polygon") {
          geom.coordinates[0].forEach(ringPoint => coords.push(L.latLng(ringPoint[1], ringPoint[0])));
        }
        if (geom?.type === "MultiPolygon") {
          geom.coordinates?.forEach(polygon => {
            polygon[0].forEach(ringPoint => coords.push(L.latLng(ringPoint[1], ringPoint[0])));
          });
        }
      });

      districtGeometries.push({ name: d.name, coordinates: coords });

      showLoading(false);
    })
    .catch(err => { 
      console.error(err);
      showLoading(false);
    });
}

</script>

</body>
</html>
