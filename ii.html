<!DOCTYPE html>
<html lang="uk">
<head>
<meta name="robots" content="noindex, nofollow">
<meta charset="utf-8" />
<title>–ö–∞—Ä—Ç–∞ –¢–µ—Ä–∏—Ç–æ—Ä—ñ–π "–Ü–ª–ª—ñ–Ω—Ü—ñ" –∑ Google Maps</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<style>
html,body,#map {height:100%;margin:0;padding:0;}
button.layer-toggle,button.locate-btn,button.login-btn,button.logout-btn {
  position:absolute;left:50px;z-index:1000;padding:8px 12px;background:#fff;
  border:1px solid #ccc;border-radius:4px;cursor:pointer;
}
button.locate-btn {top: 10px;}
button.layer-toggle {top: 50px;}
button.login-btn, button.logout-btn {top: 90px;}

#loader {position: absolute;top: 10px;left: 215px;z-index: 1000;padding: 8px;
  background: #fff;border: 1px solid #ccc;border-radius: 10px;}

</style>
</head>
<body>
<button onclick="findLocation()" class="locate-btn">üìç –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ</button>
<button onclick="toggleLayers()" class="layer-toggle">üó∫ –®–∞—Ä–∏</button>
<div id="auth-buttons">
<a href="enter.html"><button class="login-btn" style="display:none">üîê –£–≤—ñ–π—Ç–∏</button></a>
<button class="logout-btn" style="display:none">üö™ –í–∏–π—Ç–∏</button>
</div>

<div id="loader"></div>

<div id="map"></div>

<!-- –î–æ–¥–∞–Ω—ñ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó -->
<button id="filterFreeBtn" style="top: 130px; left: 50px;" class="filter-free">–§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è ¬´–≤—ñ–ª—å–Ω–æ¬ª </button>
<button id="filterHandBtn" style="top: 170px; left: 50px;" class="filter-onHand">–§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è ¬´–Ω–∞ —Ä—É–∫–∞—Ö¬ª </button>
<button id="toggleAllBtn" style="top: 210px; left: 50px;" class="filter-all">–ù–µ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –≤—Å—ñ / –ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ </button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = { 
  apiKey: "AIzaSyDracSUSYz_QrmmDj_HcBfQpJlJ3FjPHpU",
  authDomain: "map-illintsi.firebaseapp.com",
  projectId: "map-illintsi",
  storageBucket: "map-illintsi.appspot.com",
  messagingSenderId: "62267872375",
  appId: "1:62267872375:web:10945d2d63b93bccc5e272"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
let currentUser = null;

const loginBtn = document.querySelector('.login-btn'); 
const logoutBtn = document.querySelector('.logout-btn'); 
onAuthStateChanged(auth, user => { 
  currentUser = user; 
  if (user) { 
    loginBtn.style.display = 'none';
    logoutBtn.style.display = 'inline-block';
  } else { 
    loginBtn.style.display = 'inline-block';
    logoutBtn.style.display = 'none';
  }
}); 
logoutBtn?.addEventListener("click", async () => { 
  await signOut(auth);
  location.reload();
}); 
 
onAuthStateChanged(auth, user => { 
  currentUser = user; 
}); 
 
window.getTerritoryStatusPopup = async (number, name) => { 
  if (!currentUser) return `<b>${name}</b><br><i>–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å</i>`; 
  const q = query(collection(db, `territories/${number}/history`), orderBy("timestamp", "desc")); 
  const snap = await getDocs(q); 
  let popup = `<b>${name}</b><br>`; 
  if (snap.empty) { 
    popup += `<b>–°—Ç–∞—Ç—É—Å:</b> –≤—ñ–ª—å–Ω–æ`; 
    return popup;
  } else { 
    const data = snap.docs[0].data();
    popup += `<b>–°—Ç–∞—Ç—É—Å:</b> ${data.status}<br>`; 
    if (data.status === "–Ω–∞ —Ä—É–∫–∞—Ö") { 
      popup += `<b>–ü–Ü–ë:</b> ${data.pib}<br>`; 
      popup += `<b>–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è:</b> ${new Date(data.dateGet).toLocaleDateString("uk-UA")}`; 
    }
    return popup;
  }
};

</script>

<script>
const map = L.map('map').setView([49.1029, 29.2074], 13);
const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { 
  maxZoom: 20, 
  subdomains: ['mt0', 'mt1', 'mt2', 'mt3'], 
  attribution:'¬© Google Maps'
}).addTo(map);
const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { 
  attribution:'¬© Esri', maxZoom: 20 
});

// –ó–∞—Ä–∞–∑ –≤—Å—ñ 150 –±—É–¥—É—Ç—å –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ —Ü–∏–∫–ª–æ–º –∑ –≤–∏–ø–∞–¥–∫–æ–≤–∏–º–∏ –∫–æ–ª—å–æ—Ä–∞–º–∏
const districts = [];

for (let i = 1; i <= 150; i++) {
  districts.push({ 
    id: `district${i}`,
    name: `–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è ${i}`,
    color: '#' + Math.floor(Math.random() * 16777215).toString(16),
    fillColor: '#' + Math.floor(Math.random() * 16777215).toString(16)
  });
}

const districtCenters = []; 
const districtGeometries = []; 
const overlayMaps = {};

function toggleLayers() { 
  const control = document.querySelector('.leaflet-control-layers'); 
  if (control) control.classList.toggle('leaflet-control-layers-expanded'); 
  const btn = document.querySelector('.layer-toggle'); 
  btn.innerText = control.classList.contains('leaflet-control-layers-expanded') ? 'üó∫ –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —à–∞—Ä–∏' : 'üó∫ –®–∞—Ä–∏';
}

function showLoading(show) { 
  document.getElementById('loader').innerText = show ? '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...' : '';
}

const loadedLayers = [];

function tryAddLayersControl() { 
  if (loadedLayers.length === districts.length) { 
    L.control.layers( 
      { "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –∫–∞—Ä—Ç–∞": googleStreets, "–°—É–ø—É—Ç–Ω–∏–∫–æ–≤–∞ –∫–∞—Ä—Ç–∞": satellite },
      overlayMaps,
      { collapsed: true }
    ).addTo(map);
  }
}

districts.forEach(d => { 
  const layer = L.layerGroup();
  showLoading(true);
  fetch(`${d.id}.json`) 
    .then(res => res.json()) 
    .then(data => { 
      const geoJsonLayer = L.geoJSON(data, { 
        onEachFeature: (feature, layer) => { 
          const center = layer.getBounds().getCenter();
          districtCenters.push({ name: feature.properties?.name || d.name, latlng: center }); 
          layer.on("click", async () => { 
            const popupContent = await window.getTerritoryStatusPopup(d.id.replace("district", ""), d.name);
            layer.bindPopup(popupContent + `<br><button onclick="routeToDistrict('${d.name}')">üìå –ü—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç —Å—é–¥–∏</button>`).openPopup();

            // –¢—É—Ç –º–æ–∂–Ω–∞ –∑–±–µ—Ä–µ–≥—Ç–∏ —Å—Ç–∞—Ç—É—Å –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó
            d.status = popupContent.indexOf('–≤—ñ–ª—å–Ω–æ') !== -1 ? '–≤—ñ–ª—å–Ω–æ'
                      : popupContent.indexOf('–Ω–∞ —Ä—É–∫–∞—Ö') !== -1 ? '–Ω–∞ —Ä—É–∫–∞—Ö'
                      : '';
          }); 
        },
        style: { color: d.color, fillColor: d.fillColor, fillOpacity: 0.4 }
      }).addTo(layer);
      overlayMaps[d.name] = layer;
      loadedLayers.push(d.name);
      tryAddLayersControl();

      // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
      const coords = []; 
      const geometries = data.type === "GeometryCollection" ? data.geometries : [data.geometry]; 
      geometries.forEach(geom => { 
        const coords = geom.coordinates; 
        const pushCoords = ring => ring.forEach(c => coordsArray.push(L.latLng(c[1], c[0]))); 
        // (–ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Ç—É—Ç, –∞–ª–µ –º–æ–∂–ª–∏–≤–æ –∑–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –¥–ª—è —ñ–Ω—à–æ–≥–æ) 
      }); 
 
      showLoading(false);
    })
    .catch(err => { 
      console.log(err);
      showLoading(false);
    });
});

// –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è
function highlightStatus(status) {
  for (let d of districts) {
    if (overlayMaps[d.name]) {
      if (d.status === status) {
        map.addLayer(overlayMaps[d.name]);
      } else {
        map.removeLayer(overlayMaps[d.name]);
      }
    }
  }
}

document.getElementById('filterFreeBtn')?.addEventListener('click', () => highlightStatus('–≤—ñ–ª—å–Ω–æ'));

document.getElementById('filterHandBtn')?.addEventListener('click', () => highlightStatus('–Ω–∞ —Ä—É–∫–∞—Ö'));

document.getElementById('toggleAllBtn')?.addEventListener('click', () => {
  for (let d of districts) {
    if (map.hasLayer(overlayMaps[d.name])) {
      map.removeLayer(overlayMaps[d.name]);
    } else {
      map.addLayer(overlayMaps[d.name]);
    }
  }
});

// ‚Ä¶ —ñ–Ω—à–∞ –ª–æ–≥—ñ–∫–∞ (geolocation, routeToDistrict) –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω

</script>
</body>
</html>
