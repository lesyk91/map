<!DOCTYPE html>
<html lang="uk">
<head>
  <meta name="robots" content="noindex, nofollow">
  <meta charset="utf-8" />
  <title>–ö–∞—Ä—Ç–∞ –¢–µ—Ä–∏—Ç–æ—Ä—ñ–π "–Ü–ª–ª—ñ–Ω—Ü—ñ"</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    html, body, #map {
      height: 100%; margin: 0; padding: 0;
    }
    button.layer-toggle, button.locate-btn, button.login-btn, button.logout-btn, button.territories-btn {
      position: absolute;
      left: 10px;
      z-index: 1000;
      padding: 5px 15px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }
    button.locate-btn { top: 10px; }
    button.layer-toggle { top: 50px; }
    button.login-btn, button.logout-btn { top: 46px; }
    button.territories-btn { top: 200px; }
    #taken-control, #free-control {
      margin: 5px 0;
    }
    .controls {
      position: absolute;
      top: 90px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .controls label { margin-left: 5px; cursor: pointer; }
    .controls input[type="checkbox"] { margin: 5px 0; }
    #loader {
      position: absolute;
      top: 10px;
      left: 215px;
      z-index: 1000;
      padding: 8px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    /* Progress Overlay */
    #progress-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    #progress-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      width: 80%;
      max-width: 300px;
    }
    #progress-bar { width: 100%; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; }
    #progress-fill { height: 100%; background: #4caf50; width: 0; transition: width 0.3s ease; }
    @media (max-width: 640px) {
      button.layer-toggle, button.locate-btn, button.login-btn, button.logout-btn, button.territories-btn {
        left: 10px; padding: 5px 10px; font-size: 14px;
      }
      .controls { left: 10px; top: 80px; padding: 6px; width: 160px; }
      #loader { left: 180px; padding: 6px; }
      button.territories-btn { top: 195px; }
    }
  </style>
</head>
<body>
  <div id="progress-overlay" class="flex">
    <div id="progress-container" class="bg-white p-5 rounded-lg shadow-lg">
      <h2 class="text-lg font-semibold mb-2">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–µ—Ä–∏—Ç–æ—Ä—ñ–π...</h2>
      <div id="progress-bar"><div id="progress-fill"></div></div>
      <p id="progress-text" class="mt-2 text-sm">0%</p>
    </div>
  </div>

  <button onclick="findLocation()" class="locate-btn bg-white border border-gray-300 rounded shadow-sm px-3 py-2 text-sm sm:text-base hover:bg-gray-100">üìç –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ</button>
  <div id="auth-buttons">
    <a href="enter.html"><button class="login-btn bg-white border border-gray-300 rounded shadow-sm px-3 py-2 text-sm sm:text-base hover:bg-gray-100" style="display:none">üîê –£–≤—ñ–π—Ç–∏</button></a>
    <button class="logout-btn bg-white border border-gray-300 rounded shadow-sm px-3 py-2 text-sm sm:text-base hover:bg-gray-100" style="display:none">üö™ –í–∏–π—Ç–∏</button>
    <a href="territories.html"><button class="territories-btn bg-white border border-gray-300 rounded shadow-sm px-3 py-2 text-sm sm:text-base hover:bg-gray-100" style="display:none">üèû –¢–µ—Ä–∏—Ç–æ—Ä—ñ—ó</button></a>
  </div>

  <div id="loader" class="bg-white border border-gray-300 rounded shadow-sm"></div>

  <div class="controls bg-white border border-gray-300 rounded shadow-sm p-2 sm:p-3">
    <input type="checkbox" id="toggleAll" checked>
    <label for="toggleAll" id="toggleAllLabel" class="text-sm sm:text-base">–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ</label><br>
    <div id="taken-control" style="display: none">
      <input type="checkbox" id="showTaken">
      <label for="showTaken" class="text-sm sm:text-base">–ù–∞ —Ä—É–∫–∞—Ö</label><br>
    </div>
    <div id="free-control" style="display: none">
      <input type="checkbox" id="showFree">
      <label for="showFree" class="text-sm sm:text-base">–í—ñ–ª—å–Ω–æ</label>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>

  <script type="module">
    // Firebase –º–æ–¥—É–ª—ñ (—è–∫ —ñ —Ä–∞–Ω—ñ—à–µ)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDracSUSYz_QrmmDj_HcBfQpJlJ3FjPHpU",
      authDomain: "map-illintsi.firebaseapp.com",
      projectId: "map-illintsi",
      storageBucket: "map-illintsi.appspot.com",
      messagingSenderId: "62267872375",
      appId: "1:62267872375:web:10945d2d63b93bccc5e272"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;

    // DOM refs
    const loginBtn = document.querySelector('.login-btn');
    const logoutBtn = document.querySelector('.logout-btn');
    const territoriesBtn = document.querySelector('.territories-btn');
    const takenControl = document.getElementById('taken-control');
    const freeControl = document.getElementById('free-control');

    // Map
    const map = L.map('map', { zoomControl: false }).setView([49.1029, 29.2074], 13);

    const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
      maxZoom: 20, subdomains: ['mt0','mt1','mt2','mt3'], attribution: '¬© Google Maps'
    }).addTo(map);

    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '¬© Esri', maxZoom: 20
    });

    // districts list (–≤–∞—à)
    const districts = [ /* ~~~ –¢–£–¢ –í–ê–® –°–ü–ò–°–û–ö district1..district102 (–∑–±–µ—Ä–µ–∂–µ–Ω–æ —è–∫ —É –≤–∞—Å) ~~~ */ 
      { id: 'district1', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 1', color: 'blue', fillColor: '#add8e6' },
      { id: 'district2', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 2', color: 'green', fillColor: '#90ee90' },
      /* ... —Å–∫–æ—Ä–æ—á–µ–Ω–æ –¥–ª—è —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ, —É –≤–∞—à–æ–º—É —Ñ–∞–π–ª—ñ –∑–∞–ª–∏—à—Ç–µ –≤–µ—Å—å —Å–ø–∏—Å–æ–∫ ... */
      { id: 'district102', name: '–¢–µ—Ä–∏—Ç–æ—Ä—ñ—è 102', color: 'green', fillColor: '#90ee90' }
    ];

    // –†–æ–±–æ—á—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏
    const districtCenters = [];
    const districtGeometries = []; // {id, name, coordinates[]}
    const overlayMaps = {}; // name -> layerGroup
    const territoryStatuses = {}; // districtId -> "–≤—ñ–ª—å–Ω–æ"|"–Ω–∞ —Ä—É–∫–∞—Ö"
    let layersControl = null;
    const loadedLayers = []; // {id, name, layerGroup, geoJsonLayer}

    // –¥–ª—è –ª–æ–≥—ñ–∫–∏ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä ?territory=
    const urlParams = new URLSearchParams(window.location.search);
    let rawTarget = urlParams.get("territory"); // –º–æ–∂–µ –±—É—Ç–∏ "district5" –∞–±–æ "5"
    let targetId = null; // —É —Ñ–æ—Ä–º–∞—Ç—ñ 'district5'
    if (rawTarget) {
      if (rawTarget.startsWith('district')) targetId = rawTarget;
      else targetId = `district${rawTarget}`;
      // –¥–æ–¥–∞—Ç–∫–æ–≤–æ, —É –≤–∏–ø–∞–¥–∫—É –∫–æ–ª–∏ user –ø–µ—Ä–µ–¥–∞–≤ –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ '5', —Ç–∞–∫–æ–∂ –≤ targetId
    }

    // –ù–û–†–ú–ê–õ–Ü–ó–ê–¶–Ü–Ø districts (sort)
    districts.sort((a,b) => {
      const na = parseInt(a.id.replace('district',''),10);
      const nb = parseInt(b.id.replace('district',''),10);
      return na - nb;
    });

    // UI helper
    function showLoadingText(txt){ document.getElementById('loader').innerText = txt || ''; }
    function updateProgress(percentage){
      const progressOverlay = document.getElementById('progress-overlay');
      const progressFill = document.getElementById('progress-fill');
      const progressText = document.getElementById('progress-text');
      if (percentage < 100) {
        progressOverlay.style.display = 'flex';
        progressFill.style.width = `${percentage}%`;
        progressText.innerText = `${Math.round(percentage)}%`;
      } else {
        progressOverlay.style.display = 'none';
        progressFill.style.width = `100%`;
        progressText.innerText = `100%`;
      }
    }

    // –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Ø
    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (user) {
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        territoriesBtn.style.display = 'inline-block';
        takenControl.style.display = 'block';
        freeControl.style.display = 'block';
        updateTerritoryStatuses(); // –ø–æ—á–∏–Ω–∞—î–º–æ —Å–ª—ñ–¥–∫—É–≤–∞—Ç–∏
      } else {
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        territoriesBtn.style.display = 'none';
        takenControl.style.display = 'block';
        freeControl.style.display = 'block';
        // —è–∫—â–æ –≤–∏–π—à–ª–∏ ‚Äî –≤—Å—ñ —Å—Ç–∞—Ç—É—Å–∏ "–≤—ñ–ª—å–Ω–æ" –ª–æ–∫–∞–ª—å–Ω–æ
        Object.keys(territoryStatuses).forEach(id => territoryStatuses[id] = "–≤—ñ–ª—å–Ω–æ");
        updateTerritoriesDisplay();
      }
    });

    logoutBtn?.addEventListener("click", async () => { await signOut(auth); layersControl = null; location.reload(); });

    // –û—Ç—Ä–∏–º–∞—Ç–∏ popup –∫–æ–Ω—Ç–µ–Ω—Ç –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º
    async function getTerritoryStatusPopup(number, name){
      try {
        const q = query(collection(db, `territories/${number}/history`), orderBy("timestamp","desc"));
        const snap = await getDocs(q);
        let popup = `<b>${name}</b><br>`;
        if (snap.empty) {
          popup += `<b>–°—Ç–∞—Ç—É—Å:</b> –≤—ñ–ª—å–Ω–æ`;
        } else {
          const latest = snap.docs[0].data();
          const status = latest.status === "–Ω–∞ —Ä—É–∫–∞—Ö" ? "–Ω–∞ —Ä—É–∫–∞—Ö" : "–≤—ñ–ª—å–Ω–æ";
          popup += `<b>–°—Ç–∞—Ç—É—Å:</b> ${status}`;
          if (currentUser && status === "–Ω–∞ —Ä—É–∫–∞—Ö") {
            popup += `<br><b>–ü–Ü–ë:</b> ${latest.pib || "–Ω–µ–≤—ñ–¥–æ–º–æ"}`;
            popup += `<br><b>–î–∞—Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è:</b> ${latest.dateGet ? new Date(latest.dateGet).toLocaleDateString("uk-UA") : "–Ω–µ–≤—ñ–¥–æ–º–æ"}`;
          }
        }
        // –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—å —ñ —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ (—è–∫ —É –≤–∞—Å)
        popup += `<br><button onclick="shareTerritory('${number}')" style="background-color: green; color: white;">üîó –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è</button>`;
        if (currentUser) {
          popup += `<br><a href="territory-detail.html?number=${number}"><button style="background-color: orange; color: white;">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button></a>`;
        }
        return popup;
      } catch(err) {
        console.warn('getTerritoryStatusPopup error', err);
        return `<b>${name}</b><br><b>–°—Ç–∞—Ç—É—Å:</b> –Ω–µ–≤—ñ–¥–æ–º–∏–π`;
      }
    }

    // –°–ª—É—Ö–∞—î–º–æ —Å—Ç–∞—Ç—É—Å–∏ –≤—Å—ñ—Ö —Ç–µ—Ä–∏—Ç–æ—Ä—ñ–π —É Firestore –æ–¥–Ω–æ—á–∞—Å–Ω–æ (–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ)
    function updateTerritoryStatuses(){
      districts.forEach(d => {
        try {
          const idNum = d.id.replace('district','');
          const q = query(collection(db, `territories/${idNum}/history`), orderBy("timestamp","desc"));
          onSnapshot(q, snap => {
            if (!snap || snap.empty) territoryStatuses[d.id] = "–≤—ñ–ª—å–Ω–æ";
            else {
              const latest = snap.docs[0].data();
              territoryStatuses[d.id] = latest.status === "–Ω–∞ —Ä—É–∫–∞—Ö" ? "–Ω–∞ —Ä—É–∫–∞—Ö" : "–≤—ñ–ª—å–Ω–æ";
            }
            updateTerritoriesDisplay();
          }, err => {
            console.warn(`–ü–æ–º–∏–ª–∫–∞ onSnapshot –¥–ª—è ${d.id}:`, err);
            territoryStatuses[d.id] = "–≤—ñ–ª—å–Ω–æ";
            updateTerritoriesDisplay();
          });
        } catch(e) {
          console.warn('updateTerritoryStatuses catch', e);
        }
      });
    }

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è all_districts.json —ñ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —à–∞—Ä—ñ–≤
    (async () => {
      showLoadingText('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–µ—Ä–∏—Ç–æ—Ä—ñ–π...');
      updateProgress(0);
      let loadedCount = 0;
      const totalDistricts = districts.length;

      try {
        const res = await fetch('all_districts.json');
        if (!res.ok) throw new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ all_districts.json: ${res.status}`);
        const data = await res.json();

        data.features.forEach((feature) => {
          const d = districts.find(x => x.id === feature.id);
          if (!d) {
            console.warn(`–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –æ–ø–∏—Å—É –¥–ª—è feature.id=${feature.id}`); 
            loadedCount++;
            updateProgress((loadedCount/totalDistricts)*100);
            return;
          }

          // –°—Ç–≤–æ—Ä—é—î–º–æ layerGroup –¥–ª—è –∫–æ–∂–Ω–æ—ó —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—ó (—â–æ–± –º–æ–∂–Ω–∞ –±—É–ª–æ –ª–µ–≥–∫–æ –≤–º–∏–∫–∞—Ç–∏/–≤–∏–º–∏–∫–∞—Ç–∏)
          const layerGroup = L.layerGroup();
          // geoJson –¥–æ–¥–∞—î–º–æ –≤ –æ–∫—Ä–µ–º–∏–π –æ–±'—î–∫—Ç, –∞–ª–µ –¥–æ–¥–∞—î–º–æ –¥–æ layerGroup
          const geoJsonLayer = L.geoJSON(feature, {
            style: { color: d.color, fillColor: d.fillColor, fillOpacity: 0.4 },
            onEachFeature: (feat, lyr) => {
              const center = lyr.getBounds().getCenter();
              districtCenters.push({ id: d.id, name: feat.properties?.name || d.name, latlng: center });
              // –∫–ª—ñ–∫ –Ω–∞ –ø–æ–ª—ñ–≥–æ–Ω
              lyr.on('click', async () => {
                const idNum = d.id.replace('district','');
                const popupContent = await getTerritoryStatusPopup(idNum, d.name);
                lyr.bindPopup(popupContent + `<br><button style="background-color: blue; color: white;" onclick="routeToDistrict('${d.name}')">üìå –ü—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç —Å—é–¥–∏</button>`).openPopup();
              });
            }
          });

          // –¥–æ–¥–∞—î–º–æ geoJsonLayer –≤ layerGroup —Ç–∞ –≤ map (–∑–∞ —É–º–æ–≤–æ—é –Ω–∏–∂—á–µ)
          geoJsonLayer.addTo(layerGroup);

          // –∑–∞–ø–∞–º'—è—Ç–æ–≤—É—î–º–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–∑—Ä—É—á–Ω—ñ—à–µ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—É)
          loadedLayers.push({ id: d.id, name: d.name, layerGroup, geoJsonLayer });
          overlayMaps[d.name] = layerGroup;
          territoryStatuses[d.id] = "–≤—ñ–ª—å–Ω–æ"; // –∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º

          // –Ø–∫—â–æ targetId –≤—ñ–¥—Å—É—Ç–Ω—ñ–π ‚Äî –¥–æ–¥–∞—î–º–æ –≤—Å—ñ —à–∞—Ä–∏. –Ø–∫—â–æ targetId –∑–∞–¥–∞–Ω–∏–π, –¥–æ–¥–∞—î–º–æ –ª–∏—à–µ –ø–æ—Ç—Ä—ñ–±–Ω–∏–π.
          if (!targetId) {
            map.addLayer(layerGroup);
          } else {
            if (d.id === targetId) {
              map.addLayer(layerGroup);
              // –ø—ñ–¥–≥–∞–Ω—è—î–º–æ bounds —ñ –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –ø–æ–ø–∞–ø –¥–ª—è —Ü—ñ—î—ó —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—ó
              const bounds = geoJsonLayer.getBounds();
              if (bounds && bounds.isValid && bounds.isValid()) map.fitBounds(bounds.pad(0.15));
              // –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–ø–∞–ø –∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é
              (async () => {
                const idNum = d.id.replace('district','');
                const popupContent = await getTerritoryStatusPopup(idNum, d.name);
                geoJsonLayer.eachLayer(sub => sub.bindPopup(popupContent + `<br><button style="background-color: blue; color: white;" onclick="routeToDistrict('${d.name}')">üìå –ü—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç —Å—é–¥–∏</button>`).openPopup());
              })();
            } else {
              // —è–≤–Ω–æ –Ω–µ –¥–æ–¥–∞—î–º–æ —ñ–Ω—à—ñ —à–∞—Ä–∏
            }
          }

          // –≤–∏—Ç—è–≥–∞—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç—É (—Å–ø–∏—Å–æ–∫ —Ç–æ—á–æ–∫ –ø–æ –º–µ–∂—ñ)
          const coordinates = [];
          const geometries = feature.geometry.type === "GeometryCollection" ? feature.geometry.geometries : [feature.geometry];
          geometries.forEach(geom => {
            const coords = geom.coordinates;
            const pushCoords = ring => ring.forEach(c => coordinates.push(L.latLng(c[1], c[0])));
            if (geom.type === "Polygon") coords.forEach(pushCoords);
            if (geom.type === "MultiPolygon") coords.forEach(polygon => polygon.forEach(pushCoords));
          });
          districtGeometries.push({ id: d.id, name: d.name, coordinates });

          loadedCount++;
          updateProgress((loadedCount / totalDistricts) * 100);
        });
      } catch(err) {
        console.warn('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ all_districts.json:', err);
      }

      showLoadingText('');
      // –ó–∞–≤–∂–¥–∏ –¥–æ–¥–∞—î–º–æ –∫–æ–Ω—Ç—Ä–æ–ª —à–∞—Ä—ñ–≤ (—â–æ–± –±–∞—á–∏—Ç–∏ –±–∞–∑–æ–≤—ñ –∫–∞—Ä—Ç–∏ —Ç–∞ —Å–ø–∏—Å–æ–∫ —Ç–µ—Ä–∏—Ç–æ—Ä—ñ–π)
      tryAddLayersControl();

      // –Ø–∫—â–æ –ø–∞—Ä–∞–º–µ—Ç—Ä targetId —î, –ø–æ—Ç—Ä—ñ–±–Ω–æ —â–µ –æ–Ω–æ–≤–∏—Ç–∏ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–±–æ —á–µ–∫–±–æ–∫—Å–∏ —Ç–æ—â–æ)
      updateTerritoriesDisplay();
      // –Ø–∫—â–æ –ù–ï –±—É–ª–æ targetId ‚Äî –ø–æ—á–∏–Ω–∞—î–º–æ –ø—ñ–¥–ø–∏—Å–∫–∏ –Ω–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—ñ–≤
      if (!targetId) updateTerritoryStatuses();
    })();

    // –ù–∞–≤—ñ–≥–∞—Ü—ñ—è / –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—è
    let currentMarker = null, currentCircle = null, routeControl = null, currentLocation = null;
    function findLocation() {
      if (!navigator.geolocation) { alert('‚ö† –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é.'); return; }
      showLoadingText('–í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è...');
      navigator.geolocation.getCurrentPosition(position => {
        const latlng = L.latLng(position.coords.latitude, position.coords.longitude);
        currentLocation = latlng;
        showLoadingText('');
        if (currentMarker) map.removeLayer(currentMarker);
        if (currentCircle) map.removeLayer(currentCircle);
        currentCircle = L.circle(latlng, { radius: position.coords.accuracy, color:'blue', fillColor:'#30f', fillOpacity:0.2 }).addTo(map);
        currentMarker = L.marker(latlng).addTo(map).bindPopup(`–í–∞—à–µ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è (—Ç–æ—á–Ω—ñ—Å—Ç—å ${Math.round(position.coords.accuracy)} –º)`).openPopup();
        map.setView(latlng, 16);
      }, error => {
        showLoadingText('');
        console.error("Geolocation error:", error.message);
        alert(`‚ö† –ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è: ${error.message}`);
      }, { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 });
    }

    function routeToDistrict(districtName) {
      if (!currentLocation) { alert("‚õî –°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å üìç ¬´–ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ¬ª"); return; }
      const district = districtGeometries.find(d => d.name === districtName);
      if (!district || !district.coordinates.length) { alert(`‚ö† –ù–µ–º–∞—î –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è ${districtName}`); return; }
      let nearestPoint = district.coordinates.reduce((nearest, coord) => {
        const distance = currentLocation.distanceTo(coord);
        return distance < currentLocation.distanceTo(nearest) ? coord : nearest;
      }, district.coordinates[0]);
      if (routeControl) map.removeControl(routeControl);
      routeControl = L.Routing.control({
        waypoints: [currentLocation, nearestPoint],
        routeWhileDragging: false,
        addWaypoints: false,
        show: true,
        createMarker: () => null,
        router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' })
      }).on('routesfound', function(e) {
        const dist = e.routes[0].summary.totalDistance;
        const distText = dist > 1000 ? (dist/1000).toFixed(2) + " –∫–º" : Math.round(dist) + " –º";
        currentMarker?.bindPopup(`–í–∞—à–µ –º—ñ—Å—Ü–µ—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è<br>–ú–∞—Ä—à—Ä—É—Ç –¥–æ <b>${districtName}</b><br>–í—ñ–¥—Å—Ç–∞–Ω—å: ${distText}`).openPopup();
      }).on('routingerror', function(e) {
        console.error("Routing error:", e.error);
        alert(`‚ö† –ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ–∫–ª–∞—Å—Ç–∏ –º–∞—Ä—à—Ä—É—Ç: ${e.error?.message || '–ø–æ–º–∏–ª–∫–∞'}`);
      }).addTo(map);
    }

    // export –¥–ª—è popup-–∫–Ω–æ–ø–æ–∫
    window.findLocation = findLocation;
    window.routeToDistrict = routeToDistrict;

    // –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—î—é ‚Äî –ø—Ä–∏–π–º–∞—î number (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ '5') –∞–±–æ —Ä—è–¥–æ–∫-—á–∏—Å–ª–æ
    window.shareTerritory = function(number) {
      // number –º–æ–∂–µ –±—É—Ç–∏ '5' (–≤–∏ –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∏ d.id.replace('district',''))
      const url = `${window.location.origin}${window.location.pathname}?territory=${number}`;
      const title = `–ö–∞—Ä—Ç–∞: –¢–µ—Ä–∏—Ç–æ—Ä—ñ—è ‚Ññ${number}`;
      if (navigator.share) {
        navigator.share({ title, text: `–ü–µ—Ä–µ–≥–ª—è–Ω—å —Ü—é —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—é: ‚Ññ${number}`, url }).catch(err => {
          console.warn('share failed', err);
          try { navigator.clipboard.writeText(url); alert('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä'); } catch(e){ prompt('–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—é:', url); }
        });
      } else {
        try {
          navigator.clipboard.writeText(url);
          alert('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É');
        } catch(e) {
          prompt('–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—é:', url);
        }
      }
    };

    // –§—ñ–ª—å—Ç—Ä—É–≤–∞–Ω–Ω—è / –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —à–∞—Ä—ñ–≤
    function updateTerritoriesDisplay() {
      const toggleAllCheckbox = document.getElementById('toggleAll');
      const showTakenCheckbox = document.getElementById('showTaken');
      const showFreeCheckbox = document.getElementById('showFree');

      const toggleAll = toggleAllCheckbox?.checked ?? true;
      const showTaken = showTakenCheckbox?.checked ?? false;
      const showFree = showFreeCheckbox?.checked ?? false;

      // –Ø–∫—â–æ —î –ø–∞—Ä–∞–º–µ—Ç—Ä targetId (highlight) => –ø–æ–∫–∞–∑—É—î–º–æ –ª–∏—à–µ –π–æ–≥–æ (–Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —á–µ–∫–±–æ–∫—Å—ñ–≤),
      // –∞–ª–µ –¥–∞—î–º–æ –∑–º–æ–≥—É —Å–∫–∏–Ω—É—Ç–∏ highlight, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–µ—Ä–µ–º–∏–∫–∞—î —á–µ–∫–±–æ–∫—Å–∏ (–º–æ–∂–Ω–∞ —Ä–æ–∑—à–∏—Ä–∏—Ç–∏)
      if (targetId) {
        loadedLayers.forEach(item => {
          if (item.id === targetId) {
            if (!map.hasLayer(item.layerGroup)) map.addLayer(item.layerGroup);
          } else {
            if (map.hasLayer(item.layerGroup)) map.removeLayer(item.layerGroup);
          }
        });
        return;
      }

      // –Ü–Ω—à–∏–π —Ä–µ–∂–∏–º: –ø–æ–∫–∞–∑ –∑–∞ —á–µ–∫–±–æ–∫—Å–∞–º–∏
      loadedLayers.forEach(({ id, layerGroup }) => {
        const status = territoryStatuses[id] || "–≤—ñ–ª—å–Ω–æ";
        if (toggleAll) {
          if (!map.hasLayer(layerGroup)) map.addLayer(layerGroup);
        } else if (showTaken || showFree) {
          const shouldShow = (showFree && status === "–≤—ñ–ª—å–Ω–æ") || (showTaken && status === "–Ω–∞ —Ä—É–∫–∞—Ö");
          if (shouldShow) {
            if (!map.hasLayer(layerGroup)) map.addLayer(layerGroup);
          } else {
            if (map.hasLayer(layerGroup)) map.removeLayer(layerGroup);
          }
        } else {
          if (map.hasLayer(layerGroup)) map.removeLayer(layerGroup);
        }
      });
    }

    // –î–æ–¥–∞—î–º–æ –∫–æ–Ω—Ç—Ä–æ–ª —à–∞—Ä—ñ–≤ (–±–∞–∑–æ–≤—ñ + overlayMaps)
    function tryAddLayersControl(){
      if (layersControl) return;
      const sortedOverlayMaps = {};
      loadedLayers.forEach(({ name, layerGroup }) => { sortedOverlayMaps[name] = layerGroup; });

      layersControl = L.control.layers({ "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –∫–∞—Ä—Ç–∞": googleStreets, "–°—É–ø—É—Ç–Ω–∏–∫–æ–≤–∞ –∫–∞—Ä—Ç–∞": satellite }, sortedOverlayMaps, { collapsed: true }).addTo(map);

      // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —á–µ–∫–±–æ–∫—Å—ñ–≤ —ñ –ø–æ–¥—ñ–π
      const toggleAllCheckbox = document.getElementById('toggleAll');
      const toggleAllLabel = document.getElementById('toggleAllLabel');
      const showTakenCheckbox = document.getElementById('showTaken');
      const showFreeCheckbox = document.getElementById('showFree');

      // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
      toggleAllCheckbox.checked = !targetId;
      if (showTakenCheckbox) showTakenCheckbox.checked = false;
      if (showFreeCheckbox) showFreeCheckbox.checked = false;
      toggleAllLabel.innerText = '–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ—Ö';

      toggleAllCheckbox.addEventListener('change', () => {
        if (toggleAllCheckbox.checked) {
          if (showTakenCheckbox) showTakenCheckbox.checked = false;
          if (showFreeCheckbox) showFreeCheckbox.checked = false;
          toggleAllLabel.innerText = '–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ—Ö';
        } else {
          toggleAllLabel.innerText = '–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ—Ö';
        }
        // —è–∫—â–æ –±—É–≤ highlight (targetId) ‚Äî –∑–Ω—ñ–º–∞—î–º–æ –π–æ–≥–æ –ø—Ä–∏ –∑–º—ñ–Ω—ñ —á–µ–∫–±–æ–∫—Å—ñ–≤
        if (targetId) targetId = null;
        updateTerritoriesDisplay();
      });

      if (showTakenCheckbox) {
        showTakenCheckbox.addEventListener('change', () => {
          if (showTakenCheckbox.checked) { toggleAllCheckbox.checked = false; toggleAllLabel.innerText = '–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ—Ö'; }
          if (targetId) targetId = null;
          updateTerritoriesDisplay();
        });
      }

      if (showFreeCheckbox) {
        showFreeCheckbox.addEventListener('change', () => {
          if (showFreeCheckbox.checked) { toggleAllCheckbox.checked = false; toggleAllLabel.innerText = '–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ—Ö'; }
          if (targetId) targetId = null;
          updateTerritoriesDisplay();
        });
      }

      updateTerritoriesDisplay();
    }

  </script>
</body>
</html>
